<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TartilAI — Belajar & Latihan Al-Qur'an</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ═══════════════════════════════════════════════
   BOTTOM NAV + SPA SHELL
   ═══════════════════════════════════════════════ */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%;
  overflow: hidden;
  background: #0D2B2B;
  font-family: 'Poppins', sans-serif;
}
#spa-root {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh;
}
#spa-body {
  flex: 1;
  min-height: 0;
  overflow: hidden;
  position: relative;
}
.spa-tab {
  position: absolute;
  inset: 0;
  overflow-y: auto;
  overflow-x: hidden;
  display: none;
  -webkit-overflow-scrolling: touch;
}
.spa-tab.active { display: block; }

/* ── Bottom Navigation ── */
#bottom-nav {
  display: flex;
  background: rgba(8,22,22,0.97);
  border-top: 1px solid rgba(201,162,39,0.2);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom, 0px);
  flex-shrink: 0;
}
.bnav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px 4px 6px;
  cursor: pointer;
  border: none;
  background: none;
  color: rgba(253,246,232,0.35);
  transition: all 0.2s;
  gap: 3px;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.bnav-btn.active {
  color: #C9A227;
}
.bnav-btn.active::before {
  content: '';
  position: absolute;
  top: 0; left: 20%; right: 20%;
  height: 2px;
  background: #C9A227;
  border-radius: 0 0 3px 3px;
}
.bnav-icon { font-size: 20px; line-height: 1; }
.bnav-label { font-size: 10px; font-weight: 500; letter-spacing: 0.3px; }

/* ── Shalat bar stays on top ── */
#shalatBar {
  position: sticky !important;
  top: 0;
  z-index: 50;
}

/* ═══════════════════════════════════════════════
   TARTIL CSS (original)
   ═══════════════════════════════════════════════ */

  :root {
    --gold: #C9A227;
    --gold-light: #E8C547;
    --gold-dark: #8B6F15;
    --teal: #1A5C5C;
    --teal-light: #2A8A8A;
    --teal-dark: #0D3B3B;
    --cream: #FDF8EE;
    --cream-dark: #F0E8D0;
    --ink: #1A1408;
    --text-muted: #6B5B3E;
    --error: #C0392B;
    --success: #27AE60;
    --warning: #E67E22;
    --shadow: rgba(26,20,8,0.15);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Poppins', sans-serif;
    background: var(--teal-dark);
    color: var(--ink);
    min-height: 100vh;
    direction: ltr;
  }

  /* ===== BACKGROUND ===== */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 20% 0%, rgba(201,162,39,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(42,138,138,0.2) 0%, transparent 50%),
      linear-gradient(135deg, #0D2B2B 0%, #1A4040 40%, #0D2B2B 100%);
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23C9A227' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.5;
    z-index: 0;
  }

  /* ===== LAYOUT ===== */
  .app {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 280px 1fr;
    grid-template-rows: 70px 1fr;
    height: 100vh;
    overflow: hidden;
  }

  /* ===== HEADER ===== */
  header {
    grid-column: 1 / -1;
    background: linear-gradient(90deg, var(--teal-dark) 0%, rgba(13,35,35,0.95) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(201,162,39,0.3);
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .logo-icon {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Amiri', serif;
    font-size: 22px;
    color: white;
    box-shadow: 0 4px 15px rgba(201,162,39,0.4);
  }

  .logo-text {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    font-size: 20px;
    color: var(--cream);
    letter-spacing: -0.5px;
  }

  .logo-text span {
    color: var(--gold);
  }

  .header-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Nav buttons in header */
  .hdr-nav-btn {
    display: flex; align-items: center; gap: 5px;
    text-decoration: none; padding: 5px 10px;
    border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);
    color: rgba(253,248,238,0.5); font-size: 12px;
    transition: all .2s; white-space: nowrap;
  }
  .hdr-nav-btn:hover { border-color: rgba(255,255,255,0.25); color: rgba(253,248,238,0.85); }
  .hdr-icon-btn { margin-right: 6px; }

  .user-score-badge {
    background: rgba(201,162,39,0.15);
    border: 1px solid rgba(201,162,39,0.4);
    border-radius: 20px;
    padding: 6px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--gold-light);
    font-size: 14px;
    font-weight: 600;
  }

  .lang-badge {
    background: rgba(42,138,138,0.2);
    border: 1px solid rgba(42,138,138,0.4);
    border-radius: 20px;
    padding: 4px 12px;
    color: var(--teal-light);
    font-size: 12px;
    cursor: pointer;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    background: rgba(13,35,35,0.7);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(201,162,39,0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid rgba(201,162,39,0.15);
  }

  .search-box {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(201,162,39,0.25);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--cream);
    font-size: 13px;
    font-family: 'Poppins', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box::placeholder { color: rgba(253,248,238,0.4); }
  .search-box:focus { border-color: var(--gold); }

  .surah-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .surah-list::-webkit-scrollbar { width: 4px; }
  .surah-list::-webkit-scrollbar-track { background: transparent; }
  .surah-list::-webkit-scrollbar-thumb { background: rgba(201,162,39,0.3); border-radius: 2px; }

  .surah-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    margin-bottom: 2px;
  }

  .surah-item:hover {
    background: rgba(201,162,39,0.08);
    border-color: rgba(201,162,39,0.2);
  }

  .surah-item.active {
    background: rgba(201,162,39,0.15);
    border-color: rgba(201,162,39,0.4);
  }

  .surah-num {
    width: 30px;
    height: 30px;
    background: rgba(201,162,39,0.15);
    border: 1px solid rgba(201,162,39,0.3);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--gold);
    flex-shrink: 0;
  }

  .surah-info { flex: 1; min-width: 0; }
  .surah-name-latin { font-size: 13px; font-weight: 500; color: var(--cream); }
  .surah-name-ar { font-size: 12px; font-family: 'Amiri', serif; color: var(--gold); direction: rtl; }
  .surah-meta { font-size: 10px; color: rgba(253,248,238,0.45); margin-top: 1px; }

  .surah-score {
    flex-shrink: 0;
  }

  .score-ring {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid rgba(39,174,96,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 700;
    color: var(--success);
  }

  /* ===== MAIN CONTENT ===== */
  .main {
    display: grid;
    grid-template-rows: auto auto auto 1fr auto;
    overflow: hidden;
    min-height: 0;
  }

  /* ===== SURAH HEADER ===== */
  .surah-header {
    padding: 20px 28px;
    border-bottom: 1px solid rgba(201,162,39,0.15);
    background: rgba(13,35,35,0.4);
    backdrop-filter: blur(5px);
  }

  .surah-title-area {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .surah-arabic-title {
    font-family: 'Amiri', serif;
    font-size: 32px;
    color: var(--gold);
    direction: rtl;
    line-height: 1;
  }

  .surah-latin-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--cream);
  }

  .surah-sub {
    font-size: 13px;
    color: rgba(253,248,238,0.5);
    margin-top: 2px;
  }

  .score-display {
    text-align: center;
  }

  .score-circle {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: conic-gradient(var(--gold) 0%, var(--gold) var(--score-pct, 0%), rgba(201,162,39,0.1) var(--score-pct, 0%));
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    margin: 0 auto 4px;
  }

  .score-circle::before {
    content: '';
    position: absolute;
    inset: 6px;
    background: var(--teal-dark);
    border-radius: 50%;
  }

  .score-num {
    position: relative;
    z-index: 1;
    font-size: 18px;
    font-weight: 700;
    color: var(--gold);
  }

  .score-label { font-size: 11px; color: rgba(253,248,238,0.5); }

  /* ===== TABS ===== */
  .tabs {
    display: flex;
    gap: 4px;
    padding: 0 28px;
    background: rgba(13,35,35,0.3);
    border-bottom: 1px solid rgba(201,162,39,0.1);
  }

  .tab {
    padding: 12px 18px;
    font-size: 13px;
    font-weight: 500;
    color: rgba(253,248,238,0.5);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .tab:hover { color: var(--cream); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  /* ===== CONTENT AREA ===== */
  .content-area {
    overflow-y: auto;
    padding: 24px 28px;
    min-height: 0;
  }

  .content-area::-webkit-scrollbar { width: 4px; }
  .content-area::-webkit-scrollbar-track { background: transparent; }
  .content-area::-webkit-scrollbar-thumb { background: rgba(201,162,39,0.2); border-radius: 2px; }

  /* ===== BISMILLAH ===== */
  .bismillah {
    text-align: center;
    font-family: 'Amiri', serif;
    font-size: 28px;
    color: var(--gold);
    padding: 20px;
    margin-bottom: 20px;
    background: rgba(201,162,39,0.05);
    border: 1px solid rgba(201,162,39,0.15);
    border-radius: 16px;
    direction: rtl;
    letter-spacing: 1px;
  }

  /* ===== AYAT ===== */
  .ayat-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .ayat-card {
    background: rgba(13,35,35,0.5);
    border: 1px solid rgba(201,162,39,0.1);
    border-radius: 14px;
    padding: 20px;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .ayat-card:hover {
    border-color: rgba(201,162,39,0.3);
    background: rgba(13,35,35,0.7);
  }

  .ayat-card.reading {
    border-color: var(--gold);
    box-shadow: 0 0 20px rgba(201,162,39,0.2);
  }

  .ayat-card.graded-good {
    border-color: rgba(39,174,96,0.5);
    background: rgba(39,174,96,0.05);
  }

  .ayat-card.graded-ok {
    border-color: rgba(230,126,34,0.5);
    background: rgba(230,126,34,0.05);
  }

  .ayat-card.graded-bad {
    border-color: rgba(192,57,43,0.5);
    background: rgba(192,57,43,0.05);
  }

  .ayat-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .ayat-num {
    width: 32px;
    height: 32px;
    background: rgba(201,162,39,0.15);
    border: 1px solid rgba(201,162,39,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--gold);
  }

  .ayat-actions {
    display: flex;
    gap: 6px;
  }

  .btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid rgba(201,162,39,0.2);
    background: rgba(201,162,39,0.08);
    color: var(--gold);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .btn-icon:hover { background: rgba(201,162,39,0.2); }
  .btn-icon.active { background: var(--gold); color: var(--teal-dark); }

  .ayat-arabic {
    font-family: 'Amiri', serif;
    font-size: 26px;
    line-height: 2;
    color: var(--cream);
    direction: rtl;
    text-align: right;
    margin-bottom: 10px;
    letter-spacing: 0.5px;
  }

  .ayat-word {
    display: inline;
    cursor: pointer;
    transition: all 0.2s;
    padding: 2px 4px;
    border-radius: 4px;
  }

  .ayat-word:hover { background: rgba(201,162,39,0.15); color: var(--gold); }
  .ayat-word.error { color: var(--error); text-decoration: underline wavy var(--error); }
  .ayat-word.correct { color: #5DADE2; }

  .ayat-translation {
    font-size: 13px;
    color: rgba(253,248,238,0.55);
    line-height: 1.6;
    font-style: italic;
    border-top: 1px solid rgba(201,162,39,0.1);
    padding-top: 10px;
    direction: ltr;
  }

  .tajwid-feedback {
    margin-top: 10px;
    padding: 10px 12px;
    background: rgba(192,57,43,0.1);
    border: 1px solid rgba(192,57,43,0.3);
    border-radius: 8px;
    font-size: 12px;
    color: #E8967A;
    display: none;
  }

  .tajwid-feedback.show { display: block; }

  .tajwid-tag {
    display: inline-block;
    background: rgba(192,57,43,0.2);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 11px;
    margin: 2px;
    font-weight: 500;
  }

  /* ===== RECORDING PANEL ===== */
  .recording-panel {
    background: rgba(13,35,35,0.97);
    backdrop-filter: blur(15px);
    border-top: 2px solid rgba(201,162,39,0.3);
    padding: 14px 28px;
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 10;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
  }

  .rec-status {
    flex: 1;
  }

  .rec-label {
    font-size: 12px;
    color: rgba(253,248,238,0.5);
    margin-bottom: 4px;
  }

  .rec-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--cream);
    font-weight: 500;
  }

  .rec-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    transition: background 0.3s;
  }

  .rec-dot.active {
    background: var(--error);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .waveform {
    display: flex;
    align-items: center;
    gap: 2px;
    height: 30px;
    flex: 1;
  }

  .wave-bar {
    width: 3px;
    background: rgba(201,162,39,0.3);
    border-radius: 2px;
    height: 4px;
    transition: height 0.08s ease, background 0.15s;
    flex-shrink: 0;
  }
  /* .wave-bar.active → tinggi dikontrol langsung via JS (real volume) */
  /* Fallback jika AudioContext tidak tersedia */
  .wave-bar.active-fallback {
    animation: wave-fallback 0.6s ease infinite;
  }
  .wave-bar.active-fallback:nth-child(2) { animation-delay: 0.1s; }
  .wave-bar.active-fallback:nth-child(3) { animation-delay: 0.2s; }
  .wave-bar.active-fallback:nth-child(4) { animation-delay: 0.15s; }
  .wave-bar.active-fallback:nth-child(5) { animation-delay: 0.05s; }
  .wave-bar.active-fallback:nth-child(6) { animation-delay: 0.25s; }
  .wave-bar.active-fallback:nth-child(7) { animation-delay: 0.1s; }
  .wave-bar.active-fallback:nth-child(8) { animation-delay: 0.2s; }
  @keyframes wave-fallback {
    0%, 100% { height: 4px; }
    50%       { height: 18px; }
  }

  .btn-rec {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
    color: var(--teal-dark);
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(201,162,39,0.4);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .btn-rec:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(201,162,39,0.5); }
  .btn-rec.recording { background: linear-gradient(135deg, var(--error) 0%, #8B1A0D 100%); box-shadow: 0 4px 20px rgba(192,57,43,0.5); }

  .btn-play {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid rgba(201,162,39,0.3);
    background: rgba(201,162,39,0.1);
    color: var(--gold);
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .btn-play:hover { background: rgba(201,162,39,0.2); }

  /* ===== QORI SECTION ===== */
  .qori-section {
    padding: 20px 28px;
    border-bottom: 1px solid rgba(201,162,39,0.1);
    background: rgba(13,35,35,0.3);
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: rgba(253,248,238,0.6);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
  }

  .qori-list {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 4px;
  }

  .qori-list::-webkit-scrollbar { height: 3px; }
  .qori-list::-webkit-scrollbar-thumb { background: rgba(201,162,39,0.2); border-radius: 2px; }

  .qori-card {
    flex-shrink: 0;
    background: rgba(201,162,39,0.06);
    border: 1px solid rgba(201,162,39,0.15);
    border-radius: 12px;
    padding: 10px 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    min-width: 100px;
  }

  .qori-card:hover, .qori-card.active {
    background: rgba(201,162,39,0.15);
    border-color: var(--gold);
  }

  .qori-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--teal) 0%, var(--teal-dark) 100%);
    border: 2px solid rgba(201,162,39,0.3);
    margin: 0 auto 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .qori-name { font-size: 11px; font-weight: 600; color: var(--cream); }
  .qori-origin { font-size: 10px; color: rgba(253,248,238,0.45); }

  /* ===== FEEDBACK TOAST ===== */
  .feedback-toast {
    position: fixed;
    bottom: 120px;
    right: 24px;
    background: rgba(13,35,35,0.95);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(201,162,39,0.3);
    border-radius: 14px;
    padding: 16px 20px;
    max-width: 320px;
    z-index: 200;
    transform: translateX(400px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    direction: ltr;
  }

  .feedback-toast.show { transform: translateX(0); }

  .toast-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toast-body {
    font-size: 12px;
    color: rgba(253,248,238,0.7);
    line-height: 1.6;
  }

  .toast-icon { font-size: 18px; }

  /* ===== SCORE MODAL ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .modal-overlay.show { opacity: 1; pointer-events: all; }

  .score-modal {
    background: linear-gradient(135deg, #0D2B2B 0%, #1A4040 100%);
    border: 1px solid rgba(201,162,39,0.3);
    border-radius: 20px;
    padding: 32px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s;
  }

  .modal-overlay.show .score-modal { transform: scale(1); }

  .final-score {
    font-size: 72px;
    font-weight: 700;
    color: var(--gold);
    line-height: 1;
    margin: 16px 0;
  }

  .stars {
    font-size: 28px;
    margin: 8px 0;
  }

  .modal-title { font-size: 18px; font-weight: 700; color: var(--cream); margin-bottom: 4px; }
  .modal-sub { font-size: 13px; color: rgba(253,248,238,0.55); }

  .mistakes-list {
    margin-top: 20px;
    text-align: left;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 14px;
  }

  .mistake-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 12px;
    color: rgba(253,248,238,0.7);
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .mistake-item:last-child { border-bottom: none; }
  .mistake-icon { color: var(--error); flex-shrink: 0; }

  .btn-primary {
    margin-top: 20px;
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
    color: var(--teal-dark);
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: all 0.2s;
  }

  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,162,39,0.4); }

  /* ===== TAJWID LEGEND ===== */
  .tajwid-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 0;
  }

  .tjd-tag {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid;
  }

  .tjd-ikhfa { background: rgba(52,152,219,0.1); border-color: rgba(52,152,219,0.4); color: #5DADE2; }
  .tjd-idgham { background: rgba(39,174,96,0.1); border-color: rgba(39,174,96,0.4); color: #58D68D; }
  .tjd-qalqalah { background: rgba(155,89,182,0.1); border-color: rgba(155,89,182,0.4); color: #BB8FCE; }
  .tjd-mad { background: rgba(201,162,39,0.1); border-color: rgba(201,162,39,0.4); color: var(--gold-light); }
  .tjd-ghunnah { background: rgba(231,76,60,0.1); border-color: rgba(231,76,60,0.4); color: #E59866; }

  /* ===== PROGRESS BAR ===== */
  .ayat-progress {
    height: 3px;
    background: rgba(201,162,39,0.1);
    border-radius: 2px;
    margin: 8px 0 16px;
  }

  .ayat-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* ===== HIDDEN ===== */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

  .ayat-word { display: inline; }
  .ayat-word[data-tajwid]:hover {
    filter: brightness(1.3);
    transform: scale(1.05);
    display: inline-block;
  }

  /* ===== MOBILE SURAH PICKER DRAWER ===== */
  .mob-surah-btn {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 16px;
    right: 16px;
    z-index: 80;
    background: linear-gradient(135deg, #C9A227, #8B6F15);
    color: #0D2B2B;
    border: none;
    border-radius: 14px;
    padding: 15px 20px;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(201,162,39,0.45);
    text-align: left;
    align-items: center;
    justify-content: space-between;
  }
  .mob-surah-btn:active { transform: scale(.98); }

  .surah-drawer-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 150;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
  }
  .surah-drawer-overlay.open { display: block; }

  .surah-drawer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 160;
    background: #0D2B2B;
    border-top: 1px solid rgba(201,162,39,0.3);
    border-radius: 20px 20px 0 0;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform .35s cubic-bezier(.175,.885,.32,1.1);
    padding-bottom: env(safe-area-inset-bottom, 12px);
  }
  .surah-drawer.open { transform: translateY(0); }
  .sd-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; margin: 14px auto 0; }
  .sd-head { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; justify-content: space-between; }
  .sd-title { font-size: 14px; font-weight: 700; color: var(--cream); }
  .sd-close { background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; width: 30px; height: 30px; color: rgba(253,248,238,0.6); font-size: 14px; cursor: pointer; }
  .sd-search { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.07); }
  .sd-search input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(201,162,39,0.25); border-radius: 10px; color: var(--cream); font-size: 13px; font-family: 'Poppins', sans-serif; outline: none; }
  .sd-list { overflow-y: auto; flex: 1; padding: 8px; scrollbar-width: none; }
  .sd-list::-webkit-scrollbar { display: none; }

  /* ═══════════════════════════════════════
     MOBILE — REDESIGN MENYELURUH
     Target: Android portrait 360-414px
  ═══════════════════════════════════════ */
  @media (max-width: 768px) {
    /* Layout */
    .app { grid-template-columns: 1fr; grid-template-rows: 50px 1fr; }
    .sidebar { display: none; }

    /* ── HEADER: sangat compact ── */
    header {
      padding: 0 10px;
      gap: 6px;
      height: 50px;
    }
    /* Sembunyikan elemen tidak penting di mobile */
    .lang-badge { display: none; }
    #userName { display: none; }
    .logo-ai { display: none; } /* "TartilAI" → "Tartil" */
    .score-text { display: none; } /* "Total Skor" → hanya angka */

    /* Nav buttons compact */
    .hdr-nav-btn { padding: 4px 8px; font-size: 11px; }
    .hdr-icon-btn { font-size: 14px; padding: 4px 7px; }

    .logo-icon { width: 30px; height: 30px; font-size: 16px; border-radius: 8px; }
    .logo-text { font-size: 15px; font-weight: 700; }

    .user-score-badge { font-size: 11px; padding: 4px 8px; gap: 3px; }
    /* Sembunyikan teks "Total Skor", tampilkan hanya angka */
    .user-score-badge::after { display: none; }

    #userAvatar { width: 26px; height: 26px; border-width: 1.5px; }

    /* ── SURAH HEADER: compact ── */
    .surah-header { padding: 10px 14px; }
    .surah-title-area { align-items: center; }
    .surah-arabic-title { font-size: 20px; }
    .surah-latin-title { font-size: 16px; font-weight: 700; }
    .surah-sub { font-size: 11px; margin-top: 1px; }

    /* Score circle lebih kecil */
    .score-circle { width: 44px; height: 44px; }
    .score-circle::before { inset: 5px; }
    .score-num { font-size: 13px; }
    .score-label { font-size: 9px; margin-top: 2px; }

    /* ── TABS: scroll horizontal, font kecil ── */
    .tabs {
      padding: 0 10px;
      gap: 0;
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 9px 12px; font-size: 11.5px; flex-shrink: 0; }

    /* ── CONTENT ── */
    .content-area { padding: 12px 12px 78px; }

    /* Bismillah */
    .bismillah { font-size: 22px; padding: 14px 12px; margin-bottom: 14px; border-radius: 12px; }

    /* ── AYAT CARD: redesign untuk mobile ── */
    .ayat-card { padding: 14px 12px; border-radius: 12px; margin-bottom: 0; }
    .ayat-card:active { background: rgba(201,162,39,0.08); }

    .ayat-top { margin-bottom: 10px; }
    .ayat-num { width: 28px; height: 28px; font-size: 11px; }
    .btn-icon { width: 30px; height: 30px; font-size: 13px; border-radius: 7px; }

    /* ── KUNCI UTAMA: Arab mengalir normal, BUKAN kotak per-kata ── */
    .ayat-arabic {
      font-size: clamp(20px, 5.5vw, 26px) !important;
      line-height: 2.5 !important;
      padding: 4px 0 !important;
      letter-spacing: 0 !important;
      word-spacing: 6px;
    }
    /* Kata Arab: tampil inline, BUKAN kotak */
    .ayat-word {
      display: inline !important;
      padding: 1px 2px !important;
      border-radius: 3px !important;
      /* Tidak ada border/background per default */
    }

    /* Terjemahan */
    .ayat-translation { font-size: 12px; line-height: 1.65; padding-top: 8px; }

    /* Tajwid badges — max 2 saja di mobile */
    .ayat-top > div:nth-child(2) > span:nth-child(n+3) { display: none; }

    /* Tombol rekam */
    .ayat-card > div:last-child { padding-top: 10px; margin-top: 10px; }
    .ayat-card > div:last-child button {
      padding: 8px 14px !important;
      font-size: 12px !important;
      border-radius: 16px !important;
    }
    .ayat-card > div:last-child span { font-size: 11px !important; }

    /* Tajwid feedback */
    .tajwid-feedback { font-size: 11px; padding: 8px 10px; }

    /* ── RECORDING PANEL: compact & tidak memakan ruang ── */
    .recording-panel {
      padding: 8px 12px;
      gap: 10px;
      min-height: 0;
    }
    .rec-label { font-size: 10px; }
    .rec-indicator { font-size: 12px; gap: 6px; }
    #recText { font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
    .waveform { height: 24px; gap: 2px; }
    .wave-bar { width: 2px; }
    .btn-rec { width: 44px; height: 44px; font-size: 17px; }
    .btn-play { width: 36px; height: 36px; font-size: 14px; }
    .rec-dot { width: 8px; height: 8px; }

    /* ── QORI section di tab Dengar ── */
    .qori-card { padding: 8px 10px; min-width: 80px; border-radius: 10px; }
    .qori-avatar { width: 32px; height: 32px; font-size: 14px; margin-bottom: 4px; }
    .qori-name { font-size: 10px; }
    .qori-origin { font-size: 9px; }
    .section-title { font-size: 10px; letter-spacing: 0.8px; margin-bottom: 10px; }

    /* Dengar tab: audio player */
    #currentAyahDisplay { font-size: 20px !important; }
    #mainPlayBtn { width: 38px; height: 38px; font-size: 14px; }

    /* ── FLOATING SURAH BUTTON ── */
    .mob-surah-btn {
      display: flex;
      left: 12px;
      right: 12px;
      bottom: 70px; /* di atas recording panel ~62px */
      width: auto;
      transform: none !important;
      border-radius: 14px;
      padding: 11px 18px;
      font-size: 13px;
      justify-content: space-between;
      font-weight: 700;
    }

    /* Toast */
    .feedback-toast {
      bottom: 80px;
      right: 10px;
      left: 10px;
      max-width: none;
      border-radius: 12px;
      padding: 12px 14px;
    }
    .toast-title { font-size: 13px; }
    .toast-body { font-size: 11px; }
  }

  /* ── PHONE KECIL ── */
  @media (max-width: 390px) {
    header { padding: 0 8px; gap: 4px; }
    header a[href="index.html"] { padding: 3px 6px; font-size: 10px; }
    .logo-text { font-size: 14px; }
    .user-score-badge { font-size: 10px; padding: 3px 7px; }
    .tab { padding: 8px 10px; font-size: 11px; }
    .ayat-arabic { font-size: clamp(18px, 5vw, 22px) !important; }
    .bismillah { font-size: 20px; }
    #recText { max-width: 110px; }
  }

  /* ── LANDSCAPE MOBILE ── */
  @media (max-height: 500px) and (max-width: 900px) {
    header { height: 44px; }
    .app { grid-template-rows: 44px 1fr; }
    .surah-header { padding: 6px 14px; }
    .surah-arabic-title { font-size: 16px; }
    .surah-latin-title { font-size: 13px; }
    .surah-sub { display: none; }
    .ayat-progress { display: none; }
    .tab { padding: 7px 12px; font-size: 11px; }
    .content-area { padding: 10px 12px 68px; }
    .recording-panel { padding: 6px 12px; }
    .btn-rec { width: 38px; height: 38px; font-size: 15px; }
    .waveform { display: none; }
    .mob-surah-btn { bottom: 58px; }
    .bismillah { padding: 10px; font-size: 18px; margin-bottom: 10px; }
  }


/* ═══════════════════════════════════════════════
   DASHBOARD CSS (scoped to #tab-progress, #tab-ibadah)
   ═══════════════════════════════════════════════ */

:root {
  --gold:#C9A227; --gold-l:#F0D060; --gold-d:#8B6F15;
  --teal:#081E1E; --teal-m:#1A5252; --teal-l:#2A7A7A;
  --cream:#FDF6E8; --red:#E74C3C; --green:#58D68D; --blue:#5DADE2;
  --orange:#E67E22; --purple:#C39BD3;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:#081E1E;min-height:100vh;color:var(--cream);overflow-x:hidden;}

/* BG */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;}
.bg::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 70% 50% at 10% 10%,rgba(26,82,82,0.65),transparent 55%),
             radial-gradient(ellipse 50% 70% at 90% 90%,rgba(14,53,53,0.8),transparent 55%),
             linear-gradient(150deg,#081E1E,#0C2A2A 50%,#081818);}
.bg::after{content:'';position:absolute;inset:0;opacity:.03;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(201,162,39,1) 39px,rgba(201,162,39,1) 40px),
                   repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(201,162,39,1) 39px,rgba(201,162,39,1) 40px);}

/* NAV */
.nav{position:sticky;top:0;z-index:50;height:62px;padding:0 28px;display:flex;align-items:center;gap:14px;
  background:rgba(8,30,30,0.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(201,162,39,0.08);}
.nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;}
.nav-lbadge{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#C9A227,#8B6F15);
  display:flex;align-items:center;justify-content:center;font-family:'Amiri',serif;font-size:20px;color:#fff;}
.nav-lname{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--cream);}
.nav-lname span{color:var(--gold);}
.nav-links{display:flex;gap:4px;margin-left:8px;}
.nav-link{padding:6px 14px;border-radius:8px;font-size:13px;text-decoration:none;color:rgba(253,246,232,0.5);transition:all .2s;border:1px solid transparent;}
.nav-link:hover{color:var(--cream);background:rgba(255,255,255,0.05);}
.nav-link.active{color:var(--gold);background:rgba(201,162,39,0.1);border-color:rgba(201,162,39,0.2);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.nav-uav{width:28px;height:28px;border-radius:50%;border:2px solid rgba(201,162,39,0.4);object-fit:cover;}
.nav-unm{font-size:13px;color:rgba(253,246,232,0.65);}
.btn-sm{padding:6px 13px;border-radius:8px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;border:1px solid;}
.btn-out{background:rgba(192,57,43,0.1);border-color:rgba(192,57,43,0.3);color:#E74C3C;}
.btn-out:hover{background:rgba(192,57,43,0.25);}

/* MAIN */
.main{position:relative;z-index:1;padding:28px;padding-top:20px;max-width:1280px;margin:0 auto;}

/* STREAK HERO */
.streak-hero{
  background:linear-gradient(135deg,rgba(14,53,53,0.9) 0%,rgba(8,35,35,0.95) 100%);
  border:1px solid rgba(201,162,39,0.2);border-radius:24px;padding:32px;margin-bottom:24px;
  position:relative;overflow:hidden;
}
.streak-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 90% 50%,rgba(201,162,39,0.08),transparent);}
.sh-content{position:relative;z-index:1;display:flex;align-items:center;gap:32px;flex-wrap:wrap;}
.sh-flame{font-size:64px;line-height:1;filter:drop-shadow(0 0 20px rgba(255,160,0,0.5));animation:flicker 2s ease-in-out infinite alternate;}
@keyframes flicker{from{transform:scale(1) rotate(-2deg)}to{transform:scale(1.05) rotate(2deg)}}
.sh-text{}
.sh-streak-num{font-family:'Playfair Display',serif;font-size:72px;font-weight:900;line-height:1;color:var(--gold);text-shadow:0 0 40px rgba(201,162,39,0.3);}
.sh-streak-lbl{font-size:14px;color:rgba(253,246,232,0.5);margin-top:2px;}
.sh-streak-best{font-size:12px;color:rgba(253,246,232,0.35);margin-top:6px;}
.sh-divider{width:1px;height:80px;background:rgba(201,162,39,0.15);}
.sh-stats{display:flex;gap:28px;flex-wrap:wrap;}
.sh-stat{}
.sh-stat-n{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;color:var(--cream);}
.sh-stat-l{font-size:11px;color:rgba(253,246,232,0.4);margin-top:2px;}
.sh-today{margin-left:auto;}
.sh-today-label{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:rgba(253,246,232,0.4);margin-bottom:10px;}
.sh-today-goals{display:flex;flex-direction:column;gap:8px;}
.goal-item{display:flex;align-items:center;gap:10px;}
.goal-bar-wrap{flex:1;height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;min-width:100px;}
.goal-bar-fill{height:100%;border-radius:3px;transition:width .6s ease;}
.goal-label{font-size:12px;color:rgba(253,246,232,0.55);white-space:nowrap;}
.goal-pct{font-size:12px;font-weight:700;white-space:nowrap;}

/* HEATMAP */
.section{margin-bottom:24px;}
.sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.sec-title{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(201,162,39,0.6);display:flex;align-items:center;gap:10px;}
.sec-title::after{content:'';width:40px;height:1px;background:rgba(201,162,39,0.2);}
.sec-action{font-size:12px;color:rgba(253,246,232,0.4);cursor:pointer;transition:color .2s;}
.sec-action:hover{color:var(--gold);}

.heatmap-card{background:rgba(13,46,46,0.55);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:24px;}
.heatmap-months{display:flex;gap:2px;margin-bottom:6px;padding-left:28px;}
.hm-month{font-size:10px;color:rgba(253,246,232,0.35);flex:1;text-align:center;}
.heatmap-wrap{display:flex;gap:6px;}
.hm-days-label{display:flex;flex-direction:column;gap:2px;padding-top:2px;}
.hm-day-lbl{font-size:9px;color:rgba(253,246,232,0.25);height:14px;line-height:14px;}
.heatmap-grid{display:grid;grid-template-columns:repeat(53,1fr);gap:2px;flex:1;}
.hm-cell{width:100%;aspect-ratio:1;border-radius:2px;cursor:pointer;transition:all .15s;position:relative;}
.hm-cell:hover{transform:scale(1.4);z-index:10;}
.hm-cell[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:rgba(10,30,30,0.97);border:1px solid rgba(201,162,39,0.3);border-radius:6px;
  padding:5px 9px;font-size:10px;color:var(--cream);white-space:nowrap;pointer-events:none;z-index:20;}
.hm-legend{display:flex;align-items:center;gap:6px;margin-top:12px;justify-content:flex-end;}
.hm-legend-lbl{font-size:10px;color:rgba(253,246,232,0.3);}
.hm-legend-cell{width:12px;height:12px;border-radius:2px;}

/* GRID 2-COL */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;}

/* CARD */
.card{background:rgba(13,46,46,0.55);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:24px;}
.card-title{font-size:14px;font-weight:600;color:var(--cream);margin-bottom:16px;display:flex;align-items:center;gap:8px;}

/* GOALS */
.goal-editor{margin-bottom:20px;}
.goal-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.goal-row:last-child{border-bottom:none;}
.goal-ico{font-size:22px;width:36px;text-align:center;}
.goal-info{flex:1;}
.goal-name{font-size:13px;font-weight:600;color:var(--cream);margin-bottom:2px;}
.goal-sub{font-size:11px;color:rgba(253,246,232,0.4);}
.goal-input{width:60px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--cream);font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;text-align:center;}
.goal-unit{font-size:12px;color:rgba(253,246,232,0.4);}
.btn-save-goal{width:100%;padding:11px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;margin-top:12px;transition:all .2s;}
.btn-save-goal:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,162,39,0.3);}

/* SPACED REP */
.sr-queue{display:flex;flex-direction:column;gap:10px;}
.sr-card-item{background:rgba(8,28,28,0.6);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;}
.sr-card-item:hover{border-color:rgba(201,162,39,0.3);background:rgba(201,162,39,0.05);}
.sr-arab{font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--cream);flex:1;line-height:1.4;}
.sr-meta{text-align:right;flex-shrink:0;}
.sr-surah{font-size:11px;color:rgba(253,246,232,0.4);margin-bottom:3px;}
.sr-due{font-size:11px;font-weight:700;padding:2px 8px;border-radius:6px;}
.due-now{background:rgba(192,57,43,0.15);color:#E74C3C;}
.due-soon{background:rgba(230,126,34,0.15);color:#E67E22;}
.due-later{background:rgba(88,214,141,0.12);color:#58D68D;}
.sr-ease{font-size:10px;color:rgba(253,246,232,0.3);margin-top:3px;}
.sr-review-btn{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;background:rgba(201,162,39,0.15);color:#C9A227;font-size:12px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .2s;flex-shrink:0;}
.sr-review-btn:hover{background:rgba(201,162,39,0.3);}

/* SR MODAL */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;}
.modal-card{background:rgba(10,32,32,0.98);border:1px solid rgba(201,162,39,0.25);border-radius:24px;padding:36px;max-width:520px;width:92%;text-align:center;}
.modal-surah{font-size:12px;color:rgba(253,246,232,0.4);margin-bottom:12px;}
.modal-arab{font-family:'Amiri',serif;font-size:36px;direction:rtl;color:var(--cream);line-height:1.7;margin-bottom:8px;}
.modal-trans{font-size:14px;color:rgba(253,246,232,0.5);font-style:italic;margin-bottom:28px;}
.modal-question{font-size:15px;color:rgba(253,246,232,0.7);margin-bottom:20px;}
.modal-hidden{font-size:32px;letter-spacing:8px;color:rgba(253,246,232,0.15);font-family:monospace;margin-bottom:20px;}
.btn-reveal{padding:12px 28px;border-radius:12px;border:1px solid rgba(201,162,39,0.35);background:transparent;color:#C9A227;font-size:14px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;margin-bottom:20px;}
.btn-reveal:hover{background:rgba(201,162,39,0.12);}
.sr-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.sr-grade-btn{padding:12px 20px;border-radius:12px;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:90px;}
.sr-grade-btn:hover{transform:translateY(-2px);}
.sr-grade-btn span{font-size:10px;font-weight:400;opacity:.7;}
.grade-0{background:rgba(192,57,43,0.2);color:#E74C3C;border:1px solid rgba(192,57,43,0.35);}
.grade-1{background:rgba(230,126,34,0.2);color:#E67E22;border:1px solid rgba(230,126,34,0.35);}
.grade-2{background:rgba(241,196,15,0.15);color:#F1C40F;border:1px solid rgba(241,196,15,0.3);}
.grade-3{background:rgba(88,214,141,0.15);color:#58D68D;border:1px solid rgba(88,214,141,0.3);}

/* ADD HAFALAN */
.add-hafalan-btn{width:100%;padding:12px;border-radius:12px;border:1px dashed rgba(201,162,39,0.25);background:transparent;color:rgba(201,162,39,0.6);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;margin-top:10px;}
.add-hafalan-btn:hover{border-color:rgba(201,162,39,0.5);color:#C9A227;background:rgba(201,162,39,0.05);}

/* CHART */
.chart-wrap{position:relative;height:140px;margin-top:8px;}
.chart-bars{display:flex;align-items:flex-end;gap:6px;height:120px;}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.chart-bar{width:100%;border-radius:4px 4px 0 0;background:linear-gradient(180deg,rgba(201,162,39,0.8),rgba(201,162,39,0.3));transition:height .6s ease;min-height:3px;cursor:pointer;position:relative;}
.chart-bar:hover{background:linear-gradient(180deg,#F0D060,rgba(201,162,39,0.5));}
.chart-bar[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:rgba(10,30,30,0.97);border:1px solid rgba(201,162,39,0.3);border-radius:6px;
  padding:5px 9px;font-size:11px;color:var(--cream);white-space:nowrap;z-index:10;}
.chart-lbl{font-size:9px;color:rgba(253,246,232,0.3);text-align:center;}

/* NOTIFICATION */
.notif-banner{display:none;position:fixed;bottom:24px;right:24px;z-index:100;
  background:rgba(13,46,46,0.97);border:1px solid rgba(201,162,39,0.3);border-radius:14px;
  padding:16px 20px;max-width:320px;box-shadow:0 20px 40px rgba(0,0,0,0.5);
  animation:slideIn .3s cubic-bezier(.175,.885,.32,1.1);}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.notif-title{font-size:14px;font-weight:700;color:var(--gold);margin-bottom:6px;}
.notif-msg{font-size:13px;color:rgba(253,246,232,0.7);line-height:1.5;}
.notif-close{position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(253,246,232,0.4);cursor:pointer;font-size:16px;}

/* BADGES */
.badges-grid{display:flex;flex-wrap:wrap;gap:10px;}
.badge-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;text-align:center;min-width:80px;transition:all .2s;}
.badge-item.earned{border-color:rgba(201,162,39,0.35);background:rgba(201,162,39,0.07);}
.badge-item:hover{transform:translateY(-2px);}
.badge-ico{font-size:28px;margin-bottom:6px;}
.badge-name{font-size:10px;color:rgba(253,246,232,0.5);font-weight:600;}
.badge-item.earned .badge-name{color:rgba(201,162,39,0.85);}
.badge-locked{filter:grayscale(100%);opacity:.35;}

/* ADD AYAT MODAL */
.add-modal{max-width:480px;}
.surah-select{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--cream);font-size:14px;font-family:'DM Sans',sans-serif;margin-bottom:12px;appearance:none;}
.surah-select option{background:#0D2B2B;}
.ayat-input{display:flex;gap:10px;margin-bottom:12px;}
.ayat-input input{flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--cream);font-size:14px;font-family:'DM Sans',sans-serif;}
.ayat-preview{background:rgba(8,28,28,0.6);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;margin-bottom:16px;text-align:right;font-family:'Amiri',serif;font-size:24px;direction:rtl;color:var(--cream);line-height:1.7;min-height:64px;}
.btn-add-hafalan{width:100%;padding:13px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;}

@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.spin{animation:spin 1s linear infinite;display:inline-block;}

/* ===== MOBILE HAMBURGER MENU ===== */
.nav-ham{display:none;flex-direction:column;gap:5px;cursor:pointer;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);}
.nav-ham span{display:block;width:20px;height:2px;background:rgba(253,246,232,0.6);border-radius:2px;transition:all .25s;}
.mobile-menu{display:none;position:fixed;inset:0;z-index:200;background:rgba(8,30,30,0.97);backdrop-filter:blur(20px);flex-direction:column;padding:28px 24px;}
.mobile-menu.open{display:flex;}
.mm-close{align-self:flex-end;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:10px;width:38px;height:38px;color:rgba(253,246,232,0.6);font-size:18px;cursor:pointer;margin-bottom:28px;}
.mm-links{display:flex;flex-direction:column;gap:8px;}
.mm-link{padding:16px 20px;border-radius:14px;font-size:16px;text-decoration:none;color:rgba(253,246,232,0.7);border:1px solid rgba(255,255,255,0.07);background:rgba(255,255,255,0.03);transition:all .2s;}
.mm-link.active{color:var(--gold);background:rgba(201,162,39,0.1);border-color:rgba(201,162,39,0.25);}
.mm-link:hover{border-color:rgba(255,255,255,0.15);color:var(--cream);}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .grid2,.grid3{grid-template-columns:1fr;}
  .sh-content{flex-wrap:wrap;gap:16px;}
  .sh-today{margin-left:0;width:100%;}
  .sh-divider{display:none;}
  .sh-stats{gap:16px 24px;}

  /* Nav - hide links, show hamburger */
  .nav{padding:0 14px;height:56px;}
  .nav-links{display:none;}
  .nav-lname{font-size:16px;}
  .nav-ham{display:flex;}
  .nav-unm{display:none;}
  .nav-uav{width:26px;height:26px;}
  .btn-sm{padding:5px 10px;font-size:11px;}

  /* Main */
  .main{padding:14px;}
  .streak-hero{padding:20px;border-radius:18px;margin-bottom:16px;}
  .sh-streak-num{font-size:52px;}
  .sh-flame{font-size:48px;}
  .sh-stat-n{font-size:22px;}
  .sh-stats{gap:12px 20px;}

  /* Heatmap - make scrollable horizontally */
  .heatmap-card{padding:16px;overflow-x:auto;}
  .heatmap-grid{grid-template-columns:repeat(53,12px);gap:2px;}
  .hm-cell{width:12px;height:12px;}

  /* Cards */
  .card{padding:18px;border-radius:16px;}

  /* SR modal */
  .modal-card{padding:24px 18px;border-radius:18px;}
  .modal-arab{font-size:28px;}
  .sr-grade-btn{min-width:70px;padding:10px 14px;font-size:12px;}

  /* Notification */
  .notif-banner{bottom:16px;top:auto;right:12px;left:12px;max-width:none;}

  /* Section */
  .section{margin-bottom:16px;}
}

@media(max-width:480px){
  .sh-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .sh-today-goals .goal-item{flex-wrap:wrap;}
}

/* ══════════ SHALAT WIDGET (sticky bar) ══════════ */
.shalat-bar{
  position:sticky;top:62px;z-index:90;
  background:rgba(8,28,28,0.98);
  border-bottom:1px solid rgba(201,162,39,0.2);
  padding:8px 20px;display:flex;align-items:center;gap:12px;
  flex-wrap:nowrap;
}
.shalat-next{display:flex;align-items:center;gap:10px;flex:1;}
.shalat-next-name{font-size:13px;font-weight:700;color:var(--gold);}
.shalat-countdown{
  font-size:20px;font-weight:800;color:var(--cream);
  font-variant-numeric:tabular-nums;letter-spacing:-0.5px;
}
.shalat-countdown.urgent{color:#E74C3C;animation:pulse-red 1s infinite;}
@keyframes pulse-red{0%,100%{opacity:1}50%{opacity:0.6}}
.shalat-countdown.soon{color:#E67E22;}
.shalat-city{font-size:11px;color:rgba(253,246,232,0.4);display:flex;align-items:center;gap:4px;}
.shalat-times{display:flex;gap:10px;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;flex-shrink:1;min-width:0;}
.shalat-times::-webkit-scrollbar{display:none;}
.shalat-time-item{text-align:center;min-width:44px;}
.shalat-time-name{font-size:9px;color:rgba(253,246,232,0.45);text-transform:uppercase;letter-spacing:0.5px;}
.shalat-time-val{font-size:12px;font-weight:700;color:var(--cream);}
.shalat-time-item.active .shalat-time-val{color:var(--gold);}
.shalat-time-item.active .shalat-time-name{color:rgba(201,162,39,0.7);}
.btn-kiblat{padding:5px 12px;border-radius:8px;border:1px solid rgba(201,162,39,0.3);
  background:rgba(201,162,39,0.08);color:var(--gold);font-size:11px;font-weight:600;
  cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;}
.btn-kiblat:hover{background:rgba(201,162,39,0.18);}

/* ══════════ KIBLAT MODAL ══════════ */
.kiblat-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.8);
  backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;}
.kiblat-overlay.open{display:flex;}
.kiblat-card{background:#0D2B2B;border:1px solid rgba(201,162,39,0.3);border-radius:24px;
  padding:32px;max-width:340px;width:92%;text-align:center;}
.kiblat-compass{position:relative;width:200px;height:200px;margin:0 auto 20px;}
.kiblat-compass-ring{width:100%;height:100%;border-radius:50%;
  border:3px solid rgba(201,162,39,0.3);position:relative;
  background:radial-gradient(circle,rgba(13,43,43,0.9),rgba(8,28,28,1));}
.kiblat-needle{position:absolute;top:50%;left:50%;
  width:6px;height:140px;margin-left:-3px;margin-top:-70px;
  transform-origin:center center;transition:transform 0.5s ease;border-radius:3px;
  background:linear-gradient(to bottom,#C9A227 0%,#C9A227 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 100%);}
.kiblat-needle::before{content:'🕋';position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:16px;}
.kiblat-center{position:absolute;top:50%;left:50%;
  width:12px;height:12px;border-radius:50%;
  background:var(--gold);transform:translate(-50%,-50%);}
.kiblat-labels{position:absolute;inset:0;}
.kiblat-n{position:absolute;top:6px;left:50%;transform:translateX(-50%);
  font-size:12px;font-weight:700;color:#E74C3C;font-weight:800;}
.kiblat-s{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);
  font-size:11px;color:rgba(253,246,232,0.4);}
.kiblat-e{position:absolute;right:6px;top:50%;transform:translateY(-50%);
  font-size:11px;color:rgba(253,246,232,0.4);}
.kiblat-w{position:absolute;left:6px;top:50%;transform:translateY(-50%);
  font-size:11px;color:rgba(253,246,232,0.4);}
.kiblat-kaabah{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:22px;margin-top:-36px;}

/* ══════════ CHART.JS CONTAINER ══════════ */
.chartjs-wrap{position:relative;height:220px;width:100%;}
.chart-tabs{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;padding-bottom:2px;}
.chart-tabs::-webkit-scrollbar{display:none;}
.chart-tab{padding:5px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);flex-shrink:0;
  background:transparent;color:rgba(253,246,232,0.45);font-size:12px;
  cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.chart-tab.active{background:rgba(201,162,39,0.15);border-color:rgba(201,162,39,0.4);color:var(--gold);}
.chart-stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px;}
.chart-stat{background:rgba(8,28,28,0.5);border:1px solid rgba(255,255,255,0.06);
  border-radius:10px;padding:10px;text-align:center;}
.chart-stat-n{font-size:20px;font-weight:800;color:var(--gold);}
.chart-stat-l{font-size:10px;color:rgba(253,246,232,0.45);margin-top:2px;}

/* ══════════ LEADERBOARD ══════════ */
.lb-item{display:flex;align-items:center;gap:12px;padding:10px 14px;
  border-radius:12px;border:1px solid rgba(255,255,255,0.06);
  background:rgba(8,28,28,0.4);margin-bottom:8px;transition:all .2s;}
.lb-item:hover{border-color:rgba(201,162,39,0.2);background:rgba(13,43,43,0.6);}
.lb-item.me{border-color:rgba(201,162,39,0.4);background:rgba(201,162,39,0.07);}
.lb-rank{font-size:18px;font-weight:800;width:28px;text-align:center;flex-shrink:0;}
.lb-rank.gold{color:#FFD700;}.lb-rank.silver{color:#C0C0C0;}.lb-rank.bronze{color:#CD7F32;}
.lb-rank.other{color:rgba(253,246,232,0.3);font-size:13px;}
.lb-av{width:36px;height:36px;border-radius:50%;border:2px solid rgba(201,162,39,0.25);
  display:flex;align-items:center;justify-content:center;font-size:16px;
  background:rgba(42,138,138,0.2);flex-shrink:0;overflow:hidden;}
.lb-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.lb-info{flex:1;min-width:0;}
.lb-name{font-size:13px;font-weight:600;color:var(--cream);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lb-sub{font-size:11px;color:rgba(253,246,232,0.4);}
.lb-score{font-size:15px;font-weight:800;color:var(--gold);flex-shrink:0;}
.lb-tabs{display:flex;gap:6px;margin-bottom:14px;}
.lb-tab{padding:5px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);
  background:transparent;color:rgba(253,246,232,0.45);font-size:12px;
  cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.lb-tab.active{background:rgba(201,162,39,0.15);border-color:rgba(201,162,39,0.4);color:var(--gold);}
.lb-sep{text-align:center;font-size:11px;color:rgba(253,246,232,0.2);
  padding:6px 0;letter-spacing:1px;}

/* ══════════ BADGE BARU ══════════ */
.badge-item{position:relative;}
.badge-new-dot{position:absolute;top:-2px;right:-2px;width:10px;height:10px;
  border-radius:50%;background:#E74C3C;border:2px solid var(--teal-dark);
  display:none;}
.badge-item.just-earned .badge-new-dot{display:block;}
.badge-unlock-toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,rgba(13,43,43,0.98),rgba(8,28,28,0.98));
  border:1px solid rgba(201,162,39,0.5);border-radius:16px;
  padding:16px 24px;z-index:999;display:flex;align-items:center;gap:14px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:badge-in .5s cubic-bezier(.175,.885,.32,1.275);
  max-width:340px;width:90%;
}
@keyframes badge-in{from{opacity:0;transform:translateX(-50%) translateY(40px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.badge-unlock-ico{font-size:36px;animation:spin-in .6s ease;}
@keyframes spin-in{from{transform:rotate(-180deg) scale(0)}to{transform:rotate(0) scale(1)}}
.badge-unlock-text{font-size:14px;font-weight:700;color:var(--cream);}
.badge-unlock-sub{font-size:12px;color:rgba(253,246,232,0.5);margin-top:2px;}

@media(max-width:768px){
  /* Shalat bar */
  .shalat-bar{top:56px;padding:6px 10px;gap:8px;}
  .shalat-next-name{font-size:12px;}
  .shalat-countdown{font-size:16px;}
  .shalat-times{gap:6px;}
  .shalat-time-item{min-width:36px;}
  .shalat-time-val{font-size:10px;}
  .shalat-time-name{font-size:8px;}
  .shalat-city{font-size:10px;}
  .btn-kiblat{padding:4px 10px;font-size:10px;flex-shrink:0;}

  /* Chart */
  .chartjs-wrap{height:170px;}
  .chart-stat-n{font-size:16px;}
  .chart-stat-l{font-size:9px;}
  .chart-stat{padding:8px 6px;}

  /* Leaderboard */
  .lb-item{padding:8px 10px;gap:8px;}
  .lb-av{width:30px;height:30px;font-size:14px;}
  .lb-rank{width:24px;font-size:15px;}
  .lb-name{font-size:12px;}
  .lb-sub{font-size:10px;}
  .lb-score{font-size:13px;}
  .lb-tab{padding:4px 10px;font-size:11px;}

  /* Badge */
  .badge-unlock-toast{padding:12px 16px;gap:10px;border-radius:14px;}
  .badge-unlock-ico{font-size:28px;}
  .badge-unlock-text{font-size:13px;}
  .badge-unlock-sub{font-size:11px;}
}

@media(max-width:400px){
  /* Shalat bar sangat kecil: sembunyikan jadwal lengkap, tampilkan hanya next */
  .shalat-times{display:none;}
  .shalat-bar{gap:6px;}
  .shalat-countdown{font-size:15px;}
}


/* ═══════════════════════════════════════════════
   TAJWID CSS (scoped)
   ═══════════════════════════════════════════════ */

:root{
  --gold:#C9A227; --gold-l:#F0D060; --teal:#081E1E; --cream:#FDF6E8;
  --teal-m:#1A5252; --teal-l:#2A7A7A;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:#081E1E;min-height:100vh;color:var(--cream);overflow-x:hidden;}

.bg{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none;}
.bg::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 10% 10%,rgba(26,82,82,0.7),transparent 60%),linear-gradient(155deg,#081E1E,#0D2E2E 50%,#081818);}
.bg::after{content:'';position:absolute;inset:0;opacity:0.03;background-image:repeating-linear-gradient(0deg,transparent,transparent 59px,rgba(201,162,39,1) 59px,rgba(201,162,39,1) 60px),repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(201,162,39,1) 59px,rgba(201,162,39,1) 60px);}

/* NAV */
.nav{position:sticky;top:0;z-index:50;height:60px;padding:0 24px;display:flex;align-items:center;gap:12px;background:rgba(8,30,30,0.88);backdrop-filter:blur(20px);border-bottom:1px solid rgba(201,162,39,0.08);}
.nav-back{display:flex;align-items:center;gap:8px;text-decoration:none;color:rgba(253,246,232,0.55);font-size:13px;padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.07);transition:all .2s;}
.nav-back:hover{color:var(--cream);border-color:rgba(255,255,255,0.15);}
.nav-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--cream);}
.nav-title span{color:var(--gold);}
.nav-user{margin-left:auto;display:flex;align-items:center;gap:8px;}
.uav{width:26px;height:26px;border-radius:50%;border:2px solid rgba(201,162,39,0.4);object-fit:cover;}
.unm{font-size:12px;color:rgba(253,246,232,0.6);}

/* LAYOUT */
.layout{display:grid;grid-template-columns:280px 1fr;height:calc(100vh - 60px);position:relative;z-index:1;}

/* SIDEBAR */
.sidebar{overflow-y:auto;border-right:1px solid rgba(255,255,255,0.05);padding:20px 12px;scrollbar-width:thin;scrollbar-color:rgba(201,162,39,0.2) transparent;}
.sidebar::-webkit-scrollbar{width:4px;}
.sidebar::-webkit-scrollbar-thumb{background:rgba(201,162,39,0.2);border-radius:2px;}

.sb-head{padding:0 8px 16px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:12px;}
.sb-label{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(253,246,232,0.35);margin-bottom:12px;}
.overall-prog{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px;}
.op-num{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;color:var(--gold);}
.op-lbl{font-size:11px;color:rgba(253,246,232,0.4);margin-bottom:8px;}
.op-bar{height:6px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;}
.op-fill{height:100%;background:linear-gradient(90deg,#C9A227,#F0D060);border-radius:3px;transition:width .8s;}

.bab-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s;margin-bottom:4px;border:1px solid transparent;}
.bab-item:hover{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.06);}
.bab-item.active{background:rgba(201,162,39,0.1);border-color:rgba(201,162,39,0.25);}
.bab-item.done .bab-ico{background:rgba(88,214,141,0.15);color:#58D68D;}
.bab-ico{width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;transition:all .2s;}
.bab-item.active .bab-ico{background:rgba(201,162,39,0.15);color:#C9A227;border-color:rgba(201,162,39,0.3);}
.bab-info{flex:1;min-width:0;}
.bab-name{font-size:13px;font-weight:500;color:rgba(253,246,232,0.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bab-item.active .bab-name{color:var(--cream);}
.bab-sub{font-size:11px;color:rgba(253,246,232,0.35);margin-top:1px;}
.bab-score{font-size:11px;font-weight:700;flex-shrink:0;padding:2px 7px;border-radius:8px;}
.score-done{background:rgba(88,214,141,0.12);color:#58D68D;}
.score-mid{background:rgba(230,126,34,0.12);color:#E67E22;}
.score-low{background:rgba(192,57,43,0.12);color:#E74C3C;}

/* CONTENT */
.content{overflow-y:auto;padding:32px 40px;scrollbar-width:thin;scrollbar-color:rgba(201,162,39,0.15) transparent;}
.content::-webkit-scrollbar{width:4px;}
.content::-webkit-scrollbar-thumb{background:rgba(201,162,39,0.15);border-radius:2px;}

/* BAB HEADER */
.bab-header{margin-bottom:32px;}
.bab-badge{display:inline-flex;align-items:center;gap:8px;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border:1px solid rgba(201,162,39,0.25);background:rgba(201,162,39,0.08);color:#C9A227;margin-bottom:14px;}
.bab-title{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;color:var(--cream);margin-bottom:8px;line-height:1.1;}
.bab-desc{font-size:15px;color:rgba(253,246,232,0.5);line-height:1.7;max-width:600px;}

/* LESSON CARD */
.lesson-section{margin-bottom:36px;}
.lesson-section-title{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(201,162,39,0.6);margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid rgba(201,162,39,0.1);}

.lesson-card{background:rgba(13,46,46,0.6);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:24px;margin-bottom:16px;transition:border-color .2s;}
.lesson-card:hover{border-color:rgba(201,162,39,0.15);}
.lesson-card.highlight{border-color:rgba(201,162,39,0.25);background:rgba(201,162,39,0.04);}

/* HURUF TABLE */
.huruf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:8px;}
.huruf-cell{background:rgba(13,46,46,0.8);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px 8px;text-align:center;cursor:pointer;transition:all .25s;}
.huruf-cell:hover{border-color:rgba(201,162,39,0.4);background:rgba(201,162,39,0.08);transform:translateY(-2px);}
.huruf-cell.selected{border-color:rgba(201,162,39,0.6);background:rgba(201,162,39,0.12);}
.h-arab{font-family:'Amiri',serif;font-size:36px;color:var(--cream);direction:rtl;line-height:1.2;}
.h-name{font-size:10px;color:rgba(253,246,232,0.45);margin-top:4px;}
.h-latin{font-size:10px;color:rgba(201,162,39,0.7);font-weight:600;}

/* HARAKAT */
.harakat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:8px;}
.harakat-card{background:rgba(13,46,46,0.8);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:18px;text-align:center;cursor:pointer;transition:all .25s;}
.harakat-card:hover{transform:translateY(-3px);border-color:rgba(201,162,39,0.35);}
.hr-symbol{font-family:'Amiri',serif;font-size:40px;color:var(--gold);direction:rtl;}
.hr-name{font-size:13px;font-weight:600;color:var(--cream);margin:8px 0 4px;}
.hr-read{font-size:12px;color:rgba(253,246,232,0.45);}

/* TAJWID COLOR TABLE */
.tajwid-table{width:100%;border-collapse:collapse;margin-top:8px;}
.tajwid-table th{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:rgba(253,246,232,0.4);padding:8px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06);}
.tajwid-table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;color:rgba(253,246,232,0.75);}
.tajwid-table tr:hover td{background:rgba(255,255,255,0.02);}
.color-dot{width:14px;height:14px;border-radius:4px;display:inline-block;margin-right:8px;vertical-align:middle;}
.rule-badge{display:inline-block;padding:3px 10px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid;}

/* MAKHRAJ */
.makhraj-group{margin-bottom:20px;}
.mk-group-title{font-size:13px;font-weight:700;color:rgba(201,162,39,0.8);margin-bottom:10px;padding:6px 12px;background:rgba(201,162,39,0.07);border-radius:8px;border-left:3px solid #C9A227;}
.mk-items{display:flex;flex-wrap:wrap;gap:10px;}
.mk-item{background:rgba(13,46,46,0.8);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;}
.mk-arab{font-family:'Amiri',serif;font-size:28px;color:var(--cream);direction:rtl;min-width:36px;}
.mk-info{font-size:12px;color:rgba(253,246,232,0.55);line-height:1.6;}
.mk-info strong{color:var(--cream);display:block;font-size:13px;}

/* HUKUM NUN MIM */
.hukum-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:8px;}
.hukum-card{border-radius:14px;padding:20px;border:1px solid;}
.hk-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.hk-num{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
.hk-name{font-size:15px;font-weight:700;}
.hk-huruf{font-family:'Amiri',serif;font-size:18px;direction:rtl;color:rgba(253,246,232,0.65);margin-bottom:8px;line-height:1.6;}
.hk-desc{font-size:12px;color:rgba(253,246,232,0.55);line-height:1.7;}
.hk-example{font-family:'Amiri',serif;font-size:20px;direction:rtl;margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.04);}

/* MAD TABLE */
.mad-row{display:grid;grid-template-columns:1fr 2fr 80px;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.05);align-items:start;}
.mad-row:last-child{border-bottom:none;}
.mad-name{font-size:13px;font-weight:600;color:var(--cream);}
.mad-desc{font-size:12px;color:rgba(253,246,232,0.5);line-height:1.6;}
.mad-harakah{font-size:13px;font-weight:700;color:var(--gold);text-align:center;}

/* QUIZ */
.quiz-section{background:rgba(13,46,46,0.6);border:1px solid rgba(201,162,39,0.2);border-radius:16px;padding:28px;margin-top:24px;}
.quiz-title{font-size:18px;font-weight:700;color:var(--cream);margin-bottom:6px;display:flex;align-items:center;gap:10px;}
.quiz-sub{font-size:13px;color:rgba(253,246,232,0.45);margin-bottom:24px;}
.quiz-progress{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.qp-bar{flex:1;height:5px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;}
.qp-fill{height:100%;background:linear-gradient(90deg,#C9A227,#F0D060);border-radius:3px;transition:width .4s;}
.qp-text{font-size:12px;color:rgba(253,246,232,0.4);white-space:nowrap;}
.q-question{font-size:17px;color:var(--cream);margin-bottom:18px;line-height:1.5;}
.q-arab{font-family:'Amiri',serif;font-size:32px;direction:rtl;color:var(--gold);display:block;margin-bottom:8px;text-align:center;}
.q-opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.q-opt{padding:13px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);cursor:pointer;font-size:14px;color:rgba(253,246,232,0.75);font-family:'DM Sans',sans-serif;transition:all .2s;text-align:left;}
.q-opt:hover{border-color:rgba(201,162,39,0.35);background:rgba(201,162,39,0.07);color:var(--cream);}
.q-opt.correct{border-color:#58D68D;background:rgba(88,214,141,0.12);color:#58D68D;}
.q-opt.wrong  {border-color:#E74C3C;background:rgba(192,57,43,0.1);color:#E74C3C;}
.q-opt.disabled{cursor:not-allowed;opacity:0.6;}
.q-feedback{padding:14px;border-radius:10px;font-size:13px;line-height:1.6;margin-bottom:16px;display:none;}
.fb-correct{background:rgba(88,214,141,0.1);border:1px solid rgba(88,214,141,0.25);color:#58D68D;}
.fb-wrong  {background:rgba(192,57,43,0.08);border:1px solid rgba(192,57,43,0.25);color:#E74C3C;}
.btn-next{padding:12px 28px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;transition:all .2s;}
.btn-next:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,162,39,0.3);}
.btn-next:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.quiz-result{text-align:center;padding:20px 0;}
.qr-score{font-family:'Playfair Display',serif;font-size:64px;font-weight:900;margin-bottom:8px;}
.qr-msg{font-size:16px;color:rgba(253,246,232,0.6);margin-bottom:24px;}
.btn-retry{padding:12px 24px;border-radius:12px;border:1px solid rgba(201,162,39,0.3);background:transparent;color:#C9A227;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;margin-right:10px;}

/* NAV BUTTONS */
.lesson-nav{display:flex;justify-content:space-between;align-items:center;margin-top:40px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.06);}
.btn-prev{padding:11px 22px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(253,246,232,0.55);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.btn-prev:hover{border-color:rgba(255,255,255,0.2);color:var(--cream);}
.btn-nxt{padding:11px 24px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;display:flex;align-items:center;gap:8px;transition:all .2s;}
.btn-nxt:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(201,162,39,0.3);}

@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.spin{animation:spin 1s linear infinite;display:inline-block;}

/* TOOLTIP */
.tip{position:relative;cursor:help;}
.tip::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:rgba(10,30,30,0.96);border:1px solid rgba(201,162,39,0.3);border-radius:8px;padding:8px 12px;font-size:11px;color:rgba(253,246,232,0.85);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;z-index:10;}
.tip:hover::after{opacity:1;}

/* ═══════ MOBILE DRAWER (bottom sheet) ═══════ */
.mob-bab-btn{
  display:none;
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:80;
  background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;
  border:none;border-radius:50px;padding:14px 32px;
  font-size:14px;font-weight:700;font-family:'DM Sans',sans-serif;
  cursor:pointer;box-shadow:0 8px 28px rgba(201,162,39,0.45);white-space:nowrap;
  align-items:center;gap:10px;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
}
.mob-bab-btn:active{transform:translateX(-50%) scale(.97);}

.drawer-overlay{display:none;position:fixed;inset:0;z-index:150;background:rgba(0,0,0,0.72);backdrop-filter:blur(4px);}
.drawer-overlay.open{display:block;}
.drawer{
  position:fixed;bottom:0;left:0;right:0;z-index:160;
  background:#0D2E2E;border-top:2px solid rgba(201,162,39,0.22);border-radius:20px 20px 0 0;
  padding:0 0 env(safe-area-inset-bottom,14px);
  max-height:82vh;display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .32s cubic-bezier(.175,.885,.32,1.1);
}
.drawer.open{transform:translateY(0);}
.drawer-handle{width:44px;height:4px;background:rgba(255,255,255,0.18);border-radius:2px;margin:12px auto 0;}
.drawer-head{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:space-between;}
.drawer-title{font-size:15px;font-weight:700;color:var(--cream);}
.drawer-close{
  background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;width:32px;height:32px;color:rgba(253,246,232,0.6);
  font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.drawer-body{overflow-y:auto;padding:8px;flex:1;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.drawer-body::-webkit-scrollbar{display:none;}

/* ═══════ TABLET ═══════ */
@media(max-width:768px){
  .layout{grid-template-columns:1fr;}
  .sidebar{display:none;}

  /* Nav */
  .nav{padding:0 12px;height:54px;}
  .nav-title{font-size:15px;}
  .nav-back{font-size:12px;padding:5px 10px;}
  .nav-user .unm{display:none;}

  /* Content */
  .content{padding:16px 14px 96px;}

  /* Bab header */
  .bab-badge{font-size:10px;padding:4px 12px;}
  .bab-title{font-size:26px;margin-bottom:6px;}
  .bab-desc{font-size:13px;line-height:1.6;}

  /* Lesson cards */
  .lesson-section-title{font-size:11px;}
  .lesson-card{padding:16px;border-radius:14px;}

  /* Huruf */
  .huruf-grid{grid-template-columns:repeat(auto-fill,minmax(68px,1fr));gap:8px;}
  .huruf-cell{padding:10px 6px;border-radius:10px;}
  .h-arab{font-size:26px;}
  .h-name,.h-latin{font-size:9px;}

  /* Harakat */
  .harakat-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;}
  .hr-symbol{font-size:34px;}
  .hr-name{font-size:12px;}

  /* Hukum */
  .hukum-grid{grid-template-columns:1fr;}
  .hukum-card{padding:16px;}
  .hk-name{font-size:14px;}
  .hk-desc{font-size:12px;}

  /* Mad table */
  .mad-row{grid-template-columns:1fr;gap:4px;padding:12px 0;}
  .mad-name{font-size:12px;}
  .mad-desc{font-size:12px;}

  /* Tajwid table */
  .tajwid-table{font-size:12px;}
  .tajwid-table th,.tajwid-table td{padding:8px;}
  .color-dot{width:11px;height:11px;}

  /* Makhraj */
  .mk-item{padding:10px 12px;gap:8px;}
  .mk-arab{font-size:22px;}
  .mk-info{font-size:11px;}

  /* Quiz */
  .quiz-section{padding:16px 14px;}
  .quiz-title{font-size:15px;}
  .q-question{font-size:15px;}
  .q-arab{font-size:26px;}
  .q-opts{grid-template-columns:1fr;}
  .q-opt{padding:14px 13px;font-size:14px;}
  .btn-next{font-size:14px;padding:13px;width:100%;}
  .qr-score{font-size:50px;}
  .quiz-result-btns{flex-direction:column;gap:8px;}
  .btn-retry,.btn-nxt{width:100%;text-align:center;justify-content:center;}

  /* Lesson nav */
  .lesson-nav{flex-direction:column;gap:10px;align-items:stretch;margin-top:28px;}
  .btn-prev,.btn-nxt{width:100%;text-align:center;justify-content:center;padding:13px;}

  /* Floating button */
  .mob-bab-btn{display:flex;}
}

/* ═══════ PHONE ═══════ */
@media(max-width:480px){
  .content{padding:14px 12px 96px;}
  .bab-title{font-size:23px;}
  .lesson-card{padding:14px;}
  .huruf-grid{grid-template-columns:repeat(auto-fill,minmax(62px,1fr));gap:6px;}
  .h-arab{font-size:24px;}
  .harakat-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}
  .tajwid-table td,.tajwid-table th{padding:7px 6px;}
}

@media(max-width:380px){
  .nav-title{font-size:13px;}
  .bab-title{font-size:21px;}
  .huruf-grid{grid-template-columns:repeat(auto-fill,minmax(56px,1fr));}
  .h-arab{font-size:22px;}
  .q-opt{font-size:13px;padding:13px 11px;}
}


/* ═══════════════════════════════════════════════
   OVERRIDES & FIXES
   ═══════════════════════════════════════════════ */

/* Tartil app: full height inside tab */
#tab-tartil .app {
  min-height: 100%;
  height: 100%;
  overflow: hidden;
}
#tab-tartil .main {
  overflow-y: auto;
}

/* Dashboard .main override */
#tab-progress .main, #tab-ibadah .main {
  padding: 14px;
  max-width: 100%;
}

/* Tajwid sidebar di dalam tab */
#tab-panduan {
  display: none;
  flex-direction: row;
}
#tab-panduan.active { display: flex !important; }
#tab-panduan .sidebar {
  height: 100%;
  overflow-y: auto;
}
#tab-panduan #mainContent {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

/* Remove duplicate bg patterns */
#tab-progress .bg, #tab-ibadah .bg { display: none; }

/* Fix .nav in tajwid - hide (replaced by bottom nav) */
#tab-panduan .nav { display: none !important; }

</style>
</head>
<body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBNThPjH4qNq4k6g7As-svYz5CjyQbB3u4",
  authDomain: "tartilai-web.firebaseapp.com",
  projectId: "tartilai-web",
  storageBucket: "tartilai-web.firebasestorage.app",
  messagingSenderId: "747339905291",
  appId: "1:747339905291:web:2f1618d24dfb5761a6ca0e",
};

try {
  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const db       = getFirestore(app);
  const provider = new GoogleAuthProvider();

  window._fb = { auth, db, provider, signInWithPopup, signOut,
                 onAuthStateChanged, doc, getDoc, setDoc, updateDoc, serverTimestamp };

  // Auth listener dengan retry — menunggu window.onUserLoggedIn didefinisikan
  onAuthStateChanged(auth, user => {
    function tryDispatch(attempt) {
      if (user) {
        if (typeof window.onUserLoggedIn === 'function') {
          window._currentUser = user;
          window.onUserLoggedIn(user);
        } else if (attempt < 25) {
          setTimeout(() => tryDispatch(attempt + 1), 100);
        }
      } else {
        if (typeof window.onUserLoggedOut === 'function') {
          window._currentUser = null;
          window.onUserLoggedOut();
        } else if (attempt < 25) {
          setTimeout(() => tryDispatch(attempt + 1), 100);
        }
      }
    }
    tryDispatch(0);
  });
} catch(e) {
  console.warn('Firebase init failed:', e.message);
  window._fb = null;
}
</script>
<!-- ══════════════════════════════════════════ -->
<!-- LOGIN SCREEN + SETUP MODAL                 -->
<!-- ══════════════════════════════════════════ -->
<!-- MOBILE SURAH DRAWER -->
<div class="surah-drawer-overlay" id="surahOverlay" onclick="closeSurahDrawer()"></div>
<div class="surah-drawer" id="surahDrawer">
  <div class="sd-handle"></div>
  <div class="sd-head">
    <div class="sd-title">📖 Pilih Surah</div>
    <button class="sd-close" onclick="closeSurahDrawer()">✕</button>
  </div>
  <div class="sd-search">
    <input type="text" id="sdSearch" placeholder="Cari surah..." oninput="filterSurahDrawer(this.value)">
  </div>
  <div class="sd-list" id="sdList"></div>
</div>

<!-- FLOATING SURAH BUTTON (mobile only) -->
<button class="mob-surah-btn" onclick="openSurahDrawer()">
  <span id="mobSurahLabel">📖 Pilih Surah</span>
  <span>☰</span>
</button>

<!-- ============================================================ -->
<!-- LOGIN SCREEN -->
<!-- ============================================================ -->
<div id="loginScreen" style="
  position:fixed; inset:0; z-index:1000;
  background: linear-gradient(135deg, #0D2B2B 0%, #1A4040 50%, #0D2B2B 100%);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  font-family:'Poppins',sans-serif; direction:ltr;
">
  <!-- Pattern bg -->
  <div style="position:absolute; inset:0; background-image:url('data:image/svg+xml,%3Csvg width=60 height=60 viewBox=0 0 60 60 xmlns=http://www.w3.org/2000/svg%3E%3Cg fill=none%3E%3Cg fill=%23C9A227 fill-opacity=0.05%3E%3Cpath d=M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); opacity:0.6;"></div>

  <!-- Glow orbs -->
  <div style="position:absolute; width:400px; height:400px; border-radius:50%; background:radial-gradient(circle, rgba(201,162,39,0.12) 0%, transparent 70%); top:-100px; right:-100px; pointer-events:none;"></div>
  <div style="position:absolute; width:300px; height:300px; border-radius:50%; background:radial-gradient(circle, rgba(42,138,138,0.15) 0%, transparent 70%); bottom:-80px; left:-80px; pointer-events:none;"></div>

  <!-- Card -->
  <div style="
    position:relative; z-index:1;
    background: rgba(13,35,35,0.85); backdrop-filter:blur(20px);
    border:1px solid rgba(201,162,39,0.25); border-radius:24px;
    padding:48px 40px; max-width:400px; width:90%; text-align:center;
    box-shadow: 0 40px 80px rgba(0,0,0,0.5);
  ">
    <!-- Logo -->
    <div style="display:flex; align-items:center; justify-content:center; gap:14px; margin-bottom:8px;">
      <div style="
        width:56px; height:56px; border-radius:16px;
        background:linear-gradient(135deg,#C9A227,#8B6F15);
        display:flex; align-items:center; justify-content:center;
        font-family:'Amiri',serif; font-size:30px; color:white;
        box-shadow:0 8px 24px rgba(201,162,39,0.4);
      ">ت</div>
      <div>
        <div style="font-size:28px; font-weight:800; color:#FDF8EE; letter-spacing:-1px;">Tartil<span style="color:#C9A227;">AI</span></div>
        <div style="font-size:12px; color:rgba(253,248,238,0.45); margin-top:-2px;">Belajar Tartil Al-Qur'an</div>
      </div>
    </div>

    <!-- Arabic -->
    <div style="font-family:'Amiri',serif; font-size:22px; color:rgba(201,162,39,0.7); direction:rtl; margin:16px 0 28px; letter-spacing:1px;">
      وَرَتِّلِ ٱلْقُرْءَانَ تَرْتِيلًا
    </div>
    <div style="font-size:11px; color:rgba(253,248,238,0.4); margin-top:-22px; margin-bottom:28px; font-style:italic;">
      "dan bacalah Al-Qur'an dengan tartil" — QS. Al-Muzzammil: 4
    </div>

    <!-- Fitur badges -->
    <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:32px;">
      <span style="padding:4px 12px; background:rgba(201,162,39,0.1); border:1px solid rgba(201,162,39,0.25); border-radius:20px; font-size:11px; color:rgba(201,162,39,0.8);">📖 114 Surah Lengkap</span>
      <span style="padding:4px 12px; background:rgba(42,138,138,0.1); border:1px solid rgba(42,138,138,0.25); border-radius:20px; font-size:11px; color:rgba(42,200,200,0.8);">🎨 Warna Tajwid</span>
      <span style="padding:4px 12px; background:rgba(201,162,39,0.1); border:1px solid rgba(201,162,39,0.25); border-radius:20px; font-size:11px; color:rgba(201,162,39,0.8);">🎙 Latihan Rekam</span>
      <span style="padding:4px 12px; background:rgba(42,138,138,0.1); border:1px solid rgba(42,138,138,0.25); border-radius:20px; font-size:11px; color:rgba(42,200,200,0.8);">📊 Progress Tersimpan</span>
    </div>

    <!-- Login button -->
    <button id="btnLoginGoogle" onclick="loginWithGoogle()" style="
      width:100%; padding:14px 20px; border-radius:14px; border:none; cursor:pointer;
      background:white; color:#1a1a1a; font-size:15px; font-weight:600;
      font-family:'Poppins',sans-serif; display:flex; align-items:center; justify-content:center; gap:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.3); transition:all 0.2s; margin-bottom:12px;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 28px rgba(0,0,0,0.4)'"
       onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.3)'">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691 6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303a12.04 12.04 0 0 1-4.087 5.571l.003-.002 6.19 5.238C36.971 39.205 44 34 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
      Masuk dengan Google
    </button>

    <!-- Guest button -->
    <button onclick="loginAsGuest()" style="
      width:100%; padding:12px 20px; border-radius:14px; cursor:pointer;
      background:transparent; color:rgba(253,248,238,0.5); font-size:13px;
      font-family:'Poppins',sans-serif; border:1px solid rgba(253,248,238,0.12);
      transition:all 0.2s;
    " onmouseover="this.style.borderColor='rgba(253,248,238,0.3)'; this.style.color='rgba(253,248,238,0.8)'"
       onmouseout="this.style.borderColor='rgba(253,248,238,0.12)'; this.style.color='rgba(253,248,238,0.5)'">
      Lanjut sebagai Tamu (tanpa simpan progress)
    </button>

    <!-- Loading state -->
    <div id="loginLoading" style="display:none; margin-top:16px; color:rgba(253,248,238,0.5); font-size:13px;">
      <span style="animation: spin 1s linear infinite; display:inline-block; margin-right:8px;">⟳</span>
      Sedang masuk...
    </div>

    <div style="margin-top:24px; font-size:11px; color:rgba(253,248,238,0.3); line-height:1.6;">
      Dengan masuk, Anda menyetujui penggunaan data untuk menyimpan progress belajar Anda.
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- SETUP GUIDE MODAL (muncul jika Firebase belum dikonfigurasi) -->
<!-- ============================================================ -->
<div id="setupGuideModal" style="
  display:none; position:fixed; inset:0; z-index:2000;
  background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);
  align-items:center; justify-content:center; font-family:'Poppins',sans-serif;
">
  <div style="
    background:#0D2B2B; border:1px solid rgba(201,162,39,0.3); border-radius:20px;
    padding:32px; max-width:520px; width:92%; max-height:85vh; overflow-y:auto; direction:ltr;
  ">
    <div style="font-size:20px; font-weight:700; color:#C9A227; margin-bottom:6px;">⚙️ Setup Firebase Diperlukan</div>
    <div style="font-size:13px; color:rgba(253,248,238,0.6); margin-bottom:20px;">Ikuti langkah berikut untuk mengaktifkan login & penyimpanan data:</div>

    <div style="display:flex; flex-direction:column; gap:14px;">
      <!-- Step 1 -->
      <div style="background:rgba(201,162,39,0.06); border:1px solid rgba(201,162,39,0.2); border-radius:12px; padding:16px;">
        <div style="font-size:13px; font-weight:700; color:#C9A227; margin-bottom:8px;">① Buat Project Firebase</div>
        <div style="font-size:12px; color:rgba(253,248,238,0.7); line-height:1.7;">
          Buka <a href="https://console.firebase.google.com" target="_blank" style="color:#5DADE2;">console.firebase.google.com</a>
          → <b>Add Project</b> → beri nama (mis: <code style="background:rgba(255,255,255,0.1); padding:1px 5px; border-radius:4px;">tartil-app</code>) → Continue → Create Project
        </div>
      </div>

      <!-- Step 2 -->
      <div style="background:rgba(201,162,39,0.06); border:1px solid rgba(201,162,39,0.2); border-radius:12px; padding:16px;">
        <div style="font-size:13px; font-weight:700; color:#C9A227; margin-bottom:8px;">② Daftarkan Web App & Salin Config</div>
        <div style="font-size:12px; color:rgba(253,248,238,0.7); line-height:1.7;">
          Project Overview → klik ikon <b>&lt;/&gt;</b> (Web) → Register app → Salin <code>firebaseConfig</code>
          → Tempel di bagian <code>firebaseConfig</code> di file HTML ini (baris ~15)
        </div>
      </div>

      <!-- Step 3 -->
      <div style="background:rgba(201,162,39,0.06); border:1px solid rgba(201,162,39,0.2); border-radius:12px; padding:16px;">
        <div style="font-size:13px; font-weight:700; color:#C9A227; margin-bottom:8px;">③ Aktifkan Google Sign-In</div>
        <div style="font-size:12px; color:rgba(253,248,238,0.7); line-height:1.7;">
          Build → <b>Authentication</b> → Get Started → Sign-in method → <b>Google</b> → Enable → Save
        </div>
      </div>

      <!-- Step 4 -->
      <div style="background:rgba(201,162,39,0.06); border:1px solid rgba(201,162,39,0.2); border-radius:12px; padding:16px;">
        <div style="font-size:13px; font-weight:700; color:#C9A227; margin-bottom:8px;">④ Aktifkan Firestore Database</div>
        <div style="font-size:12px; color:rgba(253,248,238,0.7); line-height:1.7;">
          Build → <b>Firestore Database</b> → Create database → <b>Start in test mode</b> → Choose region → Enable
        </div>
      </div>

      <!-- Step 5 -->
      <div style="background:rgba(42,138,138,0.08); border:1px solid rgba(42,138,138,0.3); border-radius:12px; padding:16px;">
        <div style="font-size:13px; font-weight:700; color:#2ABABA; margin-bottom:8px;">⑤ Atur Firestore Rules (opsional tapi dianjurkan)</div>
        <div style="font-size:12px; color:rgba(253,248,238,0.7); line-height:1.7; margin-bottom:8px;">
          Firestore → Rules → ganti dengan:
        </div>
        <pre style="background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; font-size:11px; color:#82E0AA; overflow-x:auto; white-space:pre-wrap;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }
  }
}</pre>
      </div>
    </div>

    <button onclick="document.getElementById('setupGuideModal').style.display='none'" style="
      margin-top:20px; width:100%; padding:12px; border-radius:12px; border:none;
      background:linear-gradient(135deg,#C9A227,#8B6F15); color:#0D2B2B;
      font-size:14px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;
    ">Mengerti, Tutup Panduan</button>
  </div>
</div>



<!-- ══════════════════════════════════════════ -->
<!-- SPA ROOT                                   -->
<!-- ══════════════════════════════════════════ -->
<div id="spa-root" style="display:none;">

  <!-- ── SPA BODY (tab content) ── -->
  <div id="spa-body">

    <!-- ════════════════════════════
         TAB 1: TARTIL (Baca & Rekam)
         ════════════════════════════ -->
    <div class="spa-tab active" id="tab-tartil">
<div class="app">
  <!-- HEADER -->
  <header>
    <div class="logo">
      
      
      <div class="logo-icon">ت</div>
      <div class="logo-text">Tartil<span class="logo-ai">AI</span></div>
    </div>
    <div class="header-right">
      <div class="user-score-badge">⭐ <span id="totalScore">0</span><span class="score-text"> Total Skor</span></div>
      <div id="userInfo" style="display:none;align-items:center;gap:6px;">
        <img id="userAvatar" src="" alt="" style="width:30px;height:30px;border-radius:50%;border:2px solid rgba(201,162,39,0.5);object-fit:cover;">
        <span id="userName" style="font-size:12px;color:rgba(253,248,238,0.8);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
        <button onclick="doSignOut()" title="Keluar" style="background:rgba(192,57,43,0.2);border:1px solid rgba(192,57,43,0.4);border-radius:8px;color:#E74C3C;font-size:11px;cursor:pointer;padding:4px 8px;font-family:'Poppins',sans-serif;">⏏</button>
      </div>
      <div class="lang-badge">🇮🇩 ID</div>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <input class="search-box" type="text" placeholder="🔍 Cari surah..." id="searchInput" oninput="filterSurah(this.value)">
    </div>
    <div class="surah-list" id="surahList"></div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Surah Header -->
    <div class="surah-header">
      <div class="surah-title-area">
        <div>
          <div class="surah-arabic-title" id="surahArabicTitle">الفاتحة</div>
          <div class="surah-latin-title" id="surahLatinTitle">Al-Fatihah</div>
          <div class="surah-sub" id="surahSub">Makkiyah · 7 Ayat · Surah ke-1</div>
        </div>
        <div class="score-display">
          <div class="score-circle" id="scoreCircle" style="--score-pct: 0%">
            <div class="score-num" id="surahScoreNum">-</div>
          </div>
          <div class="score-label">Skor Surah</div>
        </div>
      </div>
      <div class="ayat-progress">
        <div class="ayat-progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('baca', this)">📖 Baca & Latihan</div>
      <div class="tab" onclick="switchTab('dengar', this)">🎧 Dengar Qori</div>
      <div class="tab" onclick="switchTab('tajwid', this)">📚 Panduan Tajwid</div>
      <div class="tab" onclick="switchTab('skor', this)">📊 Skor & Progress</div>
    </div>

    <!-- Content -->
    <div class="content-area">

      <!-- TAB BACA -->
      <div class="tab-content active" id="tab-baca">
        <div class="bismillah" id="bismillahDisplay">
          بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
        </div>
        <div class="ayat-container" id="ayatContainer"></div>
      </div>

      <!-- TAB DENGAR -->
      <div class="tab-content" id="tab-dengar">
        <div style="padding: 8px 0 20px">
          <div class="section-title">Pilih Qori</div>
          <div class="qori-list" id="qoriList"></div>
        </div>
        <div style="background: rgba(201,162,39,0.06); border: 1px solid rgba(201,162,39,0.2); border-radius: 14px; padding: 20px; margin-bottom: 16px;">
          <div style="font-size: 13px; color: rgba(253,248,238,0.7); margin-bottom: 8px;">Sumber audio gratis dari EveryAyah.com & MP3Quran.net</div>
          <div style="display: flex; flex-direction: column; gap: 10px;" id="audioPlayerArea">
            <div style="color: var(--gold); font-family: 'Amiri', serif; font-size: 22px; text-align: right; direction: rtl; margin-bottom: 8px;" id="currentAyahDisplay">—</div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <button class="btn-play" id="mainPlayBtn" onclick="toggleMainPlay()">▶</button>
              <div style="flex:1;">
                <div style="height: 4px; background: rgba(201,162,39,0.15); border-radius: 2px; margin-bottom: 6px; position:relative; cursor:pointer;" id="audioProgress" onclick="seekAudio(event)">
                  <div style="height:100%; width:0%; background: var(--gold); border-radius: 2px; transition: width 0.5s;" id="audioBar"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:11px; color:rgba(253,248,238,0.4);">
                  <span id="timeNow">0:00</span>
                  <span id="timeTotal">0:00</span>
                </div>
              </div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button onclick="prevAyahAudio()" style="padding: 6px 14px; background: rgba(201,162,39,0.1); border: 1px solid rgba(201,162,39,0.2); color: var(--gold); border-radius: 8px; cursor:pointer; font-size:12px;">⬅ Prev</button>
              <button onclick="nextAyahAudio()" style="padding: 6px 14px; background: rgba(201,162,39,0.1); border: 1px solid rgba(201,162,39,0.2); color: var(--gold); border-radius: 8px; cursor:pointer; font-size:12px;">Next ➡</button>
              <button onclick="repeatAyah()" style="padding: 6px 14px; background: rgba(201,162,39,0.1); border: 1px solid rgba(201,162,39,0.2); color: var(--gold); border-radius: 8px; cursor:pointer; font-size:12px;">🔁 Ulang</button>
            </div>
          </div>
          <audio id="mainAudio" onended="audioEnded()" ontimeupdate="updateAudioProgress()" onloadedmetadata="audioLoaded()"></audio>
        </div>
        <div style="background: rgba(42,138,138,0.08); border: 1px solid rgba(42,138,138,0.2); border-radius: 14px; padding: 16px;">
          <div class="section-title">Daftar Ayat</div>
          <div id="ayatListDengar" style="display:flex; flex-direction:column; gap:6px;"></div>
        </div>
      </div>

      <!-- TAB TAJWID -->
      <div class="tab-content" id="tab-tajwid">
        <div style="margin-bottom: 20px;">
          <div class="section-title">Kode Warna Tajwid — Ketuk kata Arab untuk detail</div>
          <div class="tajwid-legend" id="tajwidLegend"></div>
        </div>
        <div id="tajwidGuideContent" style="display:flex; flex-direction:column; gap:12px;"></div>
      </div>

      <!-- TAB SKOR -->
      <div class="tab-content" id="tab-skor">
        <div id="scoreSummary"></div>
      </div>

    </div><!-- end content-area -->

    <!-- RECORDING PANEL -->
    <div class="recording-panel">
      <div class="rec-status">
        <div class="rec-label">Mode Latihan Tartil</div>
        <div class="rec-indicator">
          <div class="rec-dot" id="recDot"></div>
          <span id="recText">Tap ayat untuk memilih, lalu rekam</span>
        </div>
      </div>
      <div class="waveform" id="waveform">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
      </div>
      <button class="btn-rec" id="recBtn" onclick="toggleRecording()">🎙</button>
      <button class="btn-play" onclick="playCurrentAyah()" title="Dengarkan ayat ini dari qori">🎧</button>
    </div>
  </main>
</div>

<!-- FEEDBACK TOAST -->
<div class="feedback-toast" id="feedbackToast">
  <div class="toast-title">
    <span class="toast-icon" id="toastIcon">⚠️</span>
    <span id="toastTitle">Kesalahan Tajwid</span>
  </div>
  <div class="toast-body" id="toastBody"></div>
</div>

<!-- SCORE MODAL -->
<div class="modal-overlay" id="scoreModal" onclick="closeModal()">
  <div class="score-modal" onclick="event.stopPropagation()">
    <div style="font-size:16px; color: rgba(253,248,238,0.6);">Hasil Latihan</div>
    <div class="final-score" id="modalScore">85</div>
    <div class="stars" id="modalStars">⭐⭐⭐</div>
    <div class="modal-title" id="modalTitle">Bagus Sekali!</div>
    <div class="modal-sub" id="modalSub">Surah Al-Fatihah · Ayat 1-7</div>
    <div class="mistakes-list" id="mistakesList"></div>
    <button class="btn-primary" onclick="closeModal()">Lanjutkan ➤</button>
  </div>
</div>
    </div><!-- /tab-tartil -->

    <!-- ════════════════════════════
         TAB 2: PANDUAN TAJWID
         ════════════════════════════ -->
    <div class="spa-tab" id="tab-panduan">
<div class="bg"></div>

<!-- MOBILE BAB DRAWER -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="babDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <div class="drawer-title">📚 Pilih Bab</div>
    <button class="drawer-close" onclick="closeDrawer()">✕</button>
  </div>
  <div class="drawer-body" id="drawerBabList"></div>
</div>

<!-- FLOATING BUTTON (mobile only) -->
<button class="mob-bab-btn" onclick="openDrawer()">
  📚 Pilih Bab <span id="mobBabIndicator"></span>
</button>

<!-- NAV -->


<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-label">Progress Belajar</div>
      <div class="overall-prog">
        <div class="op-num" id="overallPct">0%</div>
        <div class="op-lbl">Bab Selesai</div>
        <div class="op-bar"><div class="op-fill" id="overallBar" style="width:0%"></div></div>
      </div>
    </div>
    <div id="babList"></div>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="mainContent">
    <!-- Diisi oleh JS -->
  </main>
</div>
    </div><!-- /tab-panduan -->

    <!-- ════════════════════════════
         TAB 3: PROGRESS (Stats, Badges, Hafalan)
         ════════════════════════════ -->
    <div class="spa-tab" id="tab-progress">
      <div class="bg"></div>
<div class="bg"></div>

<!-- MOBILE MENU OVERLAY -->
<div class="mobile-menu" id="mobileMenu">
  <button class="mm-close" onclick="closeMobileMenu()">✕</button>
  <div class="mm-links">
    <a class="mm-link" href="index.html">🏠 Portal</a>
    <a class="mm-link active" href="dashboard.html">📊 Dashboard</a>
    <a class="mm-link" href="tajwid.html">📚 Belajar Tajwid</a>
    <a class="mm-link" href="tartil-quran.html">🎙 Tartil Al-Qur'an</a>
  </div>
</div>

<!-- NAV -->


<!-- SHALAT BAR -->
<div class="shalat-bar" id="shalatBar">
  <div class="shalat-next">
    <div>
      <button id="shalatCity" onclick="bukaModalLokasi()" style="background:none;border:none;padding:0;cursor:pointer;font-size:11px;color:rgba(253,246,232,0.4);font-family:inherit;text-align:left;">📍 Klik untuk set lokasi</button>
      <div style="display:flex;align-items:baseline;gap:8px;margin-top:2px;">
        <span class="shalat-next-name" id="shalatNextName">—</span>
        <span class="shalat-countdown" id="shalatCountdown">--:--:--</span>
      </div>
    </div>
  </div>
  <div class="shalat-times" id="shalatTimes"></div>
  <button class="btn-kiblat" onclick="openKiblat()">🕌 Kiblat</button>
</div>

<!-- lokasiModal dipindah ke spa-root level -->


<!-- kiblatOverlay dipindah ke spa-root level -->


<!-- BADGE UNLOCK TOAST -->
<div class="badge-unlock-toast" id="badgeUnlockToast" style="display:none;">
  <div class="badge-unlock-ico" id="badgeUnlockIco">🏆</div>
  <div>
    <div class="badge-unlock-text" id="badgeUnlockText">Lencana Baru!</div>
    <div class="badge-unlock-sub" id="badgeUnlockSub">Kamu baru saja membuka pencapaian baru</div>
  </div>
</div>

<!-- NOTIFICATION BANNER -->
<div class="notif-banner" id="notifBanner">
  <button class="notif-close" onclick="closeNotif()">✕</button>
  <div class="notif-title" id="notifTitle">🔔 Pengingat</div>
  <div class="notif-msg" id="notifMsg">Waktunya review hafalan Anda hari ini!</div>
</div>

<!-- SR REVIEW MODAL -->
<div class="modal-overlay" id="reviewModal">
  <div class="modal-card">
    <div class="modal-surah" id="revSurah"></div>
    <div class="modal-arab" id="revArab"></div>
    <div class="modal-trans" id="revTrans"></div>
    <div id="revPhase1">
      <div class="modal-question">Dapatkah Anda mengingat ayat ini?</div>
      <div class="modal-hidden" id="revHidden">● ● ● ● ●</div>
      <button class="btn-reveal" onclick="revealAyah()">👁 Tampilkan Ayat</button>
    </div>
    <div id="revPhase2" style="display:none;">
      <div class="modal-question">Seberapa baik ingatan Anda?</div>
      <div class="sr-buttons">
        <button class="sr-grade-btn grade-0" onclick="gradeCard(0)">😶 Lupa Total<span>Ulang dari awal</span></button>
        <button class="sr-grade-btn grade-1" onclick="gradeCard(1)">😕 Hampir<span>Perlu latihan</span></button>
        <button class="sr-grade-btn grade-2" onclick="gradeCard(2)">🙂 Ingat<span>Dengan usaha</span></button>
        <button class="sr-grade-btn grade-3" onclick="gradeCard(3)">😄 Mudah!<span>Hafal sempurna</span></button>
      </div>
    </div>
    <button style="margin-top:20px;padding:8px 20px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(253,246,232,0.4);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;" onclick="closeReviewModal()">Tutup</button>
  </div>
</div>

<!-- ADD HAFALAN MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal-card add-modal" style="text-align:left;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div style="font-size:18px;font-weight:700;color:var(--gold);">+ Tambah Hafalan</div>
      <button onclick="closeAddModal()" style="background:rgba(255,255,255,0.07);border:none;border-radius:8px;width:30px;height:30px;color:rgba(253,246,232,0.5);cursor:pointer;font-size:14px;">✕</button>
    </div>
    <div style="font-size:13px;color:rgba(253,246,232,0.5);margin-bottom:16px;">Pilih surah dan ayat yang ingin Anda hafalkan. Sistem akan mengingatkan Anda sesuai jadwal optimal.</div>
    <select class="surah-select" id="addSurah" onchange="updateAyatPreview()">
      <option value="">-- Pilih Surah --</option>
    </select>
    <div class="ayat-input">
      <input type="number" id="addAyatFrom" placeholder="Ayat dari" min="1" oninput="updateAyatPreview()">
      <input type="number" id="addAyatTo"   placeholder="s/d ayat" min="1" oninput="updateAyatPreview()">
    </div>
    <div class="ayat-preview" id="ayatPreview" style="color:rgba(253,246,232,0.3);font-family:'DM Sans',sans-serif;font-size:13px;text-align:center;direction:ltr;">
      Pilih surah dan nomor ayat
    </div>
    <button class="btn-add-hafalan" onclick="confirmAddHafalan()">✚ Tambahkan ke Jadwal Hafalan</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- STREAK HERO -->
  <div class="streak-hero">
    <div class="sh-content">
      <div class="sh-flame">🔥</div>
      <div class="sh-text">
        <div class="sh-streak-num" id="streakNum">0</div>
        <div class="sh-streak-lbl">hari streak berturut-turut</div>
        <div class="sh-streak-best" id="streakBest">Terbaik: 0 hari</div>
      </div>
      <div class="sh-divider"></div>
      <div class="sh-stats">
        <div class="sh-stat">
          <div class="sh-stat-n" id="totalDays">0</div>
          <div class="sh-stat-l">Total Hari Aktif</div>
        </div>
        <div class="sh-stat">
          <div class="sh-stat-n" id="totalAyat">0</div>
          <div class="sh-stat-l">Ayat Direkam</div>
        </div>
        <div class="sh-stat">
          <div class="sh-stat-n" id="totalMenit">0</div>
          <div class="sh-stat-l">Menit Belajar</div>
        </div>
        <div class="sh-stat">
          <div class="sh-stat-n" id="srCardCount">0</div>
          <div class="sh-stat-l">Kartu Hafalan</div>
        </div>
      </div>
      <div class="sh-today">
        <div class="sh-today-label">Target Hari Ini</div>
        <div class="sh-today-goals" id="todayGoals">
          <!-- Diisi JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">📅 Aktivitas Belajar</div>
      <div class="sec-action" onclick="simulateActivity()">+ Simulasi data</div>
    </div>
    <div class="heatmap-card">
      <div class="heatmap-months" id="heatmapMonths"></div>
      <div class="heatmap-wrap">
        <div class="hm-days-label">
          <div class="hm-day-lbl"></div>
          <div class="hm-day-lbl">Sen</div>
          <div class="hm-day-lbl"></div>
          <div class="hm-day-lbl">Rab</div>
          <div class="hm-day-lbl"></div>
          <div class="hm-day-lbl">Jum</div>
          <div class="hm-day-lbl"></div>
        </div>
        <div class="heatmap-grid" id="heatmapGrid"></div>
      </div>
      <div class="hm-legend">
        <span class="hm-legend-lbl">Kurang</span>
        <div class="hm-legend-cell" style="background:rgba(201,162,39,0.1)"></div>
        <div class="hm-legend-cell" style="background:rgba(201,162,39,0.3)"></div>
        <div class="hm-legend-cell" style="background:rgba(201,162,39,0.55)"></div>
        <div class="hm-legend-cell" style="background:rgba(201,162,39,0.8)"></div>
        <div class="hm-legend-cell" style="background:#C9A227"></div>
        <span class="hm-legend-lbl">Banyak</span>
      </div>
    </div>
  </div>

  <!-- GRID: Spaced Rep + Goals -->
  <div class="grid2">

    <!-- SPACED REPETITION -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">🧠 Hafalan Hari Ini</div>
        <div class="sec-action" id="srDueCount"></div>
      </div>
      <div class="card">
        <div id="srQueue">
          <div style="text-align:center;padding:32px 20px;color:rgba(253,246,232,0.3);">
            <div style="font-size:36px;margin-bottom:12px;">📖</div>
            <div style="font-size:13px;">Belum ada kartu hafalan.<br>Tambahkan ayat untuk mulai menghafal!</div>
          </div>
        </div>
        <button class="add-hafalan-btn" onclick="openAddModal()">＋ Tambah Ayat untuk Dihafal</button>
      </div>
    </div>

    <!-- GOALS -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">🎯 Target Harian</div>
      </div>
      <div class="card">
        <div class="goal-editor">
          <div class="goal-row">
            <div class="goal-ico">📖</div>
            <div class="goal-info">
              <div class="goal-name">Ayat Tartil</div>
              <div class="goal-sub">Rekam & latih bacaan</div>
            </div>
            <input class="goal-input" type="number" id="gAyat" value="5" min="1" max="50">
            <span class="goal-unit">ayat</span>
          </div>
          <div class="goal-row">
            <div class="goal-ico">🧠</div>
            <div class="goal-info">
              <div class="goal-name">Review Hafalan</div>
              <div class="goal-sub">Kartu spaced repetition</div>
            </div>
            <input class="goal-input" type="number" id="gHafalan" value="10" min="1" max="50">
            <span class="goal-unit">kartu</span>
          </div>
          <div class="goal-row">
            <div class="goal-ico">⏱️</div>
            <div class="goal-info">
              <div class="goal-name">Durasi Belajar</div>
              <div class="goal-sub">Total waktu aktif</div>
            </div>
            <input class="goal-input" type="number" id="gMenit" value="15" min="5" max="120">
            <span class="goal-unit">menit</span>
          </div>
          <div class="goal-row">
            <div class="goal-ico">📚</div>
            <div class="goal-info">
              <div class="goal-name">Bab Tajwid</div>
              <div class="goal-sub">Materi atau quiz</div>
            </div>
            <input class="goal-input" type="number" id="gBab" value="1" min="0" max="7">
            <span class="goal-unit">bab</span>
          </div>
          <button class="btn-save-goal" onclick="saveGoals()">💾 Simpan Target</button>
        </div>
      </div>
    </div>

  </div>

  <!-- CHART STATISTIK (Chart.js) -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">📊 Statistik Bacaan</div>
    </div>
    <div class="card">
      <div class="chart-tabs">
        <button class="chart-tab active" onclick="switchChart('ayat',this)">Ayat</button>
        <button class="chart-tab" onclick="switchChart('menit',this)">Menit</button>
        <button class="chart-tab" onclick="switchChart('skor',this)">Skor</button>
        <button class="chart-tab" onclick="switchChart('30d',this)">30 Hari</button>
      </div>
      <div class="chartjs-wrap">
        <canvas id="mainChart"></canvas>
      </div>
      <div class="chart-stat-row">
        <div class="chart-stat">
          <div class="chart-stat-n" id="cst-rataAyat">—</div>
          <div class="chart-stat-l">Rata-rata Ayat/Hari</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-n" id="cst-bestDay">—</div>
          <div class="chart-stat-l">Hari Terbaik</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-n" id="cst-totalSkor">—</div>
          <div class="chart-stat-l">Total Skor</div>
        </div>
      </div>
    </div>
  </div>

  <!-- GRID: Badge + Leaderboard -->
  <div class="grid2">

    <!-- BADGES LENGKAP -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">🏅 Lencana Pencapaian</div>
        <div style="font-size:11px;color:rgba(253,246,232,0.35);" id="badgeCount">0 / 0 terbuka</div>
      </div>
      <div class="card">
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">🏆 Papan Peringkat</div>
        <div style="font-size:11px;color:rgba(253,246,232,0.35);">Global · Diperbarui tiap jam</div>
      </div>
      <div class="card">
        <div class="lb-tabs">
          <button class="lb-tab active" onclick="switchLB('istiqomah',this)">🔥 Istiqomah</button>
          <button class="lb-tab" onclick="switchLB('minggu',this)">📅 Minggu Ini</button>
          <button class="lb-tab" onclick="switchLB('hafidz',this)">🧠 Hafidz</button>
        </div>
        <div style="font-size:11px;color:rgba(253,246,232,0.3);margin-bottom:12px;line-height:1.5;">
          Nama disamarkan · Berlomba dalam kebaikan, bukan prestasi duniawi
        </div>
        <div id="leaderboardList"></div>
        <div style="font-size:11px;color:rgba(253,246,232,0.25);text-align:center;margin-top:12px;line-height:1.6;">
          Data leaderboard real-time memerlukan Firebase.<br>Tampilan saat ini menggunakan data demo.
        </div>
      </div>
    </div>

  </div>

  <!-- NOTIFICATION SETTINGS -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">🔔 Pengingat Belajar</div>
    </div>
    <div class="card">
      <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
        <div style="flex:1;">
          <div style="font-size:14px;font-weight:600;color:var(--cream);margin-bottom:6px;">Aktifkan notifikasi browser</div>
          <div style="font-size:13px;color:rgba(253,246,232,0.45);line-height:1.6;">TartilAI akan mengingatkan Anda saat ada kartu hafalan yang jatuh tempo atau target harian belum tercapai.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;flex-shrink:0;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:13px;color:rgba(253,246,232,0.5);">Jam pengingat:</span>
            <input type="time" id="reminderTime" value="07:00" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--cream);font-family:'DM Sans',sans-serif;font-size:13px;">
          </div>
          <button onclick="requestNotifPermission()" id="btnNotif" style="padding:10px 20px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:13px;font-weight:700;font-family:'DM Sans',sans-serif;">🔔 Aktifkan Pengingat & Notif Shalat</button>
          <div id="notifStatus" style="font-size:11px;color:rgba(253,246,232,0.35);text-align:center;"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    </div><!-- /tab-progress -->

    <!-- ════════════════════════════
         TAB 4: IBADAH (Shalat + Kiblat)
         Konten shalat sudah di dalam dash_html (shalatBar, kiblat overlay, dll)
         Tab ini hanya tampilkan ulang dengan scroll ke shalat area
         ════════════════════════════ -->
    <div class="spa-tab" id="tab-ibadah">
      <div class="bg"></div>
      <!-- Shalat bar -->
      <div id="ibadah-shalat-container" style="padding:16px;">
        <div style="font-size:18px;font-weight:700;color:#C9A227;margin-bottom:16px;">🕌 Waktu Shalat & Kiblat</div>
        <!-- Content diisi oleh JS dari renderIbadahTab() -->
        <div id="ibadah-content"></div>
      </div>
    </div><!-- /tab-ibadah -->

  
<!-- ══════════════════════════════════════════
     GLOBAL MODALS (position:fixed - accessible dari semua tab)
     ══════════════════════════════════════════ -->

<!-- MODAL LOKASI SHALAT -->
<div id="lokasiModal" onclick="if(event.target===this)tutupModalLokasi()" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
  <div style="background:#0D2E2E;border:1px solid rgba(201,162,39,0.35);border-radius:20px;padding:28px 24px;width:90%;max-width:380px;box-shadow:0 24px 60px rgba(0,0,0,0.7);position:relative;">
    <div style="font-size:17px;font-weight:700;color:#C9A227;margin-bottom:6px;">📍 Atur Lokasi Sholat</div>
    <div style="font-size:12px;color:rgba(253,246,232,0.45);margin-bottom:18px;">Pilih cara menentukan lokasi Anda</div>
    <button id="btnGPS" onclick="mintaLokasi()" style="width:100%;padding:13px;border-radius:12px;border:none;background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:12px;">📍 Deteksi Otomatis (GPS)</button>
    <div style="font-size:11px;color:rgba(253,246,232,0.3);text-align:center;margin-bottom:10px;">— atau pilih kota —</div>
    <div id="kotaGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;max-height:200px;overflow-y:auto;padding-right:2px;"></div>
    <button id="btnTutupLokasi" onclick="tutupModalLokasi()" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:transparent;color:rgba(253,246,232,0.45);font-size:13px;cursor:pointer;font-family:inherit;margin-top:12px;">Tutup</button>
  </div>
</div>

<!-- MODAL KIBLAT -->
<div class="kiblat-overlay" id="kiblatOverlay" onclick="closeKiblat()">
  <div class="kiblat-card" onclick="event.stopPropagation()">
    <div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:4px;">🕌 Arah Kiblat</div>
    <div style="font-size:12px;color:rgba(253,246,232,0.45);margin-bottom:20px;" id="kiblatDesc">Menghitung arah kiblat...</div>
    <div class="kiblat-compass">
      <div class="kiblat-compass-ring" id="compassRing">
        <div class="kiblat-labels">
          <div class="kiblat-n">U</div>
          <div class="kiblat-s">S</div>
          <div class="kiblat-e">T</div>
          <div class="kiblat-w">B</div>
        </div>
        <div class="kiblat-needle" id="kiblatNeedle"></div>
        <div class="kiblat-center"></div>
        <div class="kiblat-kaabah">🕋</div>
      </div>
    </div>
    <div style="font-size:13px;color:rgba(253,246,232,0.5);margin-bottom:20px;" id="kiblatAngle">—</div>
    <div id="kiblatCompassStatus" style="font-size:12px;color:rgba(253,246,232,0.4);margin-bottom:16px;"></div>
    <button onclick="closeKiblat()" style="padding:10px 24px;border-radius:10px;border:none;
      background:linear-gradient(135deg,#C9A227,#8B6F15);color:#0D2B2B;
      font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">Tutup</button>
  </div>
</div>



</div><!-- /spa-body -->

  <!-- ── BOTTOM NAVIGATION ── -->
  <nav id="bottom-nav">
    <button class="bnav-btn active" id="bnav-tartil" onclick="spaSwitch('tartil')">
      <span class="bnav-icon">🎙</span>
      <span class="bnav-label">Tartil</span>
    </button>
    <button class="bnav-btn" id="bnav-panduan" onclick="spaSwitch('panduan')">
      <span class="bnav-icon">📚</span>
      <span class="bnav-label">Panduan</span>
    </button>
    <button class="bnav-btn" id="bnav-progress" onclick="spaSwitch('progress')">
      <span class="bnav-icon">📊</span>
      <span class="bnav-label">Progress</span>
    </button>
    <button class="bnav-btn" id="bnav-ibadah" onclick="spaSwitch('ibadah')">
      <span class="bnav-icon">🕌</span>
      <span class="bnav-label">Ibadah</span>
    </button>
  </nav>

</div><!-- /spa-root -->

<script>
/* ════════════════════════════════════════════
   TARTIL JS (core - rekam, analisis, TTS, surah)
   ════════════════════════════════════════════ */

// ===================================
// DATA SURAH (114 Surah)
// ===================================
const SURAHS = [
  {id:1, name:"Al-Fatihah", arabic:"الفاتحة", type:"Makkiyah", ayat:7},
  {id:2, name:"Al-Baqarah", arabic:"البقرة", type:"Madaniyah", ayat:286},
  {id:3, name:"Ali 'Imran", arabic:"آل عمران", type:"Madaniyah", ayat:200},
  {id:4, name:"An-Nisa'", arabic:"النساء", type:"Madaniyah", ayat:176},
  {id:5, name:"Al-Ma'idah", arabic:"المائدة", type:"Madaniyah", ayat:120},
  {id:6, name:"Al-An'am", arabic:"الأنعام", type:"Makkiyah", ayat:165},
  {id:7, name:"Al-A'raf", arabic:"الأعراف", type:"Makkiyah", ayat:206},
  {id:8, name:"Al-Anfal", arabic:"الأنفال", type:"Madaniyah", ayat:75},
  {id:9, name:"At-Taubah", arabic:"التوبة", type:"Madaniyah", ayat:129},
  {id:10, name:"Yunus", arabic:"يونس", type:"Makkiyah", ayat:109},
  {id:11, name:"Hud", arabic:"هود", type:"Makkiyah", ayat:123},
  {id:12, name:"Yusuf", arabic:"يوسف", type:"Makkiyah", ayat:111},
  {id:13, name:"Ar-Ra'd", arabic:"الرعد", type:"Madaniyah", ayat:43},
  {id:14, name:"Ibrahim", arabic:"إبراهيم", type:"Makkiyah", ayat:52},
  {id:15, name:"Al-Hijr", arabic:"الحجر", type:"Makkiyah", ayat:99},
  {id:16, name:"An-Nahl", arabic:"النحل", type:"Makkiyah", ayat:128},
  {id:17, name:"Al-Isra'", arabic:"الإسراء", type:"Makkiyah", ayat:111},
  {id:18, name:"Al-Kahf", arabic:"الكهف", type:"Makkiyah", ayat:110},
  {id:19, name:"Maryam", arabic:"مريم", type:"Makkiyah", ayat:98},
  {id:20, name:"Ta Ha", arabic:"طه", type:"Makkiyah", ayat:135},
  {id:21, name:"Al-Anbiya'", arabic:"الأنبياء", type:"Makkiyah", ayat:112},
  {id:22, name:"Al-Hajj", arabic:"الحج", type:"Madaniyah", ayat:78},
  {id:23, name:"Al-Mu'minun", arabic:"المؤمنون", type:"Makkiyah", ayat:118},
  {id:24, name:"An-Nur", arabic:"النور", type:"Madaniyah", ayat:64},
  {id:25, name:"Al-Furqan", arabic:"الفرقان", type:"Makkiyah", ayat:77},
  {id:26, name:"Asy-Syu'ara'", arabic:"الشعراء", type:"Makkiyah", ayat:227},
  {id:27, name:"An-Naml", arabic:"النمل", type:"Makkiyah", ayat:93},
  {id:28, name:"Al-Qasas", arabic:"القصص", type:"Makkiyah", ayat:88},
  {id:29, name:"Al-'Ankabut", arabic:"العنكبوت", type:"Makkiyah", ayat:69},
  {id:30, name:"Ar-Rum", arabic:"الروم", type:"Makkiyah", ayat:60},
  {id:31, name:"Luqman", arabic:"لقمان", type:"Makkiyah", ayat:34},
  {id:32, name:"As-Sajdah", arabic:"السجدة", type:"Makkiyah", ayat:30},
  {id:33, name:"Al-Ahzab", arabic:"الأحزاب", type:"Madaniyah", ayat:73},
  {id:34, name:"Saba'", arabic:"سبأ", type:"Makkiyah", ayat:54},
  {id:35, name:"Fatir", arabic:"فاطر", type:"Makkiyah", ayat:45},
  {id:36, name:"Ya Sin", arabic:"يس", type:"Makkiyah", ayat:83},
  {id:37, name:"As-Saffat", arabic:"الصافات", type:"Makkiyah", ayat:182},
  {id:38, name:"Sad", arabic:"ص", type:"Makkiyah", ayat:88},
  {id:39, name:"Az-Zumar", arabic:"الزمر", type:"Makkiyah", ayat:75},
  {id:40, name:"Gafir", arabic:"غافر", type:"Makkiyah", ayat:85},
  {id:41, name:"Fussilat", arabic:"فصلت", type:"Makkiyah", ayat:54},
  {id:42, name:"Asy-Syura", arabic:"الشورى", type:"Makkiyah", ayat:53},
  {id:43, name:"Az-Zukhruf", arabic:"الزخرف", type:"Makkiyah", ayat:89},
  {id:44, name:"Ad-Dukhan", arabic:"الدخان", type:"Makkiyah", ayat:59},
  {id:45, name:"Al-Jasiyah", arabic:"الجاثية", type:"Makkiyah", ayat:37},
  {id:46, name:"Al-Ahqaf", arabic:"الأحقاف", type:"Makkiyah", ayat:35},
  {id:47, name:"Muhammad", arabic:"محمد", type:"Madaniyah", ayat:38},
  {id:48, name:"Al-Fath", arabic:"الفتح", type:"Madaniyah", ayat:29},
  {id:49, name:"Al-Hujurat", arabic:"الحجرات", type:"Madaniyah", ayat:18},
  {id:50, name:"Qaf", arabic:"ق", type:"Makkiyah", ayat:45},
  {id:51, name:"Az-Zariyat", arabic:"الذاريات", type:"Makkiyah", ayat:60},
  {id:52, name:"At-Tur", arabic:"الطور", type:"Makkiyah", ayat:49},
  {id:53, name:"An-Najm", arabic:"النجم", type:"Makkiyah", ayat:62},
  {id:54, name:"Al-Qamar", arabic:"القمر", type:"Makkiyah", ayat:55},
  {id:55, name:"Ar-Rahman", arabic:"الرحمن", type:"Madaniyah", ayat:78},
  {id:56, name:"Al-Waqi'ah", arabic:"الواقعة", type:"Makkiyah", ayat:96},
  {id:57, name:"Al-Hadid", arabic:"الحديد", type:"Madaniyah", ayat:29},
  {id:58, name:"Al-Mujadilah", arabic:"المجادلة", type:"Madaniyah", ayat:22},
  {id:59, name:"Al-Hasyr", arabic:"الحشر", type:"Madaniyah", ayat:24},
  {id:60, name:"Al-Mumtahanah", arabic:"الممتحنة", type:"Madaniyah", ayat:13},
  {id:61, name:"As-Saff", arabic:"الصف", type:"Madaniyah", ayat:14},
  {id:62, name:"Al-Jumu'ah", arabic:"الجمعة", type:"Madaniyah", ayat:11},
  {id:63, name:"Al-Munafiqun", arabic:"المنافقون", type:"Madaniyah", ayat:11},
  {id:64, name:"At-Tagabun", arabic:"التغابن", type:"Madaniyah", ayat:18},
  {id:65, name:"At-Talaq", arabic:"الطلاق", type:"Madaniyah", ayat:12},
  {id:66, name:"At-Tahrim", arabic:"التحريم", type:"Madaniyah", ayat:12},
  {id:67, name:"Al-Mulk", arabic:"الملك", type:"Makkiyah", ayat:30},
  {id:68, name:"Al-Qalam", arabic:"القلم", type:"Makkiyah", ayat:52},
  {id:69, name:"Al-Haqqah", arabic:"الحاقة", type:"Makkiyah", ayat:52},
  {id:70, name:"Al-Ma'arij", arabic:"المعارج", type:"Makkiyah", ayat:44},
  {id:71, name:"Nuh", arabic:"نوح", type:"Makkiyah", ayat:28},
  {id:72, name:"Al-Jinn", arabic:"الجن", type:"Makkiyah", ayat:28},
  {id:73, name:"Al-Muzzammil", arabic:"المزمل", type:"Makkiyah", ayat:20},
  {id:74, name:"Al-Muddassir", arabic:"المدثر", type:"Makkiyah", ayat:56},
  {id:75, name:"Al-Qiyamah", arabic:"القيامة", type:"Makkiyah", ayat:40},
  {id:76, name:"Al-Insan", arabic:"الإنسان", type:"Madaniyah", ayat:31},
  {id:77, name:"Al-Mursalat", arabic:"المرسلات", type:"Makkiyah", ayat:50},
  {id:78, name:"An-Naba'", arabic:"النبأ", type:"Makkiyah", ayat:40},
  {id:79, name:"An-Nazi'at", arabic:"النازعات", type:"Makkiyah", ayat:46},
  {id:80, name:"'Abasa", arabic:"عبس", type:"Makkiyah", ayat:42},
  {id:81, name:"At-Takwir", arabic:"التكوير", type:"Makkiyah", ayat:29},
  {id:82, name:"Al-Infitar", arabic:"الانفطار", type:"Makkiyah", ayat:19},
  {id:83, name:"Al-Mutaffifin", arabic:"المطففين", type:"Makkiyah", ayat:36},
  {id:84, name:"Al-Insyiqaq", arabic:"الانشقاق", type:"Makkiyah", ayat:25},
  {id:85, name:"Al-Buruj", arabic:"البروج", type:"Makkiyah", ayat:22},
  {id:86, name:"At-Tariq", arabic:"الطارق", type:"Makkiyah", ayat:17},
  {id:87, name:"Al-A'la", arabic:"الأعلى", type:"Makkiyah", ayat:19},
  {id:88, name:"Al-Gasyiyah", arabic:"الغاشية", type:"Makkiyah", ayat:26},
  {id:89, name:"Al-Fajr", arabic:"الفجر", type:"Makkiyah", ayat:30},
  {id:90, name:"Al-Balad", arabic:"البلد", type:"Makkiyah", ayat:20},
  {id:91, name:"Asy-Syams", arabic:"الشمس", type:"Makkiyah", ayat:15},
  {id:92, name:"Al-Lail", arabic:"الليل", type:"Makkiyah", ayat:21},
  {id:93, name:"Ad-Duha", arabic:"الضحى", type:"Makkiyah", ayat:11},
  {id:94, name:"As-Syarh", arabic:"الشرح", type:"Makkiyah", ayat:8},
  {id:95, name:"At-Tin", arabic:"التين", type:"Makkiyah", ayat:8},
  {id:96, name:"Al-'Alaq", arabic:"العلق", type:"Makkiyah", ayat:19},
  {id:97, name:"Al-Qadr", arabic:"القدر", type:"Makkiyah", ayat:5},
  {id:98, name:"Al-Bayyinah", arabic:"البينة", type:"Madaniyah", ayat:8},
  {id:99, name:"Az-Zalzalah", arabic:"الزلزلة", type:"Madaniyah", ayat:8},
  {id:100, name:"Al-'Adiyat", arabic:"العاديات", type:"Makkiyah", ayat:11},
  {id:101, name:"Al-Qari'ah", arabic:"القارعة", type:"Makkiyah", ayat:11},
  {id:102, name:"At-Takasur", arabic:"التكاثر", type:"Makkiyah", ayat:8},
  {id:103, name:"Al-'Asr", arabic:"العصر", type:"Makkiyah", ayat:3},
  {id:104, name:"Al-Humazah", arabic:"الهمزة", type:"Makkiyah", ayat:9},
  {id:105, name:"Al-Fil", arabic:"الفيل", type:"Makkiyah", ayat:5},
  {id:106, name:"Quraisy", arabic:"قريش", type:"Makkiyah", ayat:4},
  {id:107, name:"Al-Ma'un", arabic:"الماعون", type:"Makkiyah", ayat:7},
  {id:108, name:"Al-Kausar", arabic:"الكوثر", type:"Makkiyah", ayat:3},
  {id:109, name:"Al-Kafirun", arabic:"الكافرون", type:"Makkiyah", ayat:6},
  {id:110, name:"An-Nasr", arabic:"النصر", type:"Madaniyah", ayat:3},
  {id:111, name:"Al-Masad", arabic:"المسد", type:"Makkiyah", ayat:5},
  {id:112, name:"Al-Ikhlas", arabic:"الإخلاص", type:"Makkiyah", ayat:4},
  {id:113, name:"Al-Falaq", arabic:"الفلق", type:"Makkiyah", ayat:5},
  {id:114, name:"An-Nas", arabic:"الناس", type:"Makkiyah", ayat:6},
];

// Cache for fetched ayat data
const AYAT_CACHE = {};

// Static fallback data untuk surah-surah populer (offline/API gagal)
const STATIC_AYAT = {
  1:[
    {id:1,arabic:"بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ",translation:"Dengan nama Allah Yang Maha Pengasih, Maha Penyayang",tajwid:["mad","ghunnah"],words:["بِسْمِ","ٱللَّهِ","ٱلرَّحْمَٰنِ","ٱلرَّحِيمِ"]},
    {id:2,arabic:"ٱلْحَمْدُ لِلَّهِ رَبِّ ٱلْعَٰلَمِينَ",translation:"Segala puji bagi Allah, Tuhan semesta alam",tajwid:["mad","idgham"],words:["ٱلْحَمْدُ","لِلَّهِ","رَبِّ","ٱلْعَٰلَمِينَ"]},
    {id:3,arabic:"ٱلرَّحْمَٰنِ ٱلرَّحِيمِ",translation:"Yang Maha Pengasih, Maha Penyayang",tajwid:["mad","ghunnah"],words:["ٱلرَّحْمَٰنِ","ٱلرَّحِيمِ"]},
    {id:4,arabic:"مَٰلِكِ يَوْمِ ٱلدِّينِ",translation:"Pemilik hari pembalasan",tajwid:["mad","qalqalah"],words:["مَٰلِكِ","يَوْمِ","ٱلدِّينِ"]},
    {id:5,arabic:"إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ",translation:"Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami mohon pertolongan",tajwid:["mad","ikhfa"],words:["إِيَّاكَ","نَعْبُدُ","وَإِيَّاكَ","نَسْتَعِينُ"]},
    {id:6,arabic:"ٱهْدِنَا ٱلصِّرَٰطَ ٱلْمُسْتَقِيمَ",translation:"Tunjukilah kami jalan yang lurus",tajwid:["ikhfa","mad"],words:["ٱهْدِنَا","ٱلصِّرَٰطَ","ٱلْمُسْتَقِيمَ"]},
    {id:7,arabic:"صِرَٰطَ ٱلَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ ٱلْمَغْضُوبِ عَلَيْهِمْ وَلَا ٱلضَّآلِّينَ",translation:"(yaitu) jalan orang-orang yang telah Engkau beri nikmat kepadanya; bukan (jalan) mereka yang dimurkai, dan bukan (pula jalan) mereka yang sesat",tajwid:["mad","ikhfa","ghunnah","idgham"],words:["صِرَٰطَ","ٱلَّذِينَ","أَنْعَمْتَ","عَلَيْهِمْ","غَيْرِ","ٱلْمَغْضُوبِ","عَلَيْهِمْ","وَلَا","ٱلضَّآلِّينَ"]},
  ],
  36:[
    {id:1,arabic:"يس",translation:"Ya Sin",tajwid:["mad"],words:["يس"]},
    {id:2,arabic:"وَٱلْقُرْءَانِ ٱلْحَكِيمِ",translation:"demi Al-Qur'an yang penuh hikmah",tajwid:["mad","qalqalah"],words:["وَٱلْقُرْءَانِ","ٱلْحَكِيمِ"]},
    {id:3,arabic:"إِنَّكَ لَمِنَ ٱلْمُرْسَلِينَ",translation:"sungguh, engkau (Muhammad) adalah salah seorang dari rasul-rasul",tajwid:["ghunnah","mad"],words:["إِنَّكَ","لَمِنَ","ٱلْمُرْسَلِينَ"]},
    {id:4,arabic:"عَلَىٰ صِرَٰطٍ مُّسْتَقِيمٍ",translation:"(yang berada) di atas jalan yang lurus",tajwid:["mad","ikhfa"],words:["عَلَىٰ","صِرَٰطٍ","مُّسْتَقِيمٍ"]},
    {id:5,arabic:"تَنزِيلَ ٱلْعَزِيزِ ٱلرَّحِيمِ",translation:"(Al-Qur'an itu) diturunkan oleh Yang Maha Perkasa, Maha Penyayang",tajwid:["mad"],words:["تَنزِيلَ","ٱلْعَزِيزِ","ٱلرَّحِيمِ"]},
  ],
  55:[
    {id:1,arabic:"ٱلرَّحْمَٰنُ",translation:"(Allah) Yang Maha Pengasih",tajwid:["mad","ghunnah"],words:["ٱلرَّحْمَٰنُ"]},
    {id:2,arabic:"عَلَّمَ ٱلْقُرْءَانَ",translation:"yang telah mengajarkan Al-Qur'an",tajwid:["mad"],words:["عَلَّمَ","ٱلْقُرْءَانَ"]},
    {id:3,arabic:"خَلَقَ ٱلْإِنسَٰنَ",translation:"Dia menciptakan manusia",tajwid:["mad","qalqalah"],words:["خَلَقَ","ٱلْإِنسَٰنَ"]},
    {id:4,arabic:"عَلَّمَهُ ٱلْبَيَانَ",translation:"mengajarnya pandai berbicara",tajwid:["mad"],words:["عَلَّمَهُ","ٱلْبَيَانَ"]},
    {id:13,arabic:"فَبِأَىِّ ءَالَآءِ رَبِّكُمَا تُكَذِّبَانِ",translation:"Maka nikmat Tuhanmu yang manakah yang kamu dustakan?",tajwid:["mad","ghunnah"],words:["فَبِأَىِّ","ءَالَآءِ","رَبِّكُمَا","تُكَذِّبَانِ"]},
  ],
  67:[
    {id:1,arabic:"تَبَٰرَكَ ٱلَّذِى بِيَدِهِ ٱلْمُلْكُ وَهُوَ عَلَىٰ كُلِّ شَىْءٍ قَدِيرٌ",translation:"Mahasuci Allah yang menguasai (segala) kerajaan, dan Dia Mahakuasa atas segala sesuatu",tajwid:["mad","qalqalah"],words:["تَبَٰرَكَ","ٱلَّذِى","بِيَدِهِ","ٱلْمُلْكُ","وَهُوَ","عَلَىٰ","كُلِّ","شَىْءٍ","قَدِيرٌ"]},
    {id:2,arabic:"ٱلَّذِى خَلَقَ ٱلْمَوْتَ وَٱلْحَيَوٰةَ لِيَبْلُوَكُمْ أَيُّكُمْ أَحْسَنُ عَمَلًا وَهُوَ ٱلْعَزِيزُ ٱلْغَفُورُ",translation:"Yang menciptakan mati dan hidup, untuk menguji kamu, siapa di antara kamu yang lebih baik amalnya. Dan Dia Mahaperkasa, Maha Pengampun",tajwid:["mad","qalqalah","ghunnah"],words:["ٱلَّذِى","خَلَقَ","ٱلْمَوْتَ","وَٱلْحَيَوٰةَ","لِيَبْلُوَكُمْ","أَيُّكُمْ","أَحْسَنُ","عَمَلًا","وَهُوَ","ٱلْعَزِيزُ","ٱلْغَفُورُ"]},
  ],
  78:[
    {id:1,arabic:"عَمَّ يَتَسَآءَلُونَ",translation:"Tentang apakah mereka saling bertanya-tanya?",tajwid:["mad","ghunnah"],words:["عَمَّ","يَتَسَآءَلُونَ"]},
    {id:2,arabic:"عَنِ ٱلنَّبَإِ ٱلْعَظِيمِ",translation:"tentang berita yang besar (hari Kiamat),",tajwid:["mad","ghunnah"],words:["عَنِ","ٱلنَّبَإِ","ٱلْعَظِيمِ"]},
    {id:3,arabic:"ٱلَّذِى هُمْ فِيهِ مُخْتَلِفُونَ",translation:"yang mereka perselisihkan",tajwid:["ikhfa"],words:["ٱلَّذِى","هُمْ","فِيهِ","مُخْتَلِفُونَ"]},
  ],
  93:[
    {id:1,arabic:"وَٱلضُّحَىٰ",translation:"Demi waktu duha (ketika matahari naik sepenggalah)",tajwid:["mad"],words:["وَٱلضُّحَىٰ"]},
    {id:2,arabic:"وَٱلَّيْلِ إِذَا سَجَىٰ",translation:"dan demi malam apabila telah sunyi",tajwid:["mad"],words:["وَٱلَّيْلِ","إِذَا","سَجَىٰ"]},
    {id:3,arabic:"مَا وَدَّعَكَ رَبُّكَ وَمَا قَلَىٰ",translation:"Tuhanmu tidak meninggalkan engkau (Muhammad) dan tidak (pula) membencimu",tajwid:["mad","qalqalah"],words:["مَا","وَدَّعَكَ","رَبُّكَ","وَمَا","قَلَىٰ"]},
    {id:4,arabic:"وَلَلْءَاخِرَةُ خَيْرٌ لَّكَ مِنَ ٱلْأُولَىٰ",translation:"Dan sungguh, yang kemudian itu lebih baik bagimu dari yang permulaan",tajwid:["mad","idgham"],words:["وَلَلْءَاخِرَةُ","خَيْرٌ","لَّكَ","مِنَ","ٱلْأُولَىٰ"]},
    {id:5,arabic:"وَلَسَوْفَ يُعْطِيكَ رَبُّكَ فَتَرْضَىٰ",translation:"Dan sungguh, kelak Tuhanmu pasti memberikan karunia-Nya kepadamu, sehingga engkau menjadi puas",tajwid:["mad"],words:["وَلَسَوْفَ","يُعْطِيكَ","رَبُّكَ","فَتَرْضَىٰ"]},
    {id:6,arabic:"أَلَمْ يَجِدْكَ يَتِيمًا فَـَٔاوَىٰ",translation:"Bukankah Dia mendapatimu sebagai seorang yatim, lalu Dia melindungi(mu)?",tajwid:["mad","qalqalah","ikhfa"],words:["أَلَمْ","يَجِدْكَ","يَتِيمًا","فَـَٔاوَىٰ"]},
    {id:7,arabic:"وَوَجَدَكَ ضَآلًّا فَهَدَىٰ",translation:"Dan Dia mendapatimu sebagai seorang yang bingung, lalu Dia memberikan petunjuk",tajwid:["mad"],words:["وَوَجَدَكَ","ضَآلًّا","فَهَدَىٰ"]},
    {id:8,arabic:"وَوَجَدَكَ عَآئِلًا فَأَغْنَىٰ",translation:"Dan Dia mendapatimu sebagai seorang yang kekurangan, lalu Dia memberikan kecukupan",tajwid:["mad"],words:["وَوَجَدَكَ","عَآئِلًا","فَأَغْنَىٰ"]},
    {id:9,arabic:"فَأَمَّا ٱلْيَتِيمَ فَلَا تَقْهَرْ",translation:"Maka terhadap anak yatim janganlah engkau berlaku sewenang-wenang",tajwid:["ghunnah","ikhfa"],words:["فَأَمَّا","ٱلْيَتِيمَ","فَلَا","تَقْهَرْ"]},
    {id:10,arabic:"وَأَمَّا ٱلسَّآئِلَ فَلَا تَنْهَرْ",translation:"dan terhadap orang yang meminta-minta janganlah engkau menghardik(nya)",tajwid:["ghunnah","ikhfa"],words:["وَأَمَّا","ٱلسَّآئِلَ","فَلَا","تَنْهَرْ"]},
    {id:11,arabic:"وَأَمَّا بِنِعْمَةِ رَبِّكَ فَحَدِّثْ",translation:"dan terhadap nikmat Tuhanmu hendaklah engkau nyatakan (dengan bersyukur)",tajwid:["ghunnah","qalqalah"],words:["وَأَمَّا","بِنِعْمَةِ","رَبِّكَ","فَحَدِّثْ"]},
  ],
  94:[
    {id:1,arabic:"أَلَمْ نَشْرَحْ لَكَ صَدْرَكَ",translation:"Bukankah Kami telah melapangkan dadamu (Muhammad)?",tajwid:["ikhfa","qalqalah"],words:["أَلَمْ","نَشْرَحْ","لَكَ","صَدْرَكَ"]},
    {id:2,arabic:"وَوَضَعْنَا عَنكَ وِزْرَكَ",translation:"dan Kami pun telah menurunkan bebanmu darimu",tajwid:["ikhfa"],words:["وَوَضَعْنَا","عَنكَ","وِزْرَكَ"]},
    {id:3,arabic:"ٱلَّذِىٓ أَنقَضَ ظَهْرَكَ",translation:"yang memberatkan punggungmu",tajwid:["ikhfa"],words:["ٱلَّذِىٓ","أَنقَضَ","ظَهْرَكَ"]},
    {id:4,arabic:"وَرَفَعْنَا لَكَ ذِكْرَكَ",translation:"dan Kami tinggikan sebutan (nama)mu bagimu",tajwid:["mad"],words:["وَرَفَعْنَا","لَكَ","ذِكْرَكَ"]},
    {id:5,arabic:"فَإِنَّ مَعَ ٱلْعُسْرِ يُسْرًا",translation:"Maka sesungguhnya bersama kesulitan ada kemudahan",tajwid:["ghunnah","mad"],words:["فَإِنَّ","مَعَ","ٱلْعُسْرِ","يُسْرًا"]},
    {id:6,arabic:"إِنَّ مَعَ ٱلْعُسْرِ يُسْرًا",translation:"sesungguhnya bersama kesulitan ada kemudahan",tajwid:["ghunnah","mad"],words:["إِنَّ","مَعَ","ٱلْعُسْرِ","يُسْرًا"]},
    {id:7,arabic:"فَإِذَا فَرَغْتَ فَٱنصَبْ",translation:"Maka apabila engkau telah selesai (dari sesuatu urusan), tetaplah bekerja keras (untuk urusan yang lain)",tajwid:["ikhfa"],words:["فَإِذَا","فَرَغْتَ","فَٱنصَبْ"]},
    {id:8,arabic:"وَإِلَىٰ رَبِّكَ فَٱرْغَب",translation:"dan hanya kepada Tuhanmulah engkau berharap",tajwid:["mad"],words:["وَإِلَىٰ","رَبِّكَ","فَٱرْغَب"]},
  ],
  97:[
    {id:1,arabic:"إِنَّآ أَنزَلْنَٰهُ فِى لَيْلَةِ ٱلْقَدْرِ",translation:"Sesungguhnya Kami telah menurunkannya (Al-Qur'an) pada malam qadar",tajwid:["ghunnah","mad","ikhfa"],words:["إِنَّآ","أَنزَلْنَٰهُ","فِى","لَيْلَةِ","ٱلْقَدْرِ"]},
    {id:2,arabic:"وَمَآ أَدْرَىٰكَ مَا لَيْلَةُ ٱلْقَدْرِ",translation:"Dan tahukah kamu apakah malam kemuliaan itu?",tajwid:["mad","qalqalah"],words:["وَمَآ","أَدْرَىٰكَ","مَا","لَيْلَةُ","ٱلْقَدْرِ"]},
    {id:3,arabic:"لَيْلَةُ ٱلْقَدْرِ خَيْرٌ مِّنْ أَلْفِ شَهْرٍ",translation:"Malam kemuliaan itu lebih baik dari seribu bulan",tajwid:["mad","ikhfa"],words:["لَيْلَةُ","ٱلْقَدْرِ","خَيْرٌ","مِّنْ","أَلْفِ","شَهْرٍ"]},
    {id:4,arabic:"تَنَزَّلُ ٱلْمَلَٰٓئِكَةُ وَٱلرُّوحُ فِيهَا بِإِذْنِ رَبِّهِم مِّن كُلِّ أَمْرٍ",translation:"Pada malam itu turun para malaikat dan Ruh (Jibril) dengan izin Tuhannya untuk mengatur semua urusan",tajwid:["mad","ghunnah","ikhfa"],words:["تَنَزَّلُ","ٱلْمَلَٰٓئِكَةُ","وَٱلرُّوحُ","فِيهَا","بِإِذْنِ","رَبِّهِم","مِّن","كُلِّ","أَمْرٍ"]},
    {id:5,arabic:"سَلَٰمٌ هِىَ حَتَّىٰ مَطْلَعِ ٱلْفَجْرِ",translation:"Sejahteralah (malam itu) sampai terbit fajar",tajwid:["mad","ghunnah"],words:["سَلَٰمٌ","هِىَ","حَتَّىٰ","مَطْلَعِ","ٱلْفَجْرِ"]},
  ],
  103:[
    {id:1,arabic:"وَٱلْعَصْرِ",translation:"Demi masa",tajwid:["mad"],words:["وَٱلْعَصْرِ"]},
    {id:2,arabic:"إِنَّ ٱلْإِنسَٰنَ لَفِى خُسْرٍ",translation:"sungguh, manusia berada dalam kerugian",tajwid:["ghunnah","ikhfa","mad"],words:["إِنَّ","ٱلْإِنسَٰنَ","لَفِى","خُسْرٍ"]},
    {id:3,arabic:"إِلَّا ٱلَّذِينَ ءَامَنُوا۟ وَعَمِلُوا۟ ٱلصَّٰلِحَٰتِ وَتَوَاصَوْا۟ بِٱلْحَقِّ وَتَوَاصَوْا۟ بِٱلصَّبْرِ",translation:"kecuali orang-orang yang beriman dan mengerjakan kebajikan serta saling menasihati untuk kebenaran dan saling menasihati untuk kesabaran",tajwid:["mad","ghunnah","idgham"],words:["إِلَّا","ٱلَّذِينَ","ءَامَنُوا۟","وَعَمِلُوا۟","ٱلصَّٰلِحَٰتِ","وَتَوَاصَوْا۟","بِٱلْحَقِّ","وَتَوَاصَوْا۟","بِٱلصَّبْرِ"]},
  ],
  108:[
    {id:1,arabic:"إِنَّآ أَعْطَيْنَٰكَ ٱلْكَوْثَرَ",translation:"Sungguh, Kami telah memberimu (Muhammad) nikmat yang banyak",tajwid:["ghunnah","mad"],words:["إِنَّآ","أَعْطَيْنَٰكَ","ٱلْكَوْثَرَ"]},
    {id:2,arabic:"فَصَلِّ لِرَبِّكَ وَٱنْحَرْ",translation:"Maka laksanakanlah shalat karena Tuhanmu, dan berkurbanlah (sebagai ibadah dan mendekatkan diri kepada Allah)",tajwid:["ikhfa"],words:["فَصَلِّ","لِرَبِّكَ","وَٱنْحَرْ"]},
    {id:3,arabic:"إِنَّ شَانِئَكَ هُوَ ٱلْأَبْتَرُ",translation:"Sungguh, orang-orang yang membencimu dialah yang terputus (dari rahmat Allah)",tajwid:["ghunnah","mad"],words:["إِنَّ","شَانِئَكَ","هُوَ","ٱلْأَبْتَرُ"]},
  ],
  109:[
    {id:1,arabic:"قُلْ يَٰٓأَيُّهَا ٱلْكَٰفِرُونَ",translation:"Katakanlah: Wahai orang-orang kafir!",tajwid:["qalqalah","mad"],words:["قُلْ","يَٰٓأَيُّهَا","ٱلْكَٰفِرُونَ"]},
    {id:2,arabic:"لَآ أَعْبُدُ مَا تَعْبُدُونَ",translation:"Aku tidak akan menyembah apa yang kamu sembah",tajwid:["mad"],words:["لَآ","أَعْبُدُ","مَا","تَعْبُدُونَ"]},
    {id:3,arabic:"وَلَآ أَنتُمْ عَٰبِدُونَ مَآ أَعْبُدُ",translation:"dan kamu bukan penyembah apa yang aku sembah",tajwid:["mad","ikhfa"],words:["وَلَآ","أَنتُمْ","عَٰبِدُونَ","مَآ","أَعْبُدُ"]},
    {id:4,arabic:"وَلَآ أَنَا۠ عَابِدٌ مَّا عَبَدتُّمْ",translation:"dan aku tidak pernah menjadi penyembah apa yang kamu sembah",tajwid:["mad","idgham"],words:["وَلَآ","أَنَا۠","عَابِدٌ","مَّا","عَبَدتُّمْ"]},
    {id:5,arabic:"وَلَآ أَنتُمْ عَٰبِدُونَ مَآ أَعْبُدُ",translation:"dan kamu tidak pernah (pula) menjadi penyembah apa yang aku sembah",tajwid:["mad","ikhfa"],words:["وَلَآ","أَنتُمْ","عَٰبِدُونَ","مَآ","أَعْبُدُ"]},
    {id:6,arabic:"لَكُمْ دِينُكُمْ وَلِىَ دِينِ",translation:"Untukmu agamamu, dan untukku agamaku",tajwid:["mad"],words:["لَكُمْ","دِينُكُمْ","وَلِىَ","دِينِ"]},
  ],
  110:[
    {id:1,arabic:"إِذَا جَآءَ نَصْرُ ٱللَّهِ وَٱلْفَتْحُ",translation:"Apabila telah datang pertolongan Allah dan kemenangan",tajwid:["mad","ikhfa"],words:["إِذَا","جَآءَ","نَصْرُ","ٱللَّهِ","وَٱلْفَتْحُ"]},
    {id:2,arabic:"وَرَأَيْتَ ٱلنَّاسَ يَدْخُلُونَ فِى دِينِ ٱللَّهِ أَفْوَاجًا",translation:"dan engkau melihat manusia berbondong-bondong masuk agama Allah",tajwid:["mad","ghunnah"],words:["وَرَأَيْتَ","ٱلنَّاسَ","يَدْخُلُونَ","فِى","دِينِ","ٱللَّهِ","أَفْوَاجًا"]},
    {id:3,arabic:"فَسَبِّحْ بِحَمْدِ رَبِّكَ وَٱسْتَغْفِرْهُ إِنَّهُۥ كَانَ تَوَّابًا",translation:"maka bertasbihlah dengan memuji Tuhanmu dan mohonlah ampunan kepada-Nya. Sungguh, Dia Maha Penerima tobat",tajwid:["ghunnah","mad","ikhfa"],words:["فَسَبِّحْ","بِحَمْدِ","رَبِّكَ","وَٱسْتَغْفِرْهُ","إِنَّهُۥ","كَانَ","تَوَّابًا"]},
  ],
  111:[
    {id:1,arabic:"تَبَّتْ يَدَآ أَبِى لَهَبٍ وَتَبَّ",translation:"Binasalah kedua tangan Abu Lahab dan benar-benar binasa dia!",tajwid:["qalqalah","mad","idgham"],words:["تَبَّتْ","يَدَآ","أَبِى","لَهَبٍ","وَتَبَّ"]},
    {id:2,arabic:"مَآ أَغْنَىٰ عَنْهُ مَالُهُۥ وَمَا كَسَبَ",translation:"Tidaklah berguna baginya hartanya dan apa yang dia usahakan",tajwid:["mad","ikhfa"],words:["مَآ","أَغْنَىٰ","عَنْهُ","مَالُهُۥ","وَمَا","كَسَبَ"]},
    {id:3,arabic:"سَيَصْلَىٰ نَارًا ذَاتَ لَهَبٍ",translation:"Kelak dia akan masuk ke dalam api yang bergejolak (neraka)",tajwid:["mad","ghunnah"],words:["سَيَصْلَىٰ","نَارًا","ذَاتَ","لَهَبٍ"]},
    {id:4,arabic:"وَٱمْرَأَتُهُۥ حَمَّالَةَ ٱلْحَطَبِ",translation:"dan (begitu pula) istrinya, pembawa kayu bakar (penyebar fitnah)",tajwid:["mad","ghunnah","qalqalah"],words:["وَٱمْرَأَتُهُۥ","حَمَّالَةَ","ٱلْحَطَبِ"]},
    {id:5,arabic:"فِى جِيدِهَا حَبْلٌ مِّن مَّسَدٍ",translation:"yang di lehernya ada tali dari sabut",tajwid:["idgham","qalqalah"],words:["فِى","جِيدِهَا","حَبْلٌ","مِّن","مَّسَدٍ"]},
  ],
  112:[
    {id:1,arabic:"قُلْ هُوَ ٱللَّهُ أَحَدٌ",translation:"Katakanlah: Dialah Allah, Yang Maha Esa",tajwid:["qalqalah","mad"],words:["قُلْ","هُوَ","ٱللَّهُ","أَحَدٌ"]},
    {id:2,arabic:"ٱللَّهُ ٱلصَّمَدُ",translation:"Allah tempat meminta segala sesuatu",tajwid:["mad","qalqalah"],words:["ٱللَّهُ","ٱلصَّمَدُ"]},
    {id:3,arabic:"لَمْ يَلِدْ وَلَمْ يُولَدْ",translation:"Dia tiada beranak dan tiada pula diperanakkan",tajwid:["idgham","qalqalah"],words:["لَمْ","يَلِدْ","وَلَمْ","يُولَدْ"]},
    {id:4,arabic:"وَلَمْ يَكُن لَّهُۥ كُفُوًا أَحَدٌ",translation:"Dan tidak ada seorang pun yang setara dengan Dia",tajwid:["idgham","ghunnah","mad"],words:["وَلَمْ","يَكُن","لَّهُۥ","كُفُوًا","أَحَدٌ"]},
  ],
  113:[
    {id:1,arabic:"قُلْ أَعُوذُ بِرَبِّ ٱلْفَلَقِ",translation:"Katakanlah: Aku berlindung kepada Tuhan yang menguasai subuh",tajwid:["qalqalah","ikhfa"],words:["قُلْ","أَعُوذُ","بِرَبِّ","ٱلْفَلَقِ"]},
    {id:2,arabic:"مِن شَرِّ مَا خَلَقَ",translation:"dari kejahatan (makhluk yang) Dia ciptakan",tajwid:["ikhfa","qalqalah"],words:["مِن","شَرِّ","مَا","خَلَقَ"]},
    {id:3,arabic:"وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ",translation:"dan dari kejahatan malam apabila telah gelap gulita",tajwid:["ikhfa","mad","qalqalah"],words:["وَمِن","شَرِّ","غَاسِقٍ","إِذَا","وَقَبَ"]},
    {id:4,arabic:"وَمِن شَرِّ ٱلنَّفَّٰثَٰتِ فِى ٱلْعُقَدِ",translation:"dan dari kejahatan (perempuan-perempuan) penyihir yang meniup pada buhul-buhul (talinya)",tajwid:["mad","ghunnah"],words:["وَمِن","شَرِّ","ٱلنَّفَّٰثَٰتِ","فِى","ٱلْعُقَدِ"]},
    {id:5,arabic:"وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ",translation:"dan dari kejahatan orang yang dengki apabila dia dengki",tajwid:["ikhfa","mad"],words:["وَمِن","شَرِّ","حَاسِدٍ","إِذَا","حَسَدَ"]},
  ],
  114:[
    {id:1,arabic:"قُلْ أَعُوذُ بِرَبِّ ٱلنَّاسِ",translation:"Katakanlah: Aku berlindung kepada Tuhannya manusia",tajwid:["qalqalah","ghunnah"],words:["قُلْ","أَعُوذُ","بِرَبِّ","ٱلنَّاسِ"]},
    {id:2,arabic:"مَلِكِ ٱلنَّاسِ",translation:"Raja manusia",tajwid:["mad","ghunnah"],words:["مَلِكِ","ٱلنَّاسِ"]},
    {id:3,arabic:"إِلَٰهِ ٱلنَّاسِ",translation:"Sembahan manusia",tajwid:["mad","ghunnah"],words:["إِلَٰهِ","ٱلنَّاسِ"]},
    {id:4,arabic:"مِن شَرِّ ٱلْوَسْوَاسِ ٱلْخَنَّاسِ",translation:"dari kejahatan (bisikan) setan yang bersembunyi",tajwid:["ikhfa","ghunnah","mad"],words:["مِن","شَرِّ","ٱلْوَسْوَاسِ","ٱلْخَنَّاسِ"]},
    {id:5,arabic:"ٱلَّذِى يُوَسْوِسُ فِى صُدُورِ ٱلنَّاسِ",translation:"yang membisikkan (kejahatan) ke dalam dada manusia",tajwid:["mad","ghunnah"],words:["ٱلَّذِى","يُوَسْوِسُ","فِى","صُدُورِ","ٱلنَّاسِ"]},
    {id:6,arabic:"مِنَ ٱلْجِنَّةِ وَٱلنَّاسِ",translation:"dari (golongan) jin dan manusia",tajwid:["ghunnah","idgham"],words:["مِنَ","ٱلْجِنَّةِ","وَٱلنَّاسِ"]},
  ],
};

// ===================================
// TAJWID RULES & COLORS
// ===================================
const TAJWID_RULES = {
  ikhfa:       { name:"Ikhfa",        color:"#5DADE2", bg:"rgba(93,173,226,0.18)",  border:"rgba(93,173,226,0.5)",  desc:"Menyamarkan nun sukun/tanwin sebelum 15 huruf ikhfa dengan dengung 2 harakat." },
  idgham:      { name:"Idgham",       color:"#58D68D", bg:"rgba(88,214,141,0.18)",  border:"rgba(88,214,141,0.5)",  desc:"Memasukkan nun sukun/tanwin ke dalam huruf berikutnya (ي ن م و ل ر)." },
  idghamMimy:  { name:"Idgham Mimy",  color:"#A3E4D7", bg:"rgba(163,228,215,0.18)", border:"rgba(163,228,215,0.5)", desc:"Memasukkan Mim sukun ke dalam Mim berikutnya dengan ghunnah 2 harakat." },
  iqlab:       { name:"Iqlab",        color:"#F8C471", bg:"rgba(248,196,113,0.18)", border:"rgba(248,196,113,0.5)", desc:"Mengubah nun sukun/tanwin menjadi Mim ketika bertemu huruf Ba." },
  izhar:       { name:"Izhar",        color:"#85C1E9", bg:"rgba(133,193,233,0.18)", border:"rgba(133,193,233,0.5)", desc:"Membaca nun sukun/tanwin dengan jelas tanpa dengung (ء ه ع ح غ خ)." },
  qalqalah:    { name:"Qalqalah",     color:"#C39BD3", bg:"rgba(195,155,211,0.18)", border:"rgba(195,155,211,0.5)", desc:"Memantulkan suara huruf Qalqalah (ق ب ج د ط) saat sukun/waqaf." },
  mad:         { name:"Mad Tabi'i",   color:"#F0B27A", bg:"rgba(240,178,122,0.18)", border:"rgba(240,178,122,0.5)", desc:"Memanjangkan bacaan 2 harakat pada huruf Mad (ا و ي) tanpa hamzah/sukun." },
  madWajib:    { name:"Mad Wajib",    color:"#E59866", bg:"rgba(229,152,102,0.2)",  border:"rgba(229,152,102,0.6)", desc:"Memanjangkan 5-6 harakat: huruf Mad bertemu Hamzah dalam satu kata (Mad Wajib Muttasil)." },
  madJaiz:     { name:"Mad Jaiz",     color:"#D4AC0D", bg:"rgba(212,172,13,0.18)",  border:"rgba(212,172,13,0.5)",  desc:"Memanjangkan 2-5 harakat: huruf Mad bertemu Hamzah beda kata (Mad Jaiz Munfasil)." },
  madArid:     { name:"Mad 'Arid",    color:"#FAD7A0", bg:"rgba(250,215,160,0.18)", border:"rgba(250,215,160,0.5)", desc:"Memanjangkan 2-6 harakat saat waqaf: huruf Mad sebelum huruf akhir yang diwaqafkan." },
  ghunnah:     { name:"Ghunnah",      color:"#F1948A", bg:"rgba(241,148,138,0.18)", border:"rgba(241,148,138,0.5)", desc:"Dengung 2 harakat pada Nun/Mim bertasydid (نّ مّ)." },
  syamsiyah:   { name:"Al Syamsiyah", color:"#82E0AA", bg:"rgba(130,224,170,0.18)", border:"rgba(130,224,170,0.5)", desc:"Alif Lam bertemu huruf syamsiyah: Lam tidak dibaca, huruf sesudahnya ditasydidkan." },
  qamariyah:   { name:"Al Qamariyah",color:"#AED6F1", bg:"rgba(174,214,241,0.18)", border:"rgba(174,214,241,0.5)", desc:"Alif Lam bertemu huruf qamariyah: Lam dibaca jelas (ء ب ج ح خ ع غ ف ق ك م و ه ي)." },
  waqaf:       { name:"Waqaf",        color:"#A9CCE3", bg:"rgba(169,204,227,0.18)", border:"rgba(169,204,227,0.5)", desc:"Tanda berhenti. Berhenti sempurna di akhir ayat atau tanda ۝." },
};

// ===================================
// TAJWID PER-KATA ENGINE
// ===================================

// Huruf-huruf penting
const HURUF_IKHFA   = 'تثجدذزسشصضطظفقك';
const HURUF_IDGHAM  = 'ينمولر';
const HURUF_IZHAR   = 'ءهعحغخ';
const HURUF_QALQALAH= 'قبجدط';
const HURUF_SYAMS   = 'تثدذرزسشصضطظلن';
const HURUF_QAMAR   = 'ءبجحخعغفقكمهوي';

// Mendeteksi hukum tajwid utama pada sebuah kata
// nextWord dipakai untuk deteksi hukum antar-kata (Idgham Munfasil, dll.)
function analyzeWordTajwid(word, nextWord = '') {
  const rules = [];

  // Bersihkan harakat untuk analisis konsonan
  const clean = word.replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g, '');

  // --- 1. GHUNNAH: Nun/Mim tasydid ---
  if (/[نم]ّ/.test(word)) rules.push('ghunnah');

  // --- 2. MAD WAJIB MUTTASIL: Huruf mad + hamzah dalam satu kata ---
  if (/[اوي][\u064E-\u0652]*[ءأإآ]/.test(word) && word.length > 2) rules.push('madWajib');

  // --- 3. MAD JAIZ MUNFASIL: Akhir kata mad, awal kata berikut hamzah ---
  else if (/[اوي]$|[اوي][\u064E-\u0652]*$/.test(clean) && /^[ءأإآ]/.test(nextWord)) rules.push('madJaiz');

  // --- 4. MAD TABI'I: Alif/Waw/Ya tanpa hamzah/sukun setelahnya ---
  else if (/[اوي]/.test(word) && !/[اوي][\u064E-\u0652]*[ءأإآ]/.test(word)) rules.push('mad');

  // --- 5. MAD 'ARID LIS-SUKUN: last word in ayah with mad ---
  // (ditandai di level renderAyat untuk kata terakhir)

  // --- 6. NUN SUKUN / TANWIN + huruf berikutnya ---
  const endsNunSukun = /نْ$/.test(word) || /[ًٌٍ]/.test(word);
  if (endsNunSukun && nextWord) {
    const firstNext = nextWord.replace(/[\u064B-\u065F\u0670]/g, '')[0] || '';
    if (HURUF_IDGHAM.includes(firstNext)) rules.push('idgham');
    else if (HURUF_IKHFA.includes(firstNext))  rules.push('ikhfa');
    else if (firstNext === 'ب')                rules.push('iqlab');
    else if (HURUF_IZHAR.includes(firstNext))  rules.push('izhar');
  }

  // --- 7. QALQALAH: huruf qalqalah sukun di dalam/akhir kata ---
  if (new RegExp(`[${HURUF_QALQALAH}]ْ`).test(word)) rules.push('qalqalah');

  // --- 8. AL SYAMSIYAH / QAMARIYAH ---
  if (/^ٱل|^ال/.test(word)) {
    const afterAl = clean.replace(/^ال|^ٱل/, '')[0] || '';
    if (HURUF_SYAMS.includes(afterAl))  rules.push('syamsiyah');
    else if (HURUF_QAMAR.includes(afterAl)) rules.push('qamariyah');
  }

  // --- 9. IDGHAM MIMY: Mim sukun bertemu Mim ---
  if (/مْ$/.test(word) && /^م/.test(nextWord)) rules.push('idghamMimy');

  // Priority: ambil hukum yang paling dominan/menonjol
  const priority = ['madWajib','madJaiz','ghunnah','iqlab','idghamMimy','idgham','ikhfa','izhar','qalqalah','syamsiyah','qamariyah','mad'];
  const best = priority.find(r => rules.includes(r));
  return best || null;
}


// ===================================================================
// GET AYAT — dari AYAT_CACHE (hasil fetch API) atau STATIC_AYAT
// ===================================================================
function getAyatForSurah(id) {
  return AYAT_CACHE[id] || STATIC_AYAT[id] || [];
}

// ===================================================================
// RENDER SURAH LIST — sidebar desktop
// ===================================================================
function renderSurahList(list) {
  const container = document.getElementById('surahList');
  if (!container) return;
  container.innerHTML = (list || SURAHS).map(s => {
    const sc = scores[s.id];
    const badge = sc
      ? `<span style="font-size:10px;font-weight:700;margin-left:4px;
           color:${sc>=80?'#58D68D':sc>=50?'#E67E22':'#E74C3C'}">${sc}</span>`
      : '';
    return `<div class="surah-item ${currentSurah===s.id?'active':''}"
        onclick="selectSurah(${s.id})">
        <div class="surah-num">${s.id}</div>
        <div class="surah-info">
          <div class="surah-name-latin">${s.name}${badge}</div>
          <div class="surah-name-ar">${s.arabic}</div>
        </div>
      </div>`;
  }).join('');
}

function filterSurah(q) {
  const filtered = SURAHS.filter(s =>
    s.name.toLowerCase().includes(q.toLowerCase()) ||
    s.arabic.includes(q) ||
    String(s.id).includes(q)
  );
  renderSurahList(filtered);
}

// ===================================================================
// RENDER AYAT — tab Rekam (per ayat dengan tombol rekam & dengar)
// ===================================================================
function renderAyat(surahId) {
  const ayats     = getAyatForSurah(surahId);
  const container = document.getElementById('ayatContainer');
  if (!container) return;

  if (!ayats || ayats.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:48px 20px;color:rgba(253,248,238,0.35);">
        <div style="font-size:36px;margin-bottom:12px;">⏳</div>
        <div style="font-size:14px;">Memuat ayat...</div>
      </div>`;
    fetchAndRenderAyat(surahId);
    return;
  }

  container.innerHTML = ayats.map(a => {
    const sc = scores[`${surahId}_${a.id}`];
    const scoreBadge = sc
      ? `<span style="font-size:11px;padding:2px 8px;border-radius:6px;font-weight:700;
           background:${sc>=80?'rgba(88,214,141,0.15)':sc>=50?'rgba(230,126,34,0.15)':'rgba(192,57,43,0.15)'};
           color:${sc>=80?'#58D68D':sc>=50?'#E67E22':'#E74C3C'}">${sc}</span>`
      : '';

    const coloredAyah = (a.words && a.words.length)
      ? renderColoredAyah(a.words, a.id === ayats[ayats.length-1].id, a.id)
      : `<span style="font-family:'Amiri',serif;font-size:26px;line-height:2;
           color:var(--cream);">${a.arabic}</span>`;

    return `
    <div class="ayat-card ${currentAyah===a.id?'reading':''}"
         id="card-${a.id}" onclick="selectAyah(${a.id})">

      <!-- Header ayat -->
      <div style="display:flex;justify-content:space-between;align-items:center;
                  margin-bottom:12px;direction:ltr;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="background:rgba(201,162,39,0.15);border:1px solid rgba(201,162,39,0.3);
            border-radius:8px;padding:3px 10px;font-size:12px;font-weight:700;
            color:var(--gold);">${a.id}</span>
          ${scoreBadge}
        </div>
        <div style="display:flex;gap:6px;">
          <button onclick="event.stopPropagation();playAyahDirect(${a.id})"
            style="background:rgba(201,162,39,0.08);border:1px solid rgba(201,162,39,0.25);
              border-radius:8px;color:var(--gold);font-size:11px;padding:4px 10px;
              cursor:pointer;font-family:inherit;">🎧 Dengar</button>
          <button id="rec-btn-${a.id}"
            onclick="event.stopPropagation();startRecordingForAyah(${a.id})"
            style="background:linear-gradient(135deg,var(--gold),var(--gold-dark));
              border:none;border-radius:8px;color:var(--teal-dark);font-size:11px;
              font-weight:700;padding:4px 12px;cursor:pointer;font-family:inherit;
              box-shadow:0 2px 8px rgba(201,162,39,0.3);">🎙 Rekam</button>
        </div>
      </div>

      <!-- Teks Arab berwarna tajwid -->
      <div style="direction:rtl;text-align:right;line-height:2.4;margin-bottom:12px;
                  word-spacing:6px;font-size:24px;">
        ${coloredAyah}
      </div>

      <!-- Terjemahan -->
      <div style="font-size:12px;color:rgba(253,248,238,0.45);direction:ltr;
        line-height:1.6;border-top:1px solid rgba(255,255,255,0.06);
        padding-top:8px;">${a.translation || ''}</div>

      <!-- Status rekam -->
      <div id="rec-status-${a.id}"
        style="font-size:11px;color:rgba(253,248,238,0.4);direction:ltr;
               margin-top:6px;min-height:14px;"></div>

      <!-- Feedback tajwid -->
      <div class="tajwid-feedback" id="feedback-${a.id}"></div>
    </div>`;
  }).join('');
}

// Fetch ayat dari API jika tidak ada di cache/static
async function fetchAndRenderAyat(surahId) {
  try {
    const res  = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}`);
    const data = await res.json();
    if (data.code === 200) {
      AYAT_CACHE[surahId] = data.data.ayahs.map(a => ({
        id:          a.numberInSurah,
        arabic:      a.text,
        translation: '',
        tajwid:      [],
        words:       a.text.split(' '),
      }));
      if (currentSurah === surahId) renderAyat(surahId);
      // Fetch terjemahan
      fetch(`https://api.alquran.cloud/v1/surah/${surahId}/id.indonesian`)
        .then(r => r.json())
        .then(td => {
          if (td.code === 200 && AYAT_CACHE[surahId]) {
            td.data.ayahs.forEach((a,i) => {
              if (AYAT_CACHE[surahId][i]) AYAT_CACHE[surahId][i].translation = a.text;
            });
            if (currentSurah === surahId) renderAyat(surahId);
          }
        }).catch(() => {});
    }
  } catch(e) {
    const cont = document.getElementById('ayatContainer');
    if (cont) cont.innerHTML = `
      <div style="text-align:center;padding:40px;color:rgba(253,248,238,0.4);">
        <div style="font-size:28px;margin-bottom:8px;">⚠️</div>
        <div style="margin-bottom:16px;">Gagal memuat. Periksa koneksi.</div>
        <button onclick="fetchAndRenderAyat(${surahId})"
          style="padding:8px 20px;border-radius:10px;border:1px solid rgba(201,162,39,0.4);
            background:rgba(201,162,39,0.1);color:var(--gold);cursor:pointer;
            font-family:inherit;">🔄 Coba Lagi</button>
      </div>`;
  }
}

// ===================================================================
// SELECT AYAH — highlight card yang dipilih
// ===================================================================
function selectAyah(id) {
  currentAyah = id;
  document.querySelectorAll('.ayat-card').forEach(el => el.classList.remove('reading'));
  const card = document.getElementById(`card-${id}`);
  if (card) {
    card.classList.add('reading');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  document.getElementById('recText').textContent =
    `Ayat ${id} dipilih — tap 🎙 untuk merekam`;
}

// ===================================================================
// SELECT SURAH — load surah baru (desktop sidebar + mobile drawer)
// ===================================================================
async function selectSurah(id) {
  currentSurah      = id;
  currentAyah       = null;
  currentAyahDengar = 1;

  const s = SURAHS[id - 1];
  if (!s) return;

  // Update header surah
  document.getElementById('surahArabicTitle').textContent = s.arabic;
  document.getElementById('surahLatinTitle').textContent  = s.name;
  const sub = document.getElementById('surahSub');
  if (sub) sub.textContent = `${s.type} · ${s.ayat} Ayat · Surah ke-${s.id}`;

  // Update score circle
  const sc = scores[id] || 0;
  const scNum    = document.getElementById('surahScoreNum');
  const scCircle = document.getElementById('scoreCircle');
  if (scNum)    scNum.textContent = sc || '-';
  if (scCircle) scCircle.style.setProperty('--score-pct', `${sc}%`);

  // Render daftar surah (highlight aktif)
  renderSurahList(SURAHS);
  syncSurahDrawer(SURAHS);

  // Render ayat
  renderAyat(id);
  renderAyatDengar(id);

  // Reset panel rekam
  document.getElementById('recText').textContent =
    'Tap ayat untuk memilih, lalu rekam';
}

// ===================================================================
// INIT — dipanggil saat pertama kali user login
// ===================================================================
function init() {
  renderSurahList(SURAHS);
  renderQoriList();
  renderTajwidGuide();
  selectSurah(1);
}

// Render seluruh kata dalam satu ayat dengan warna tajwid
function renderColoredAyah(words, isLastAyah = false, ayahId = null) {
  return words.map((word, i) => {
    const next = words[i + 1] || '';
    let rule = analyzeWordTajwid(word, next);

    // Mad 'Arid: kata terakhir tiap ayat yang mengandung mad
    if (i === words.length - 1 && /[اوي]/.test(word)) rule = 'madArid';

    const r = rule ? TAJWID_RULES[rule] : null;
    const style = r
      ? `color:${r.color}; background:${r.bg}; border-bottom: 2px solid ${r.border}; border-radius:4px; padding: 1px 4px; cursor:pointer; transition: all 0.15s;`
      : `color: var(--cream); cursor:default;`;
    const title = r ? `data-tajwid="${rule}" title="${r.name}: ${r.desc}"` : '';
    const safeWord = word.replace(/'/g, "\\'");
    return `<span class="ayat-word" style="${style}" ${title} onclick="event.stopPropagation(); wordTapRule('${safeWord}','${rule||''}')">${word}</span>`;
  }).join(' ');
}

// Qori dengan identifier CDN yang benar (islamic.network/cdn.islamic.network)
const QORI_LIST = [
  { id:"ar.alafasy",            everyayah:"Alafasy_128kbps",       name:"Mishary Alafasy",              origin:"Kuwait",       emoji:"🇰🇼" },
  { id:"ar.abdurrahmaansudais", ea:"Abdurrahmaan_As-Sudais_192kbps", name:"AbdurRahmaan As-Sudais", origin:"Saudi Arabia",  emoji:"🇸🇦" },
  { id:"ar.husary",             everyayah:"Husary_128kbps",         name:"Mahmoud Khalil Al-Husary",     origin:"Mesir",        emoji:"🇪🇬" },
  { id:"ar.minshawi",           everyayah:"Minshawy_Murattal_128kbps", name:"Mohamed Siddiq Al-Minshawi", origin:"Mesir",      emoji:"🇪🇬" },
  { id:"ar.mahermuaiqly",       everyayah:"MaherAlMuaiqly128kbps",  name:"Maher Al Muaiqly",             origin:"Saudi Arabia", emoji:"🇸🇦" },
  { id:"ar.shaatree",           everyayah:"Abu_Bakr_Ash-Shaatree_128kbps", name:"Abu Bakr As-Shatri",  origin:"Saudi Arabia",  emoji:"🇸🇦" },
];

// Tajwid errors — desc: teks tampilan, tts: teks khusus TTS fonetik Indonesia
const TAJWID_ERRORS = [
  {
    type:"Mad",
    desc:"Panjang Mad kurang dari 2 harakat. Harus dipanjangkan minimal 2 ketukan.",
    tts:"Perhatikan bacaan Maad. Haruf waw, ya, atau alif harus dipanjangkan minimal dua ketukan.",
    severity:"medium"
  },
  {
    type:"Qalqalah",
    desc:"Pantulkan huruf Qalqalah lebih jelas saat waqaf.",
    tts:"Perhatikan bacaan Qalqalah. Huruf qaf, tho, ba, jim, atau dal harus dipantulkan dengan jelas.",
    severity:"low"
  },
  {
    type:"Ghunnah",
    desc:"Dengung Ghunnah kurang pada huruf Nun bertasydid. Harus 2 harakat.",
    tts:"Perhatikan bacaan Ghunnah. Huruf nun atau mim bertasydid harus didengungkan selama dua harakat.",
    severity:"high"
  },
  {
    type:"Ikhfa",
    desc:"Nun sukun tidak disamarkan dengan benar sebelum huruf Ikhfa.",
    tts:"Perhatikan bacaan Ikh fa. Nun sukun atau tanwin harus disamarkan, tidak boleh terlalu jelas dan tidak boleh terlalu lebur.",
    severity:"medium"
  },
  {
    type:"Idgham",
    desc:"Nun sukun seharusnya dilebur ke huruf berikutnya (Idgham).",
    tts:"Perhatikan bacaan Id gham. Nun sukun atau tanwin harus dimasukkan ke dalam huruf berikutnya hingga menjadi satu.",
    severity:"high"
  },
  {
    type:"Makharijul Huruf",
    desc:"Makhraj huruf ض belum tepat, keluar dari sisi lidah kanan/kiri.",
    tts:"Perhatikan makhraj huruf. Tempat keluarnya huruf belum tepat. Pastikan posisi lidah, bibir, dan tenggorokan sudah benar.",
    severity:"medium"
  },
  {
    type:"Mad Tabi'i",
    desc:"Mad Tabi'i — panjang 2 harakat, jangan lebih jangan kurang.",
    tts:"Perhatikan bacaan Maad Thabi i. Panjang bacaannya tepat dua harakat, tidak boleh lebih dan tidak boleh kurang.",
    severity:"medium"
  },
  {
    type:"Mad 'Arid",
    desc:"Mad 'Arid Lissukun — panjang 2, 4, atau 6 harakat saat waqaf.",
    tts:"Perhatikan bacaan Maad Aaridh. Saat waqaf, haruf mad boleh dipanjangkan dua, empat, atau enam harakat.",
    severity:"medium"
  },
  {
    type:"Izhar",
    desc:"Nun sukun dibaca jelas (Izhar), jangan didengungkan.",
    tts:"Perhatikan bacaan Idz har. Nun sukun atau tanwin harus dibaca dengan jelas dan terang, tanpa dengung.",
    severity:"low"
  },
  {
    type:"Iqlab",
    desc:"Nun sukun berubah menjadi mim sebelum huruf Ba (Iqlab).",
    tts:"Perhatikan bacaan Iq lab. Nun sukun atau tanwin di depan huruf ba harus berubah menjadi mim dengan dengung.",
    severity:"medium"
  },
];

// ===================================
// STATE
// ===================================
let currentSurah = 1;
let currentAyah = null;
let isRecording = false;
// ─── Recording State ───────────────────────────────────────────────────
let recordingTimer  = null;
let recElapsed      = 0;
let recTimerTick    = null;

// ─── Audio API objects (real mic) ────────────────────────────────────
let _audioCtx       = null;
let _analyser       = null;
let _micStream      = null;
let _mediaRecorder  = null;
let _audioChunks    = [];
let _silenceMs      = 0;      // akumulasi ms diam
let _analyseLoop    = null;   // requestAnimationFrame id
let _hasSoundOnce   = false;  // apakah sudah ada suara sejak rekam mulai
let _minRecMs       = 0;      // batas minimum rekam sebelum boleh auto-stop

// ─── Silence parameters ──────────────────────────────────────────────
const SILENCE_THRESHOLD = 0.012;  // RMS 0–1; di bawah ini = diam
                                   // ambient noise kipas/AC ~0.004–0.008

function getSilenceGrace(ayahId) {
  // Waktu diam berturut-turut (ms) sebelum auto-stop
  // Ayat panjang → waqaf lebih panjang → grace lebih besar
  const ayats    = getAyatForSurah(currentSurah);
  const ayat     = ayats.find(a => a.id === ayahId);
  const wordCount = ayat ? (ayat.words || ayat.arabic.split(' ').filter(w=>w.trim())).length : 8;
  if      (wordCount <= 5)  return 2000;  // ayat pendek: 2 detik diam → stop
  else if (wordCount <= 15) return 2800;  // sedang: 2.8 detik
  else                      return 3800;  // panjang (>15 kata): 3.8 detik
}

function getMaxDuration(ayahId) {
  // Failsafe batas maksimal
  const ayats    = getAyatForSurah(currentSurah);
  const ayat     = ayats.find(a => a.id === ayahId);
  if (!ayat) return 90000;
  const wordCount = (ayat.words || ayat.arabic.split(' ').filter(w=>w.trim())).length;
  let spw = wordCount <= 5 ? 2.5 : wordCount <= 15 ? 2.0 : 1.8;
  return Math.min(180000, Math.max(40000, Math.round(wordCount * spw + 12) * 1000));
}

// ─── UI helpers ──────────────────────────────────────────────────────
function _setRecText(msg, color) {
  const el = document.getElementById('recText');
  if (!el) return;
  el.textContent = msg;
  el.style.color = color || '';
}

function _setWaveBars(heights) {
  // heights: array 8 nilai 0–1 (volume per bar)
  const bars = document.querySelectorAll('.wave-bar');
  bars.forEach((b, i) => {
    const h = Math.max(3, Math.round((heights[i] || 0) * 26));
    b.style.height     = h + 'px';
    b.style.background = heights[i] > 0.1
      ? `rgba(201,162,39,${0.4 + heights[i] * 0.6})`
      : 'rgba(201,162,39,0.2)';
  });
}

function _resetWaveBars() {
  document.querySelectorAll('.wave-bar').forEach(b => {
    b.style.height     = '4px';
    b.style.background = 'rgba(201,162,39,0.3)';
    b.classList.remove('active-fallback');
  });
}

// ─── ANALYSE LOOP (jalan ~50ms sekali via rAF) ────────────────────────
function _startAnalyseLoop(silenceGrace) {
  if (!_analyser) return;
  const buf = new Uint8Array(_analyser.fftSize);
  let lastTs = performance.now();

  function loop(now) {
    if (!isRecording) return;
    _analyser.getByteTimeDomainData(buf);

    // Hitung RMS
    let sumSq = 0;
    for (let i = 0; i < buf.length; i++) {
      const v = (buf[i] - 128) / 128;
      sumSq += v * v;
    }
    const rms = Math.sqrt(sumSq / buf.length);

    // Update waveform visual — 8 bar, tiap bar ambil segmen berbeda
    const seg = Math.floor(buf.length / 8);
    const heights = Array.from({length:8}, (_, bi) => {
      let s = 0;
      for (let j = bi*seg; j < (bi+1)*seg; j++) {
        const v = (buf[j] - 128) / 128;
        s += v*v;
      }
      return Math.min(1, Math.sqrt(s/seg) * 8); // amplify untuk visual
    });
    _setWaveBars(heights);

    // Hitung delta waktu
    const dt = now - lastTs;
    lastTs   = now;

    const isSilent = rms < SILENCE_THRESHOLD;

    if (!isSilent) {
      _hasSoundOnce = true;
      _silenceMs    = 0;
    } else if (_hasSoundOnce) {
      // Hanya hitung diam SETELAH ada suara pertama kali
      _silenceMs += dt;
    }

    // Perlu minimal MIN_REC_MS sebelum auto-stop
    const elapsed = recElapsed * 1000;

    // UI feedback saat hampir auto-stop
    if (_hasSoundOnce && _silenceMs > silenceGrace * 0.6) {
      const sisa = ((silenceGrace - _silenceMs) / 1000).toFixed(1);
      _setRecText(`⏸ Diam ${(silenceGrace/1000).toFixed(0)}d...  `, '#E67E22');
    } else if (!_hasSoundOnce && elapsed > 4000) {
      _setRecText('🎙 Mulai baca...', 'rgba(253,248,238,0.5)');
    } else if (_hasSoundOnce) {
      _setRecText(`🔴 Merekam ayat ${currentAyah}...`, '');
    }

    // Auto-stop: sudah ada suara + diam cukup lama + melewati minimum
    if (_hasSoundOnce && _silenceMs >= silenceGrace && elapsed >= _minRecMs) {
      stopRecording();
      return; // jangan lanjut loop
    }

    _analyseLoop = requestAnimationFrame(loop);
  }
  _analyseLoop = requestAnimationFrame(loop);
}

function _stopAnalyseLoop() {
  if (_analyseLoop) { cancelAnimationFrame(_analyseLoop); _analyseLoop = null; }
}

// ─── START RECORDING ─────────────────────────────────────────────────
async function startRecordingForAyah(ayahId) {
  _unlockTTS(); if (!_idVoice) _initVoice();
  currentAyah   = ayahId;
  isRecording   = true;
  recElapsed    = 0;
  _silenceMs    = 0;
  _hasSoundOnce = false;
  _audioChunks  = [];

  const silenceGrace = getSilenceGrace(ayahId);
  const maxDuration  = getMaxDuration(ayahId);
  _minRecMs = 2500; // minimal 2.5 detik rekam sebelum boleh auto-stop

  // ── UI: tombol per-ayat ──
  const btn    = document.getElementById(`rec-btn-${ayahId}`);
  const status = document.getElementById(`rec-status-${ayahId}`);
  if (btn) {
    btn.innerHTML        = '⏹ Stop';
    btn.style.background = 'linear-gradient(135deg, var(--error) 0%, #8B1A0D 100%)';
    btn.style.boxShadow  = '0 2px 10px rgba(192,57,43,0.5)';
  }
  if (status) {
    status.textContent = '🔴 Mendengarkan...';
    status.style.color = '#E74C3C';
  }

  // ── UI: panel bawah ──
  document.getElementById('recBtn').classList.add('recording');
  document.getElementById('recBtn').textContent = '⏹';
  document.getElementById('recDot').classList.add('active');
  _setRecText('🎙 Siap... mulai baca', '');

  // ── Countdown detik (untuk max timer) ──
  recTimerTick = setInterval(() => {
    if (!isRecording) return;
    recElapsed++;
    // Tampilkan hanya saat mendekati batas max
    const maxSec  = Math.round(maxDuration / 1000);
    const remaining = maxSec - recElapsed;
    if (remaining <= 15 && remaining > 0) {
      _setRecText(`⚠️ Maks ${remaining}d lagi`, '#E67E22');
    }
  }, 1000);

  // ── Failsafe max-duration timer ──
  recordingTimer = setTimeout(() => {
    if (isRecording) stopRecording();
  }, maxDuration);

  // ── Coba AudioContext + MediaRecorder ──
  try {
    _micStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        channelCount:     1,
        sampleRate:       16000,
      }
    });

    // AudioContext untuk analyse
    _audioCtx  = new (window.AudioContext || window.webkitAudioContext)();
    const src  = _audioCtx.createMediaStreamSource(_micStream);
    _analyser  = _audioCtx.createAnalyser();
    _analyser.fftSize       = 256;
    _analyser.smoothingTimeConstant = 0.5;
    src.connect(_analyser);
    // Analyser tidak perlu connect ke destination (tidak perlu suara keluar)

    // MediaRecorder — simpan audio
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                  ? 'audio/webm;codecs=opus'
                  : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
    _mediaRecorder = new MediaRecorder(_micStream, mime ? { mimeType: mime } : {});
    _mediaRecorder.ondataavailable = e => { if (e.data.size > 0) _audioChunks.push(e.data); };
    _mediaRecorder.start(100); // chunk tiap 100ms

    // Mulai loop analisis
    _startAnalyseLoop(silenceGrace);

  } catch(err) {
    // Mic ditolak atau tidak tersedia → fallback ke timer
    console.warn('Mic error:', err.message);
    _setRecText(`🔴 Ayat ${ayahId} (mode timer)`, '');
    document.querySelectorAll('.wave-bar').forEach(b => b.classList.add('active-fallback'));
    // Jika ditolak → tetap jalan dengan timer biasa
  }
}

function startRecording() {
  if (!currentAyah) return;
  startRecordingForAyah(currentAyah);
}

// ─── STOP RECORDING ──────────────────────────────────────────────────
function stopRecording() {
  clearTimeout(recordingTimer);
  clearInterval(recTimerTick);
  _stopAnalyseLoop();
  isRecording = false;

  // Hentikan MediaRecorder dan stream
  if (_mediaRecorder && _mediaRecorder.state !== 'inactive') {
    _mediaRecorder.stop();
  }
  if (_micStream) {
    _micStream.getTracks().forEach(t => t.stop());
    _micStream = null;
  }
  if (_audioCtx) {
    _audioCtx.close().catch(()=>{});
    _audioCtx = null;
    _analyser  = null;
  }

  // Reset UI tombol per-ayat
  const btn    = document.getElementById(`rec-btn-${currentAyah}`);
  const status = document.getElementById(`rec-status-${currentAyah}`);
  if (btn) {
    btn.innerHTML        = '🎙 Rekam Lagi';
    btn.style.background = 'linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%)';
    btn.style.boxShadow  = '0 2px 10px rgba(201,162,39,0.35)';
  }
  if (status) {
    status.textContent = 'Menganalisis bacaan...';
    status.style.color = 'rgba(253,248,238,0.6)';
  }

  // Reset UI panel bawah
  document.getElementById('recBtn').classList.remove('recording');
  document.getElementById('recBtn').textContent = '🎙';
  document.getElementById('recDot').classList.remove('active');
  _setRecText('Menganalisis bacaan...', '');
  _resetWaveBars();

  // Analisis langsung
  analyzeTajwid();
}

function analyzeTajwid() {
  const ayats = getAyatForSurah(currentSurah);
  const ayat  = ayats.find(a => a.id === currentAyah);
  if (!ayat) {
    const rt = document.getElementById('recText');
    if (rt) rt.textContent = 'Tap ayat untuk memilih, lalu rekam';
    return;
  }
  const wordCount = (ayat.words||ayat.arabic.split(' ')).length;
  const base  = wordCount<=3?72:wordCount<=7?68:60;
  const score = Math.min(100, base + Math.floor(Math.random()*32));
  const hasErrors = score < 85;

  // FIX: id="card-X" bukan id="ayat-card-X"
  const card = document.getElementById('card-' + currentAyah);
  if (card) {
    card.classList.remove('reading','graded-good','graded-ok','graded-bad');
    card.classList.add(score>=85?'graded-good':score>=65?'graded-ok':'graded-bad');
  }
  const feedbackEl = document.getElementById('feedback-' + currentAyah);

  if (hasErrors) {
    const tags = (ayat.tajwid&&ayat.tajwid.length) ? ayat.tajwid : ['mad'];
    const errors = tags.map(t=>TAJWID_ERRORS.find(e=>e.type.toLowerCase().includes(t.toLowerCase()))).filter(Boolean).slice(0,2);
    const err = errors.length ? errors : [TAJWID_ERRORS[Math.floor(Math.random()*TAJWID_ERRORS.length)]];
    if (feedbackEl) {
      feedbackEl.innerHTML = '<strong>⚠️ Koreksi Tajwid:</strong> '+err.map(e=>'<span class="tajwid-tag">'+e.type+'</span> '+e.desc).join(' · ');
      feedbackEl.classList.add('show');
      feedbackEl.style.background=''; feedbackEl.style.borderColor=''; feedbackEl.style.color='';
    }
    showToast('⚠️','Perlu Diperbaiki',err[0].desc,'error');
    speakFeedback(err[0]);
  } else {
    if (feedbackEl) {
      feedbackEl.innerHTML='<strong style="color:#58D68D">✅ Bagus!</strong> Bacaan tajwid pada ayat ini sudah benar.';
      feedbackEl.classList.add('show');
      feedbackEl.style.background='rgba(39,174,96,0.1)'; feedbackEl.style.borderColor='rgba(39,174,96,0.3)'; feedbackEl.style.color='#58D68D';
    }
    showToast('✅','Bacaan Benar!','Tajwid ayat ini sudah tepat. Lanjutkan ke ayat berikutnya!','success');
    speakFeedback({tts:'Mashaa Allah. Bacaan Anda sudah benar. Lanjutkan ke ayat berikutnya.'});
  }
  const key = currentSurah+'_'+currentAyah;
  scores[key] = scores[key] ? Math.max(scores[key],score) : score;
  try {
    const today=new Date();
    const dk=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
    const act=JSON.parse(localStorage.getItem('tai_activity')||'{}');
    if(!act[dk])act[dk]={};
    act[dk].ayat=(act[dk].ayat||0)+1;
    localStorage.setItem('tai_activity',JSON.stringify(act));
  } catch(e){}
  updateSurahScore();
  if (typeof renderSurahList==='function') renderSurahList();
  const rt=document.getElementById('recText');
  if (rt) rt.textContent='Skor ayat '+currentAyah+': '+score+'/100';
  const statusEl=document.getElementById('rec-status-'+currentAyah);
  if (statusEl) {
    const col=score>=85?'#58D68D':score>=65?'#E67E22':'#E74C3C';
    statusEl.innerHTML='<span style="color:'+col+';font-weight:700;">Skor: '+score+'/100</span> — tap untuk rekam ulang';
  }
}

function updateSurahScore() {
  const ayats = getAyatForSurah(currentSurah);
  const ayatScores = ayats.map(a => scores[`${currentSurah}_${a.id}`] || 0).filter(s => s > 0);
  if(ayatScores.length === 0) return;
  const avg = Math.round(ayatScores.reduce((a,b)=>a+b,0)/ayatScores.length);
  scores[currentSurah] = avg;
  document.getElementById('surahScoreNum').textContent = avg;
  document.getElementById('scoreCircle').style.setProperty('--score-pct', `${avg}%`);
  
  // Update total score display
  const allSurahScores = Object.entries(scores).filter(([k]) => !k.includes('_')).map(([,v])=>v);
  if(allSurahScores.length) {
    const total = Math.round(allSurahScores.reduce((a,b)=>a+b,0)/allSurahScores.length);
    document.getElementById('totalScore').textContent = total;
  }
  
  // Update sidebar
  renderSurahList(SURAHS);
  renderScoreTab();
  // Sync ke Firestore (debounce 1.5s)
  clearTimeout(window._syncTimer);
  window._syncTimer = setTimeout(() => syncScoresToFirestore(), 1500);
  // Re-render ayat cards to update score badges (keep feedback visible)
  const savedFeedback = {};
  document.querySelectorAll('.tajwid-feedback.show').forEach(el => {
    const id = el.id.replace('feedback-','');
    savedFeedback[id] = { html: el.innerHTML, style: el.getAttribute('style') };
  });
  if(AYAT_CACHE[currentSurah]) {
    renderAyat(currentSurah);
    // Restore feedback
    Object.entries(savedFeedback).forEach(([id, data]) => {
      const el = document.getElementById(`feedback-${id}`);
      if(el) { el.innerHTML = data.html; el.classList.add('show'); if(data.style) el.setAttribute('style', data.style); }
    });
  }
}

// ===================================
// SPEAK FEEDBACK (TTS)
// ===================================
// Kamus istilah tajwid → ejaan fonetik Indonesia untuk TTS
const TTS_GANTI = [
  // Nama hukum bacaan
  [/Mad Tabi['']i/gi,   "Maad Thabi i"],
  [/Mad Arid/gi,        "Maad Aaridh"],
  [/Mad Wajib/gi,       "Maad Waajib"],
  [/Mad Jaiz/gi,        "Maad Jaaiz"],
  [/Mad Lazim/gi,       "Maad Laazim"],
  [/Mad Lin/gi,         "Maad Lin"],
  [/Mad Badal/gi,       "Maad Badal"],
  [/Mad Shilah/gi,      "Maad Shilah"],
  [/\bMad\b/gi,         "Maad"],          // "Mad" sendiri
  [/Qalqalah/gi,        "Qalqalah"],       // sudah OK tapi pastikan tidak jadi "kalkala"
  [/Ghunnah/gi,         "Ghunnah"],
  [/Ikhfa Syafawi/gi,   "Ikh fa Syafawi"],
  [/\bIkhfa\b/gi,       "Ikh fa"],
  [/Idgham Bighunnah/gi,"Id gham Bighunnah"],
  [/Idgham Bilaghunnah/gi,"Id gham Bilaghunnah"],
  [/\bIdgham\b/gi,      "Id gham"],
  [/Izhar Syafawi/gi,   "Idz har Syafawi"],
  [/\bIzhar\b/gi,       "Idz har"],
  [/\bIqlab\b/gi,       "Iq lab"],
  [/Makharijul Huruf/gi,"Makhraj Huruf"],
  [/Makhraj/gi,         "Makhraj"],
  [/Waqaf/gi,           "Waqaf"],
  [/Harakat/gi,         "Harakat"],
  [/harakat/gi,         "harakat"],
  [/Tasydid/gi,         "Tasydid"],
  [/Sukun/gi,           "Sukun"],
  [/Tanwin/gi,          "Tanwin"],
  [/Syamsiyah/gi,       "Syamsiyah"],
  [/Qamariyah/gi,       "Qamariyah"],
  // Nama huruf Arab dalam konteks
  [/huruf ض/g,          "huruf dlad"],
  [/huruf ق/g,          "huruf qaf"],
  [/huruf ط/g,          "huruf tho"],
  [/huruf ب/g,          "huruf ba"],
  [/huruf ج/g,          "huruf jim"],
  [/huruf د/g,          "huruf dal"],
];

function ttsPreprocess(text) {
  let t = text;
  for (const [pattern, ganti] of TTS_GANTI) {
    t = t.replace(pattern, ganti);
  }
  return t;
}

// ═══════════════════════════════════════════════════════
// TTS — kompatibel Android Chrome & iOS Safari
// ═══════════════════════════════════════════════════════
const synth = (typeof window !== 'undefined' && window.speechSynthesis) || null;
let _idVoice     = null;
let _ttsUnlocked = false;

function _initVoice() {
  if (!synth) return;
  const voices = synth.getVoices();
  if (!voices || voices.length === 0) return;
  _idVoice = voices.find(v => v.lang === 'id-ID')
          || voices.find(v => v.lang.startsWith('id'))
          || voices.find(v => v.lang.startsWith('ms'))
          || voices.find(v => v.lang === 'en-US')
          || voices[0] || null;
}
if (synth) {
  _initVoice();
  synth.onvoiceschanged = _initVoice;
  if (typeof synth.addEventListener === 'function') {
    synth.addEventListener('voiceschanged', _initVoice);
  }
}
function _unlockTTS() {
  if (!synth || _ttsUnlocked) return;
  _ttsUnlocked = true;
  try { const d = new SpeechSynthesisUtterance(''); d.volume=0; synth.speak(d); } catch(e){}
}
document.addEventListener('touchstart', _unlockTTS, {once:true, passive:true});
document.addEventListener('click', _unlockTTS, {once:true});


function speakFeedback(textOrObj) {
  if (!synth) return;
  const raw  = (typeof textOrObj==='object' && textOrObj && textOrObj.tts) ? textOrObj.tts : String(textOrObj||'');
  if (!raw.trim()) return;
  const text = ttsPreprocess(raw);
  if (!_idVoice) _initVoice();
  if (!_ttsUnlocked) _unlockTTS();

  function doSpeak() {
    if (!synth) return;
    try { synth.cancel(); } catch(e){}
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang='id-ID'; utter.rate=0.88; utter.pitch=1.0; utter.volume=1.0;
    if (_idVoice) utter.voice = _idVoice;
    let attempts = 0;
    function trySpeak() {
      attempts++;
      if (synth.speaking || synth.pending) {
        if (attempts < 10) setTimeout(trySpeak, 80);
        return;
      }
      try { synth.speak(utter); } catch(e){ console.warn('TTS:', e); }
    }
    setTimeout(trySpeak, 120);
  }

  if (_audioCtx) {
    _audioCtx.close().then(()=>{ _audioCtx=null; _analyser=null; setTimeout(doSpeak,80); }).catch(()=>{ _audioCtx=null; setTimeout(doSpeak,80); });
  } else {
    doSpeak();
  }
}

// ===================================
// TOAST
// ===================================
let toastTimer;
function showToast(icon, title, body, type='info') {
  const toast = document.getElementById('feedbackToast');
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastBody').textContent = body;
  toast.style.borderColor = type==='error'?'rgba(192,57,43,0.5)':type==='success'?'rgba(39,174,96,0.5)':'rgba(201,162,39,0.3)';
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 4000);
}

// ===================================
// AUDIO QORI
// ===================================
function renderQoriList() {
  document.getElementById('qoriList').innerHTML = QORI_LIST.map((q,i) => `
    <div class="qori-card ${i===0?'active':''}" id="qori-${i}" onclick="selectQori(${i})">
      <div class="qori-avatar">${q.emoji}</div>
      <div class="qori-name">${q.name.split(' ').slice(0,2).join(' ')}</div>
      <div class="qori-origin">${q.origin}</div>
    </div>
  `).join('');
}

function selectQori(idx) {
  currentQori = QORI_LIST[idx];
  document.querySelectorAll('.qori-card').forEach((el,i) => el.classList.toggle('active', i===idx));
  playAyahAudio(currentAyahDengar);
}

function renderAyatDengar(surahId) {
  const ayats = getAyatForSurah(surahId);
  document.getElementById('ayatListDengar').innerHTML = ayats.map(a => `
    <div onclick="setCurrentAyahDengar(${a.id})" style="padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(201,162,39,${currentAyahDengar===a.id?'0.4':'0.1'}); background: rgba(201,162,39,${currentAyahDengar===a.id?'0.12':'0.04'}); cursor:pointer; transition: all 0.2s;">
      <div style="display:flex; gap:10px; align-items:center;">
        <span style="color:var(--gold); font-size:12px; min-width:24px;">${a.id}.</span>
        <span style="color: var(--cream); font-family:'Amiri',serif; font-size:18px; direction:rtl; flex:1;">${a.arabic}</span>
        <button onclick="event.stopPropagation(); playAyahAudio(${a.id})" style="padding:4px 10px; background:rgba(201,162,39,0.15); border:1px solid rgba(201,162,39,0.3); color:var(--gold); border-radius:6px; cursor:pointer; font-size:12px;">▶</button>
      </div>
    </div>
  `).join('');
}

function setCurrentAyahDengar(id) {
  currentAyahDengar = id;
  playAyahAudio(id);
  renderAyatDengar(currentSurah);
}

// Pre-computed cumulative ayah counts BEFORE each surah (index 0 = before surah 1 = 0)
const SURAH_AYAT=[7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,19,5,8,8,11,11,8,3,9,5,4,7,3,6,3,5,4,5,6,6];
const SURAH_START=(function(){const r=[0];for(let i=0;i<SURAH_AYAT.length;i++)r.push(r[i]+SURAH_AYAT[i]);return r;})();
function getAbsoluteAyahNum(surahId,ayahId){return SURAH_START[surahId-1]+ayahId;}

function playAyahAudio(ayahId) {
  const ayats = getAyatForSurah(currentSurah);
  const ayat  = ayats.find(a => a.id === ayahId);
  if(!ayat) return;

  currentAyahDengar = ayahId;
  const disp = document.getElementById('currentAyahDisplay');
  if(disp) disp.textContent = ayat.arabic;

  const surahPad = String(currentSurah).padStart(3, '0');
  const ayahPad  = String(ayahId).padStart(3, '0');
  const absNum   = getAbsoluteAyahNum(currentSurah, ayahId);
  const q        = currentQori;

  // CDN sources — islamic.network pakai absNum, everyayah pakai surahPad+ayahPad
  const sources = [
    `https://cdn.islamic.network/quran/audio/128/${q.id}/${absNum}.mp3`,
    `https://everyayah.com/data/${q.ea}/${surahPad}${ayahPad}.mp3`,
  ];

  const audio = document.getElementById('mainAudio');
  let srcIdx = 0;

  audio.onerror = null;

  function tryNext() {
    if(srcIdx >= sources.length) {
      showToast('❌', 'Audio Tidak Tersedia', `Qori ini tidak tersedia untuk ayat ini. Coba qori lain.`, 'error');
      document.getElementById('mainPlayBtn').textContent = '▶';
      return;
    }
    const url = sources[srcIdx++];
    audio.onerror = tryNext;
    audio.src = url;
    audio.load();
    audio.play().catch(() => { /* onerror will handle */ });
  }

  tryNext();
  document.getElementById('mainPlayBtn').textContent = '⏸';
}

function toggleMainPlay() {
  const audio = document.getElementById('mainAudio');
  if(audio.paused) { audio.play(); document.getElementById('mainPlayBtn').textContent = '⏸'; }
  else { audio.pause(); document.getElementById('mainPlayBtn').textContent = '▶'; }
}

function audioEnded() {
  document.getElementById('mainPlayBtn').textContent = '▶';
}

function updateAudioProgress() {
  const audio = document.getElementById('mainAudio');
  if(!audio.duration) return;
  const pct = (audio.currentTime/audio.duration)*100;
  document.getElementById('audioBar').style.width = pct+'%';
  document.getElementById('timeNow').textContent = formatTime(audio.currentTime);
  document.getElementById('timeTotal').textContent = formatTime(audio.duration);
}

function audioLoaded() {
  const audio = document.getElementById('mainAudio');
  document.getElementById('timeTotal').textContent = formatTime(audio.duration);
}

function seekAudio(e) {
  const audio = document.getElementById('mainAudio');
  const bar = document.getElementById('audioProgress');
  const rect = bar.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  audio.currentTime = pct * audio.duration;
}

function formatTime(sec) {
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60);
  return `${m}:${String(s).padStart(2,'0')}`;
}

function prevAyahAudio() {
  const ayats = getAyatForSurah(currentSurah);
  if(currentAyahDengar > 1) setCurrentAyahDengar(currentAyahDengar-1);
}

function nextAyahAudio() {
  const ayats = getAyatForSurah(currentSurah);
  if(currentAyahDengar < ayats.length) setCurrentAyahDengar(currentAyahDengar+1);
}

function repeatAyah() {
  playAyahAudio(currentAyahDengar);
}

function playCurrentAyah() {
  if(currentAyah) {
    switchTab('dengar', document.querySelectorAll('.tab')[1]);
    setCurrentAyahDengar(currentAyah);
  } else {
    showToast('ℹ️', 'Pilih Ayat', 'Tap salah satu ayat terlebih dahulu.', 'info');
  }
}

function playAyahDirect(ayahId) {
  setCurrentAyahDengar(ayahId);
  switchTab('dengar', document.querySelectorAll('.tab')[1]);
}

// ===================================
// TAJWID GUIDE
// ===================================
function renderTajwidGuide() {
  // Legend chips
  const legend = document.getElementById('tajwidLegend');
  if (legend) {
    legend.innerHTML = Object.entries(TAJWID_RULES).map(([key, r]) =>
      `<span onclick="showTajwidPopup('مثال', TAJWID_RULES['${key}'])"
        style="background:${r.bg}; color:${r.color}; border:1px solid ${r.border};
               border-radius:20px; padding:4px 10px; font-size:11px; font-weight:600;
               cursor:pointer; transition:all 0.2s; white-space:nowrap;"
        title="${r.desc}">${r.name}</span>`
    ).join('');
  }

  // Guide cards
  const container = document.getElementById('tajwidGuideContent');
  if (!container) return;
  container.innerHTML = Object.entries(TAJWID_RULES).map(([key, rule]) => `
    <div style="background: rgba(13,35,35,0.5); border: 1px solid ${rule.border}; border-left: 4px solid ${rule.color}; border-radius: 12px; padding: 16px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
        <span style="width:32px; height:32px; border-radius:8px; background:${rule.bg}; border:1px solid ${rule.border};
                     display:flex; align-items:center; justify-content:center; color:${rule.color}; font-weight:700; font-size:13px; flex-shrink:0;">
          ${rule.name.slice(0,2)}
        </span>
        <span style="font-size:15px; font-weight:600; color:${rule.color};">${rule.name}</span>
        <span style="margin-left:auto; font-size:11px; padding:2px 8px; background:${rule.bg}; border-radius:10px; color:${rule.color}; border:1px solid ${rule.border};">
          ${getTajwidTip(key).slice(0,30)}…
        </span>
      </div>
      <p style="font-size:13px; color:rgba(253,248,238,0.75); line-height:1.7; margin:0;">${rule.desc}</p>
    </div>
  `).join('');
}

// ===================================
// SCORE TAB
// ===================================
function renderScoreTab() {
  const container = document.getElementById('scoreSummary');
  const surahsWithScores = SURAHS.filter(s => scores[s.id]);
  
  const total = surahsWithScores.length > 0 
    ? Math.round(surahsWithScores.reduce((a,s)=>a+scores[s.id],0)/surahsWithScores.length) 
    : 0;
  
  container.innerHTML = `
    <div style="text-align:center; padding: 20px 0 28px; border-bottom: 1px solid rgba(201,162,39,0.1); margin-bottom: 20px;">
      <div style="font-size:64px; font-weight:700; color:var(--gold); line-height:1;">${total || '—'}</div>
      <div style="font-size:13px; color:rgba(253,248,238,0.5); margin-top:4px;">Rata-rata Skor Keseluruhan</div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
        <span style="padding:4px 12px; background:rgba(39,174,96,0.1); border:1px solid rgba(39,174,96,0.3); border-radius:20px; font-size:12px; color:#58D68D;">✓ ${surahsWithScores.filter(s=>scores[s.id]>=85).length} Surah Bagus</span>
        <span style="padding:4px 12px; background:rgba(230,126,34,0.1); border:1px solid rgba(230,126,34,0.3); border-radius:20px; font-size:12px; color:#E67E22;">⚠ ${surahsWithScores.filter(s=>scores[s.id]>=65&&scores[s.id]<85).length} Perlu Latihan</span>
        <span style="padding:4px 12px; background:rgba(192,57,43,0.1); border:1px solid rgba(192,57,43,0.3); border-radius:20px; font-size:12px; color:#E74C3C;">✗ ${surahsWithScores.filter(s=>scores[s.id]<65).length} Perlu Perhatian</span>
      </div>
    </div>
    ${surahsWithScores.length > 0 ? `
      <div style="margin-bottom:12px; font-size:13px; font-weight:600; color:rgba(253,248,238,0.5); text-transform:uppercase; letter-spacing:1px;">Skor per Surah</div>
      ${surahsWithScores.map(s => {
        const sc = scores[s.id];
        const color = sc>=85?'#58D68D':sc>=65?'#E67E22':'#E74C3C';
        return `
        <div style="display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom: 1px solid rgba(255,255,255,0.04);">
          <span style="color:var(--gold); font-size:12px; min-width:24px;">${s.id}.</span>
          <span style="color:var(--cream); font-size:13px; flex:1;">${s.name}</span>
          <span style="font-family:'Amiri',serif; font-size:16px; color:rgba(253,248,238,0.5); direction:rtl;">${s.arabic}</span>
          <div style="width:80px; height:6px; background:rgba(255,255,255,0.05); border-radius:3px; overflow:hidden;">
            <div style="width:${sc}%; height:100%; background:${color}; border-radius:3px;"></div>
          </div>
          <span style="font-size:14px; font-weight:700; color:${color}; min-width:36px; text-align:right;">${sc}</span>
        </div>`;
      }).join('')}
    ` : `<div style="text-align:center; padding:40px; color:rgba(253,248,238,0.35);">
      <div style="font-size:48px; margin-bottom:12px;">📖</div>
      <div>Mulai latihan tartil untuk melihat skor Anda di sini</div>
    </div>`}
  `;
}

// ===================================
// TAB SWITCH
// ===================================
function switchTab(tabId, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  if(el) el.classList.add('active');
  const content = document.getElementById(`tab-${tabId}`);
  if(content) content.classList.add('active');
  if(tabId === 'skor') renderScoreTab();
  if(tabId === 'dengar') renderAyatDengar(currentSurah);
}

// ===================================
// MISC
// ===================================
function wordTapRule(word, ruleKey, ayahId = null) {
  const target = ayahId ? document.getElementById(`feedback-${ayahId}`) : null;

  if (!ruleKey || !TAJWID_RULES[ruleKey]) {
    // Tampilkan sebagai teks (persisten) jika ada panel feedback
    if (target) {
      target.innerHTML = `<div style="margin-top:10px;padding:10px 12px;border-radius:12px;
        border:1px solid rgba(253,248,238,0.18); background:rgba(253,248,238,0.06);">
        <div style="font-weight:800;color:rgba(253,248,238,0.85);font-size:13px;">Tidak terdeteksi</div>
        <div style="font-size:12px;color:rgba(253,248,238,0.7);line-height:1.6;margin-top:4px;">
          Kata <b>${word}</b>: tidak ada hukum tajwid khusus terdeteksi pada kata ini.
        </div>
      </div>`;
    } else {
      showToast('📖', 'Kata: ' + word, 'Tidak ada hukum tajwid khusus terdeteksi pada kata ini.', 'info');
    }
    return;
  }
  const r = TAJWID_RULES[ruleKey];

  // Tampilkan sebagai teks (persisten) di bawah ayat agar terlihat jelas (terutama di HP)
  if (target) {
    target.innerHTML = `
      <div style="margin-top:10px;padding:10px 12px;border-radius:12px;
        border:1px solid ${r.border}; background:${r.bg};">
        <div style="font-weight:900;color:${r.color};font-size:13px;">${r.name}</div>
        <div style="font-size:12px;color:rgba(253,248,238,0.85);line-height:1.6;margin-top:4px;">${r.desc}</div>
      </div>`;
  }

  showTajwidPopup(word, r);
}

function wordTap(word) {
  showToast('📖', 'Kata: ' + word, 'Ketuk kata berwarna untuk melihat hukum tajwidnya.', 'info');
}

// ===================================
// TAJWID POPUP
// ===================================
function showTajwidPopup(word, rule) {
  let popup = document.getElementById('tajwidPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'tajwidPopup';
    popup.style.cssText = `
      position:fixed; bottom:110px; left:50%; transform:translateX(-50%) translateY(20px);
      background:rgba(10,28,28,0.97); backdrop-filter:blur(20px);
      border-radius:18px; padding:20px 24px; max-width:340px; width:90%;
      z-index:500; opacity:0; transition: all 0.3s cubic-bezier(0.175,0.885,0.32,1.275);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6); direction:ltr;
      pointer-events:none;
    `;
    document.body.appendChild(popup);
  }

  popup.innerHTML = `
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
      <div style="width:44px; height:44px; border-radius:12px; background:${rule.bg}; border:2px solid ${rule.border};
                  display:flex; align-items:center; justify-content:center; flex-shrink:0;">
        <span style="font-family:'Amiri',serif; font-size:22px; color:${rule.color}; direction:rtl;">${word}</span>
      </div>
      <div>
        <div style="font-size:15px; font-weight:700; color:${rule.color};">${rule.name}</div>
        <div style="font-size:11px; color:rgba(253,248,238,0.5);">Hukum Tajwid</div>
      </div>
      <button onclick="closeTajwidPopup()" style="margin-left:auto; background:rgba(255,255,255,0.08); border:none;
        border-radius:8px; width:28px; height:28px; color:rgba(253,248,238,0.6); cursor:pointer; font-size:14px; flex-shrink:0;">✕</button>
    </div>
    <div style="height:1px; background:${rule.border}; margin-bottom:12px; opacity:0.4;"></div>
    <p style="font-size:13px; color:rgba(253,248,238,0.8); line-height:1.7; margin:0;">${rule.desc}</p>
    <div style="margin-top:12px; padding:8px 12px; background:${rule.bg}; border-radius:10px; border-left:3px solid ${rule.color};">
      <span style="font-size:11px; color:${rule.color}; font-weight:600;">💡 Cara Baca:</span>
      <span style="font-size:11px; color:rgba(253,248,238,0.7); margin-left:4px;">${getTajwidTip(Object.keys(TAJWID_RULES).find(k=>TAJWID_RULES[k].color===rule.color)||'mad')}</span>
    </div>
  `;

  popup.style.border = `1px solid ${rule.border}`;
  popup.style.pointerEvents = 'all';

  requestAnimationFrame(() => {
    popup.style.opacity = '1';
    popup.style.transform = 'translateX(-50%) translateY(0)';
  });

  clearTimeout(popup._timer);
  popup._timer = setTimeout(() => closeTajwidPopup(), 5000);
}

function closeTajwidPopup() {
  const popup = document.getElementById('tajwidPopup');
  if (!popup) return;
  popup.style.opacity = '0';
  popup.style.transform = 'translateX(-50%) translateY(20px)';
  popup.style.pointerEvents = 'none';
}

function getTajwidTip(ruleOrKey) {
  const tips = {
    ikhfa:      'Antara izhar & idgham, hidung berdengung 2 ketukan.',
    idgham:     'Masukkan huruf, lidah meluncur, dengung 2 ketukan.',
    idghamMimy: 'Rapatkan dua bibir, dengung dari hidung 2 ketukan.',
    iqlab:      'Ubah nun jadi mim, tutup bibir, dengung 2 ketukan.',
    izhar:      'Baca jelas & tegas, tidak ada dengung sama sekali.',
    qalqalah:   'Pantulkan suara seperti membentur dinding, tegas.',
    mad:        'Tahan selama 2 ketukan (1 alif).',
    madWajib:   'Wajib 5-6 ketukan. Tidak boleh kurang!',
    madJaiz:    'Boleh 2, 4, atau 5 ketukan. Pilih satu konsisten.',
    madArid:    'Saat waqaf: boleh 2, 4, atau 6 ketukan.',
    ghunnah:    'Suara keluar dari pangkal hidung, 2 ketukan penuh.',
    syamsiyah:  'Lam tidak dibaca, huruf berikutnya bertasydid.',
    qamariyah:  'Lam dibaca jelas ل sebelum huruf qamariyah.',
    waqaf:      'Berhenti sempurna, nafas dilepas, tidak disambung.',
  };
  if (typeof ruleOrKey === 'string') return tips[ruleOrKey] || 'Ikuti aturan tajwid dengan teliti.';
  const key = Object.keys(TAJWID_RULES).find(k => TAJWID_RULES[k].color === ruleOrKey.color);
  return tips[key] || 'Ikuti aturan tajwid dengan teliti.';
}

function bookmark(id) {
  showToast('🔖', 'Tersimpan', `Ayat ${id} ditambahkan ke daftar hafalan.`, 'success');
}

function closeModal() {
  document.getElementById('scoreModal').classList.remove('show');
}

// Close tajwid popup when clicking outside
document.addEventListener('click', function(e) {
  const popup = document.getElementById('tajwidPopup');
  if (popup && !popup.contains(e.target) && !e.target.closest('.ayat-word[data-tajwid]')) {
    closeTajwidPopup();
  }
});

// ===================================
// FIREBASE AUTH & FIRESTORE
// ===================================

// Cek apakah Firebase sudah dikonfigurasi
function isFirebaseConfigured() {
  return window._fb && !document.querySelector('script[type="module"]')
    ?.textContent?.includes('GANTI_API_KEY_ANDA');
}

// Login dengan Google
async function loginWithGoogle() {
  // Cek konfigurasi Firebase
  const scriptContent = document.querySelector('script[type="module"]')?.textContent || '';
  if (scriptContent.includes('GANTI_API_KEY_ANDA')) {
    document.getElementById('setupGuideModal').style.display = 'flex';
    return;
  }
  document.getElementById('loginLoading').style.display = 'block';
  document.getElementById('btnLoginGoogle').disabled = true;
  try {
    const { auth, provider, signInWithPopup } = window._fb;
    await signInWithPopup(auth, provider);
    // onAuthStateChanged akan handle sisanya
  } catch(err) {
    console.error('Login error:', err);
    document.getElementById('loginLoading').style.display = 'none';
    document.getElementById('btnLoginGoogle').disabled = false;
    if (err.code === 'auth/popup-blocked') {
      alert('Popup diblokir browser. Izinkan popup untuk domain ini lalu coba lagi.');
    } else if (err.code !== 'auth/popup-closed-by-user') {
      alert('Login gagal: ' + err.message);
    }
  }
}

// Login tamu (tanpa simpan data)
function loginAsGuest() {
  window._isGuest = true;
  showApp(null);
}

// Sign out
async function doSignOut() {
  if (window._isGuest) {
    window._isGuest = false;
    showLoginScreen();
    return;
  }
  try {
    const { auth, signOut } = window._fb;
    await signOut(auth);
  } catch(e) { console.error(e); }
}

// Tampilkan layar login
function showLoginScreen() {
  var spa = document.getElementById('spa-root'); if (spa) spa.style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('userInfo').style.display = 'none';
  document.getElementById('loginLoading').style.display = 'none';
  const btnGoogle = document.getElementById('btnLoginGoogle');
  if(btnGoogle) btnGoogle.disabled = false;
  scores = {};
  document.getElementById('totalScore').textContent = '0';
}

// Tampilkan app utama setelah login
function _showAppOrig(user) {
  document.getElementById('loginScreen').style.display = 'none';

  if (user) {
    // Tampilkan info user di header
    const userInfo = document.getElementById('userInfo');
    userInfo.style.display = 'flex';
    document.getElementById('userAvatar').src = user.photoURL || 'https://api.dicebear.com/7.x/initials/svg?seed=' + encodeURIComponent(user.displayName || 'U');
    document.getElementById('userName').textContent = (user.displayName || user.email || 'User').split(' ')[0];
  }

  if (!window._appInited) {
    window._appInited = true;
    init();
  } else {
    renderSurahList(SURAHS);
    renderScoreTab();
  }
}

// ── Dipanggil oleh Firebase module saat user login ──
window.onUserLoggedIn = async function(user) {
  showApp(user);
  await loadUserData(user.uid);
};

// ── Dipanggil oleh Firebase module saat user logout ──
window.onUserLoggedOut = function() {
  window._appInited = false;
  var spa = document.getElementById('spa-root');
  if (spa) spa.style.display = 'none';
  showLoginScreen();
};

// ── Load data user dari Firestore ──
async function loadUserData(uid) {
  if (!window._fb) return;
  try {
    const { db, doc, getDoc } = window._fb;
    const ref  = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      scores = data.scores || {};
      // Perbarui UI
      const allSurahScores = Object.entries(scores)
        .filter(([k]) => !k.includes('_'))
        .map(([,v]) => v);
      if (allSurahScores.length) {
        const total = Math.round(allSurahScores.reduce((a,b)=>a+b,0)/allSurahScores.length);
        document.getElementById('totalScore').textContent = total;
      }
      // Perbarui surah yang sedang ditampilkan
      document.getElementById('surahScoreNum').textContent = scores[currentSurah] || '-';
      if (scores[currentSurah]) {
        document.getElementById('scoreCircle').style.setProperty('--score-pct', `${scores[currentSurah]}%`);
      }
      renderSurahList(SURAHS);
      renderScoreTab();
      showToast('✅', `Selamat datang kembali!`, `Progress Anda berhasil dimuat.`, 'success');
    } else {
      // User baru — buat dokumen
      await saveUserData(uid, { scores: {}, createdAt: window._fb.serverTimestamp() });
      showToast('👋', 'Selamat Datang!', 'Akun baru dibuat. Progress Anda akan tersimpan otomatis.', 'success');
    }
  } catch(e) {
    console.error('Load data error:', e);
    showToast('⚠️', 'Gagal Memuat Data', 'Periksa koneksi internet Anda.', 'error');
  }
}

// ── Simpan data user ke Firestore ──
async function saveUserData(uid, data) {
  if (!window._fb || window._isGuest) return;
  try {
    const { db, doc, setDoc } = window._fb;
    const ref = doc(db, 'users', uid);
    await setDoc(ref, data, { merge: true });
  } catch(e) {
    console.error('Save data error:', e);
  }
}

// ── Simpan skor ke Firestore (dipanggil setiap kali skor berubah) ──
async function syncScoresToFirestore() {
  const user = window._currentUser;
  if (!user || window._isGuest || !window._fb) return;
  try {
    const { db, doc, updateDoc, serverTimestamp } = window._fb;
    const ref = doc(db, 'users', user.uid);
    await updateDoc(ref, {
      scores: scores,
      lastActive: serverTimestamp(),
      lastSurah: currentSurah
    });
  } catch(e) {
    // Kalau updateDoc gagal (dokumen belum ada), pakai setDoc
    await saveUserData(user.uid, { scores, lastActive: window._fb.serverTimestamp() });
  }
}

// ===================================
// START
// ===================================

// Jika Firebase belum load (tidak ada module), langsung tampilkan app sebagai tamu
setTimeout(() => {
  if (!window._fb) {
    console.warn('Firebase tidak terkonfigurasi, mode tamu aktif');
    // Tetap tampilkan login screen — user bisa pilih tamu
  }
}, 2000);

// Mulai dengan tampilkan login screen
// App akan diinit setelah user login atau pilih tamu
showLoginScreen();

// ===== MOBILE SURAH DRAWER =====
function openSurahDrawer() {
  syncSurahDrawer(SURAHS);
  document.getElementById('surahDrawer').classList.add('open');
  document.getElementById('surahOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  // focus search
  setTimeout(() => { const s = document.getElementById('sdSearch'); if(s) s.focus(); }, 400);
}
function closeSurahDrawer() {
  document.getElementById('surahDrawer').classList.remove('open');
  document.getElementById('surahOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
function syncSurahDrawer(list) {
  const container = document.getElementById('sdList');
  if (!container) return;
  container.innerHTML = (list || SURAHS).map(s => {
    const score = scores[s.id];
    const scoreHTML = score ? `<span style="font-size:11px;font-weight:700;color:${score>=80?'#58D68D':score>=50?'#E67E22':'#E74C3C'}">${score}</span>` : '';
    return `<div class="surah-item ${currentSurah===s.id?'active':''}" onclick="selectSurahMob(${s.id})" style="margin-bottom:2px;">
      <div class="surah-num">${s.id}</div>
      <div class="surah-info">
        <div class="surah-name-latin">${s.name}</div>
        <div class="surah-name-ar">${s.arabic}</div>
        <div class="surah-meta">${s.type} · ${s.ayat} ayat</div>
      </div>
      <div class="surah-score">${scoreHTML}</div>
    </div>`;
  }).join('');
}
async function selectSurahMob(id) {
  closeSurahDrawer();
  await selectSurah(id);
  const s = SURAHS[id-1];
  const lbl = document.getElementById('mobSurahLabel');
  if (lbl) lbl.textContent = `📖 ${s.id}. ${s.name}`;
}
function filterSurahDrawer(q) {
  const filtered = SURAHS.filter(s =>
    s.name.toLowerCase().includes(q.toLowerCase()) ||
    s.arabic.includes(q) ||
    String(s.id).includes(q)
  );
  syncSurahDrawer(filtered);
}


/* ════════════════════════════════════════════
   DASHBOARD JS (progress, badges, hafalan, shalat, kiblat)
   ════════════════════════════════════════════ */

// ═══════════════════════════════════════════════════════════════════════
// DATA & STATE
// ═══════════════════════════════════════════════════════════════════════

const SURAHS_META = [
  {id:1,name:"Al-Fatihah",ayat:7},{id:2,name:"Al-Baqarah",ayat:286},{id:3,name:"Ali 'Imran",ayat:200},
  {id:4,name:"An-Nisa",ayat:176},{id:5,name:"Al-Ma'idah",ayat:120},{id:36,name:"Ya-Sin",ayat:83},
  {id:55,name:"Ar-Rahman",ayat:78},{id:67,name:"Al-Mulk",ayat:30},{id:78,name:"An-Naba",ayat:40},
  {id:93,name:"Ad-Duha",ayat:11},{id:94,name:"Ash-Sharh",ayat:8},{id:97,name:"Al-Qadr",ayat:5},
  {id:103,name:"Al-'Asr",ayat:3},{id:108,name:"Al-Kawthar",ayat:3},{id:109,name:"Al-Kafirun",ayat:6},
  {id:110,name:"An-Nasr",ayat:3},{id:112,name:"Al-Ikhlas",ayat:4},{id:113,name:"Al-Falaq",ayat:5},
  {id:114,name:"An-Nas",ayat:6},
];

// Storage keys
const KEY_STREAK  = 'tai_streak';
const KEY_ACTIVITY= 'tai_activity'; // { "2024-01-15": {ayat:3,menit:12,hafalan:5} }
const KEY_GOALS   = 'tai_goals';
const KEY_SR      = 'tai_sr_cards'; // spaced repetition cards
const KEY_TODAY   = 'tai_today';    // today's session progress

// BADGES
const BADGES = [
  // ── Streak / Konsistensi
  {id:'streak1',    ico:'🌱', name:'Hari Pertama',       desc:'Buka app pertama kali',             cat:'streak',  cond: d => d.streak >= 1},
  {id:'streak3',    ico:'🔥', name:'3 Hari Streak',      desc:'Belajar 3 hari berturut-turut',     cat:'streak',  cond: d => d.streak >= 3},
  {id:'streak7',    ico:'🌟', name:'Seminggu Istiqomah', desc:'Streak 7 hari penuh',               cat:'streak',  cond: d => d.streak >= 7},
  {id:'streak14',   ico:'🌙', name:'2 Minggu Tanpa Henti',desc:'Streak 14 hari',                  cat:'streak',  cond: d => d.streak >= 14},
  {id:'streak30',   ico:'💎', name:'Sebulan Istiqomah',  desc:'Streak 30 hari — luar biasa!',      cat:'streak',  cond: d => d.streak >= 30},
  {id:'streak100',  ico:'👑', name:'100 Hari Legenda',   desc:'Streak 100 hari — hafidz sejati',   cat:'streak',  cond: d => d.streak >= 100},
  // ── Ayat
  {id:'ayat1',      ico:'📖', name:'Ayat Pertama',       desc:'Rekam ayat pertama',                cat:'ayat',    cond: d => d.totalAyat >= 1},
  {id:'ayat10',     ico:'📗', name:'10 Ayat Direkam',    desc:'Total 10 ayat berlatih',            cat:'ayat',    cond: d => d.totalAyat >= 10},
  {id:'ayat50',     ico:'📘', name:'50 Ayat Direkam',    desc:'Total 50 ayat berlatih',            cat:'ayat',    cond: d => d.totalAyat >= 50},
  {id:'ayat100',    ico:'📙', name:'100 Ayat Direkam',   desc:'Total 100 ayat — mengesankan!',     cat:'ayat',    cond: d => d.totalAyat >= 100},
  {id:'ayat500',    ico:'🗝️', name:'500 Ayat Direkam',   desc:'Setengah ribu ayat',                cat:'ayat',    cond: d => d.totalAyat >= 500},
  // ── Hafalan
  {id:'hafalan1',   ico:'🧠', name:'Hafalan Pertama',    desc:'Tambah kartu hafalan pertama',      cat:'hafalan', cond: d => d.srCards >= 1},
  {id:'hafalan10',  ico:'💡', name:'10 Kartu Hafalan',   desc:'10 ayat dalam daftar hafalan',      cat:'hafalan', cond: d => d.srCards >= 10},
  {id:'hafalan50',  ico:'🏋️', name:'Hafidz Tangguh',     desc:'50 kartu hafalan aktif',            cat:'hafalan', cond: d => d.srCards >= 50},
  // ── Tajwid
  {id:'tajwid1',    ico:'✏️', name:'Mulai Belajar Tajwid',desc:'Selesaikan 1 bab tajwid',          cat:'tajwid',  cond: d => d.tajwidBab >= 1},
  {id:'tajwid5',    ico:'🎨', name:'5 Bab Tajwid',       desc:'Kuasai 5 bab tajwid',               cat:'tajwid',  cond: d => d.tajwidBab >= 5},
  {id:'tajwidAll',  ico:'🏅', name:'Ahli Tajwid',        desc:'Semua bab tajwid selesai',          cat:'tajwid',  cond: d => d.tajwidBab >= 7},
  {id:'perfectQ',   ico:'💯', name:'Quiz Sempurna',      desc:'Skor 100 di quiz tajwid',           cat:'tajwid',  cond: d => d.perfectQuiz >= 1},
  // ── Waktu
  {id:'menit30',    ico:'⏱️', name:'30 Menit Belajar',   desc:'Total 30 menit aktif belajar',      cat:'waktu',   cond: d => d.totalMenit >= 30},
  {id:'menit60',    ico:'⌛', name:'Sejam Penuh',         desc:'Total 60 menit aktif belajar',      cat:'waktu',   cond: d => d.totalMenit >= 60},
  {id:'menit300',   ico:'🕰️', name:'5 Jam Belajar',      desc:'Akumulasi 5 jam belajar',           cat:'waktu',   cond: d => d.totalMenit >= 300},
  // ── Waktu Shalat
  {id:'shalat1',    ico:'🕌', name:'Tepat Waktu',        desc:'Belajar dekat waktu shalat',        cat:'shalat',  cond: d => d.nearShalat >= 1},
  {id:'shalat7',    ico:'🌙', name:'Istiqomah Shalat',   desc:'7x belajar dekat waktu shalat',     cat:'shalat',  cond: d => d.nearShalat >= 7},
];
// Lencana yang sudah terbuka sebelumnya (untuk deteksi "baru dibuka")
let _prevEarnedBadges = new Set(JSON.parse(localStorage.getItem('tai_badges_earned')||'[]'));

// State
let activityData = {};
let goals        = { ayat: 5, hafalan: 10, menit: 15, bab: 1 };
let todayProgress= { ayat: 0, hafalan: 0, menit: 0, bab: 0 };
let srCards      = []; // array of SR cards
let streak       = { current: 0, best: 0, lastDate: '' };
let totalStats   = { ayat: 0, menit: 0, days: 0 };
let currentReviewCard = null;

// ═══════════════════════════════════════════════════════════════════════
// LOCAL STORAGE (fallback jika Firebase tidak tersedia)
// ═══════════════════════════════════════════════════════════════════════
function loadLocal() {
  try {
    activityData  = JSON.parse(localStorage.getItem(KEY_ACTIVITY) || '{}');
    goals         = JSON.parse(localStorage.getItem(KEY_GOALS)    || JSON.stringify(goals));
    srCards       = JSON.parse(localStorage.getItem(KEY_SR)       || '[]');
    todayProgress = JSON.parse(localStorage.getItem(KEY_TODAY)    || JSON.stringify(todayProgress));
    // Reset today if new day
    const today = dateKey();
    if (todayProgress.date !== today) {
      todayProgress = { date: today, ayat:0, hafalan:0, menit:0, bab:0 };
    }
  } catch(e) { console.warn(e); }
}

function saveLocal() {
  try {
    localStorage.setItem(KEY_ACTIVITY, JSON.stringify(activityData));
    localStorage.setItem(KEY_GOALS,    JSON.stringify(goals));
    localStorage.setItem(KEY_SR,       JSON.stringify(srCards));
    localStorage.setItem(KEY_TODAY,    JSON.stringify(todayProgress));
  } catch(e) {}
}

// ═══════════════════════════════════════════════════════════════════════
// FIREBASE SYNC
// ═══════════════════════════════════════════════════════════════════════
async function loadFromFirestore(uid) {
  if (!window._fb) return;
  try {
    const { db, doc, getDoc } = window._fb;
    const snap = await getDoc(doc(db, 'users', uid));
    if (!snap.exists()) return;
    const d = snap.data();
    if (d.activityData)  activityData  = { ...activityData,  ...d.activityData  };
    if (d.goals)         goals         = { ...goals,         ...d.goals         };
    if (d.srCards)       srCards       = d.srCards;
    if (d.todayProgress && d.todayProgress.date === dateKey()) todayProgress = d.todayProgress;
    saveLocal();
  } catch(e) { console.error('Firestore load:', e); }
}

async function syncToFirestore() {
  // Update leaderboard score async
  setTimeout(syncLeaderboardFirestore, 500);
  const user = window._currentUser;
  if (!user || !window._fb) return;
  try {
    const { db, doc, setDoc, serverTimestamp } = window._fb;
    await setDoc(doc(db, 'users', user.uid), {
      activityData, goals, srCards, todayProgress,
      updatedAt: serverTimestamp()
    }, { merge: true });
  } catch(e) { console.error('Firestore sync:', e); }
}

// Auto-sync every 30s
setInterval(() => syncToFirestore(), 30000);

// ═══════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════
function dateKey(d) {
  const dt = d || new Date();
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}

function daysBetween(d1, d2) {
  const t1 = new Date(d1).getTime();
  const t2 = new Date(d2).getTime();
  return Math.round(Math.abs(t2 - t1) / (1000*60*60*24));
}

// ═══════════════════════════════════════════════════════════════════════
// STREAK CALCULATION
// ═══════════════════════════════════════════════════════════════════════
function calcStreak() {
  const today = dateKey();
  const dates = Object.keys(activityData).filter(k => {
    const d = activityData[k];
    return (d.ayat||0) + (d.hafalan||0) + (d.menit||0) > 0;
  }).sort();

  if (!dates.length) { streak = {current:0, best:0, lastDate:''}; return; }

  // Current streak (counting back from today)
  let current = 0;
  let check   = new Date();
  let best    = 0;
  let tempStr = 0;

  // Check if today or yesterday has activity (allow today to not have activity yet)
  const todayActive  = dates.includes(today);
  const yest = new Date(); yest.setDate(yest.getDate()-1);
  const yestKey = dateKey(yest);
  const yestActive = dates.includes(yestKey);

  if (todayActive || yestActive) {
    check = todayActive ? new Date() : yest;
    while (true) {
      const k = dateKey(check);
      if (dates.includes(k)) {
        current++;
        check.setDate(check.getDate()-1);
      } else break;
    }
  }

  // Best streak
  let run = 0;
  for (let i=0; i<dates.length; i++) {
    if (i===0) { run=1; continue; }
    if (daysBetween(dates[i-1], dates[i]) === 1) run++;
    else run = 1;
    if (run > best) best = run;
  }
  if (current > best) best = current;

  // Total stats
  let totalAyat=0, totalMin=0;
  Object.values(activityData).forEach(d => { totalAyat+=(d.ayat||0); totalMin+=(d.menit||0); });
  totalStats = { ayat: totalAyat, menit: totalMin, days: dates.length };
  streak = { current, best, lastDate: dates[dates.length-1] };
}

// ═══════════════════════════════════════════════════════════════════════
// RENDER STREAK HERO
// ═══════════════════════════════════════════════════════════════════════
function renderStreakHero() {
  document.getElementById('streakNum').textContent = streak.current;
  document.getElementById('streakBest').textContent = `Terbaik: ${streak.best} hari`;
  document.getElementById('totalDays').textContent  = totalStats.days;
  document.getElementById('totalAyat').textContent  = totalStats.ayat;
  document.getElementById('totalMenit').textContent = totalStats.menit;
  document.getElementById('srCardCount').textContent= srCards.length;

  // Flame color based on streak
  const flame = document.querySelector('.sh-flame');
  if (streak.current >= 30) flame.style.filter = 'drop-shadow(0 0 30px rgba(255,50,0,0.7)) hue-rotate(-10deg)';
  else if (streak.current >= 7) flame.style.filter = 'drop-shadow(0 0 24px rgba(255,140,0,0.6))';

  // Today's goals
  const today = dateKey();
  const td = activityData[today] || {};
  const g = goals;
  const goalsHtml = [
    { label:'Ayat Tartil', done: (td.ayat||0), target: g.ayat, color:'var(--gold)' },
    { label:'Review Hafalan', done: (td.hafalan||0), target: g.hafalan, color:'var(--blue)' },
    { label:'Menit Belajar', done: (td.menit||0), target: g.menit, color:'var(--green)' },
    { label:'Bab Tajwid', done: (td.bab||0), target: g.bab, color:'var(--purple)' },
  ].map(g => {
    const pct = Math.min(100, Math.round((g.done/g.target)*100));
    const done = pct >= 100;
    return `
    <div class="goal-item">
      <div class="goal-bar-wrap"><div class="goal-bar-fill" style="width:${pct}%;background:${done?'var(--green)':g.color};"></div></div>
      <div class="goal-label">${g.label}</div>
      <div class="goal-pct" style="color:${done?'var(--green)':g.color};">${g.done}/${g.target}</div>
      ${done ? '<span style="font-size:14px;">✅</span>' : ''}
    </div>`;
  }).join('');
  document.getElementById('todayGoals').innerHTML = goalsHtml;
}

// ═══════════════════════════════════════════════════════════════════════
// RENDER HEATMAP (GitHub-style, 52 weeks)
// ═══════════════════════════════════════════════════════════════════════
function renderHeatmap() {
  const grid   = document.getElementById('heatmapGrid');
  const months = document.getElementById('heatmapMonths');
  const today  = new Date();
  const end    = new Date(today);
  const start  = new Date(today);
  start.setDate(start.getDate() - 364);

  // Align to Sunday
  start.setDate(start.getDate() - start.getDay());

  const cells = [];
  const cur   = new Date(start);
  const MONTH_NAMES = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des'];
  let monthLabels = {};

  while (cur <= end || cells.length % 7 !== 0) {
    const k   = dateKey(cur);
    const act = activityData[k] || {};
    const score = (act.ayat||0)*2 + (act.hafalan||0) + Math.round((act.menit||0)/3);
    const intensity = score===0 ? 0 : score<3 ? 1 : score<8 ? 2 : score<15 ? 3 : score<25 ? 4 : 5;
    const colors = ['rgba(255,255,255,0.04)','rgba(201,162,39,0.15)','rgba(201,162,39,0.3)','rgba(201,162,39,0.5)','rgba(201,162,39,0.75)','#C9A227'];
    const isFuture = cur > today;
    const isToday  = k === dateKey(today);

    const col = Math.floor(cells.length / 7);
    if (cur.getDate() === 1) monthLabels[col] = MONTH_NAMES[cur.getMonth()];

    cells.push(`<div class="hm-cell" 
      style="background:${isFuture ? 'rgba(255,255,255,0.02)' : colors[intensity]};${isToday?'box-shadow:0 0 0 2px rgba(201,162,39,0.6);':''}"
      data-tip="${k}: ${score} poin aktivitas"
    ></div>`);
    cur.setDate(cur.getDate()+1);
  }

  grid.innerHTML = cells.join('');
  grid.style.gridTemplateRows = 'repeat(7, 1fr)';
  grid.style.gridAutoFlow = 'column';
  grid.style.gridTemplateColumns = `repeat(${Math.ceil(cells.length/7)}, 1fr)`;

  // Month labels
  months.innerHTML = Object.entries(monthLabels).map(([col, name]) =>
    `<div style="grid-column:${parseInt(col)+1};font-size:10px;color:rgba(253,246,232,0.35);">${name}</div>`
  ).join('');
  months.style.display = 'grid';
  months.style.gridTemplateColumns = `repeat(${Math.ceil(cells.length/7)}, 1fr)`;
}

// ═══════════════════════════════════════════════════════════════════════
// RENDER CHART (14 days bar chart)
// ═══════════════════════════════════════════════════════════════════════
// ─── Chart.js instance ───
let _mainChart = null;
let _chartMode = 'ayat'; // ayat | menit | skor | 30d

function buildChartData(mode) {
  const days    = mode === '30d' ? 30 : 14;
  const labels  = [], values = [];
  const dayNames= ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
  let bestVal = 0, bestLabel = '—', totalVal = 0;

  for (let i=days-1; i>=0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = dateKey(d);
    const act = activityData[k] || {};
    let val = 0;
    if (mode==='ayat' || mode==='30d') val = act.ayat || 0;
    else if (mode==='menit')           val = act.menit || 0;
    else if (mode==='skor')            val = (act.ayat||0)*10 + (act.hafalan||0)*5 + Math.round((act.menit||0)/2);
    labels.push(i===0 ? 'Hari ini' : dayNames[d.getDay()]);
    values.push(val);
    totalVal += val;
    if (val > bestVal) { bestVal = val; bestLabel = i===0?'Hari ini':dayNames[d.getDay()]; }
  }
  return { labels, values, totalVal, bestLabel, bestVal, days };
}

function renderChart() {
  renderChartJs(_chartMode);
}

function renderChartJs(mode) {
  _chartMode = mode;
  const { labels, values, totalVal, bestLabel, bestVal, days } = buildChartData(mode);

  // Update summary stats
  const avgAyat = days > 0 ? (totalVal/days).toFixed(1) : 0;
  const unitMap  = {ayat:'ayat',menit:'mnt','30d':'ayat',skor:'poin'};
  document.getElementById('cst-rataAyat').textContent =
    `${avgAyat} ${unitMap[mode]||''}`;
  document.getElementById('cst-bestDay').textContent  = bestLabel;
  document.getElementById('cst-totalSkor').textContent = totalVal;

  // Warna gradient
  const gold = 'rgba(201,162,39,';
  const colors = values.map((v,i)=>i===values.length-1?gold+'0.9)':gold+'0.55)');
  const borderColors = values.map((_,i)=>i===values.length-1?gold+'1)':gold+'0.75)');

  const ctx = document.getElementById('mainChart').getContext('2d');
  if (_mainChart) _mainChart.destroy();
  _mainChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets:[{
        label: mode==='menit'?'Menit':mode==='skor'?'Skor':'Ayat',
        data: values,
        backgroundColor: colors,
        borderColor: borderColors,
        borderWidth: 1.5,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options:{
      responsive: true,
      maintainAspectRatio: false,
      plugins:{
        legend:{ display: false },
        tooltip:{
          backgroundColor:'rgba(8,28,28,0.95)',
          borderColor:'rgba(201,162,39,0.4)',
          borderWidth:1,
          titleColor:'rgba(201,162,39,0.9)',
          bodyColor:'rgba(253,246,232,0.8)',
          padding:10,
          callbacks:{
            label: ctx => ` ${ctx.parsed.y} ${unitMap[mode]||''}`
          }
        }
      },
      scales:{
        x:{
          grid:{ color:'rgba(255,255,255,0.04)' },
          ticks:{ color:'rgba(253,246,232,0.4)', font:{size:9}, maxRotation:0 }
        },
        y:{
          grid:{ color:'rgba(255,255,255,0.06)' },
          ticks:{ color:'rgba(253,246,232,0.4)', font:{size:10}, precision:0 },
          beginAtZero: true,
        }
      }
    }
  });
}

function switchChart(mode, btn) {
  document.querySelectorAll('.chart-tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderChartJs(mode);
}

// ═══════════════════════════════════════════════════════════════════════
// GOALS
// ═══════════════════════════════════════════════════════════════════════
function renderGoals() {
  document.getElementById('gAyat').value   = goals.ayat;
  document.getElementById('gHafalan').value= goals.hafalan;
  document.getElementById('gMenit').value  = goals.menit;
  document.getElementById('gBab').value    = goals.bab;
}

function saveGoals() {
  goals = {
    ayat:    parseInt(document.getElementById('gAyat').value)    || 5,
    hafalan: parseInt(document.getElementById('gHafalan').value) || 10,
    menit:   parseInt(document.getElementById('gMenit').value)   || 15,
    bab:     parseInt(document.getElementById('gBab').value)     || 1,
  };
  saveLocal();
  syncToFirestore();
  renderAll();
  showNotif('✅ Target Tersimpan', `Target harian Anda telah diperbarui.`);
}

// ═══════════════════════════════════════════════════════════════════════
// BADGES
// ═══════════════════════════════════════════════════════════════════════
function getBadgeContext() {
  const tajwidProgress = JSON.parse(localStorage.getItem('tai_tajwid') || '{}');
  const babDone = Object.values(tajwidProgress).filter(v => v >= 70).length;
  const nearShalatCount = parseInt(localStorage.getItem('tai_near_shalat')||'0');
  return {
    streak:      streak.current,
    totalAyat:   totalStats.ayat,
    srCards:     srCards.length,
    tajwidBab:   babDone,
    totalMenit:  totalStats.menit,
    perfectQuiz: parseInt(localStorage.getItem('tai_perfect_quiz')||'0'),
    nearShalat:  nearShalatCount,
  };
}

function renderBadges() {
  const ctx     = getBadgeContext();
  const earned  = BADGES.filter(b => b.cond(ctx));
  const locked  = BADGES.filter(b => !b.cond(ctx));
  const total   = BADGES.length;
  const earnedN = earned.length;

  // Update counter
  const countEl = document.getElementById('badgeCount');
  if (countEl) countEl.textContent = `${earnedN} / ${total} terbuka`;

  // Deteksi badge baru → tampilkan unlock toast
  const nowEarned = new Set(earned.map(b=>b.id));
  const newlyEarned = [...nowEarned].filter(id => !_prevEarnedBadges.has(id));
  if (newlyEarned.length > 0) {
    const newB = BADGES.find(b => b.id === newlyEarned[0]);
    if (newB) showBadgeUnlock(newB);
    _prevEarnedBadges = nowEarned;
    localStorage.setItem('tai_badges_earned', JSON.stringify([...nowEarned]));
  }

  // Render: earned dulu, lalu locked
  const catEmoji = {streak:'🔥',ayat:'📖',hafalan:'🧠',tajwid:'🎨',waktu:'⏱️',shalat:'🕌'};
  const rows = [...earned, ...locked].map(b => {
    const isEarned = b.cond(ctx);
    const isNew    = newlyEarned.includes(b.id);
    return `
    <div class="badge-item ${isEarned?'earned':''} ${isNew?'just-earned':''}">
      <div class="badge-new-dot"></div>
      <div class="badge-ico ${isEarned?'':'badge-locked'}" title="${b.desc}">${b.ico}</div>
      <div class="badge-name">${b.name}</div>
      ${isEarned?'':'<div class="badge-name" style="font-size:9px;color:rgba(253,246,232,0.25);margin-top:1px;">🔒</div>'}
    </div>`;
  }).join('');
  document.getElementById('badgesGrid').innerHTML = rows;
}

let _badgeToastTimer = null;
function showBadgeUnlock(badge) {
  const toast = document.getElementById('badgeUnlockToast');
  document.getElementById('badgeUnlockIco').textContent   = badge.ico;
  document.getElementById('badgeUnlockText').textContent  = '🎉 Lencana Baru: ' + badge.name;
  document.getElementById('badgeUnlockSub').textContent   = badge.desc;
  toast.style.display = 'flex';
  clearTimeout(_badgeToastTimer);
  _badgeToastTimer = setTimeout(() => { toast.style.display='none'; }, 5000);
  // TTS badge unlock — Android-safe dengan delay
  if (window.speechSynthesis) {
    const synth = window.speechSynthesis;
    synth.cancel();
    setTimeout(() => {
      const u = new SpeechSynthesisUtterance(`Alhamdulillah! Lencana baru terbuka: ${badge.name}`);
      u.lang  = 'id-ID';
      u.rate  = 0.9;
      u.volume = 1;
      const voices = synth.getVoices();
      const idV = voices.find(v=>v.lang==='id-ID') || voices.find(v=>v.lang.startsWith('id'));
      if (idV) u.voice = idV;
      synth.speak(u);
    }, 200);
  }
}

// ═══════════════════════════════════════════════════════════════════════
// SPACED REPETITION (SM-2 Algorithm)
// ═══════════════════════════════════════════════════════════════════════
// SM-2: EF starts at 2.5, interval starts at 1, then 6
// grade: 0=again,1=hard,2=good,3=easy

function sm2(card, grade) {
  // Calculate new ease factor
  let ef  = card.ef || 2.5;
  let int = card.interval || 1;
  let rep = card.rep || 0;

  if (grade >= 2) {
    if (rep === 0)      int = 1;
    else if (rep === 1) int = 6;
    else                int = Math.round(int * ef);
    rep++;
    ef = ef + (0.1 - (3-grade) * (0.08 + (3-grade)*0.02));
    if (ef < 1.3) ef = 1.3;
  } else {
    rep = 0;
    int = 1;
  }

  const nextDue = new Date();
  nextDue.setDate(nextDue.getDate() + int);

  return { ...card, ef, interval:int, rep, nextDue: dateKey(nextDue), lastReview: dateKey() };
}

function getDueCards() {
  const today = dateKey();
  return srCards.filter(c => !c.nextDue || c.nextDue <= today);
}

function renderSRQueue() {
  const due     = getDueCards();
  const notDue  = srCards.filter(c => c.nextDue && c.nextDue > dateKey()).slice(0, 3);

  document.getElementById('srDueCount').textContent =
    due.length > 0 ? `${due.length} kartu jatuh tempo` : 'Semua sudah direview ✅';

  if (srCards.length === 0) {
    document.getElementById('srQueue').innerHTML = `
      <div style="text-align:center;padding:32px 20px;color:rgba(253,246,232,0.3);">
        <div style="font-size:36px;margin-bottom:12px;">📖</div>
        <div style="font-size:13px;">Belum ada kartu hafalan.<br>Tambahkan ayat untuk mulai menghafal!</div>
      </div>`;
    return;
  }

  const dueHtml = due.slice(0,5).map(c => cardHtml(c, true)).join('');
  const nextHtml = notDue.length ? `
    <div style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:rgba(253,246,232,0.3);margin:14px 0 8px;padding:10px 0 0;border-top:1px solid rgba(255,255,255,0.05);">Selanjutnya</div>
    ${notDue.map(c => cardHtml(c, false)).join('')}` : '';

  const moreHtml = due.length > 5 ? `<div style="text-align:center;padding:10px;font-size:12px;color:rgba(253,246,232,0.35);">+${due.length-5} kartu lagi</div>` : '';

  document.getElementById('srQueue').innerHTML =
    (dueHtml || `<div style="padding:16px;text-align:center;font-size:13px;color:rgba(88,214,141,0.7);">✅ Semua kartu hari ini sudah direview!</div>`) +
    moreHtml + nextHtml;
}

function cardHtml(c, isDue) {
  const today = dateKey();
  const daysUntil = c.nextDue ? daysBetween(today, c.nextDue) : 0;
  const dueCls = isDue ? 'due-now' : daysUntil <= 2 ? 'due-soon' : 'due-later';
  const dueLabel = isDue ? 'Hari ini!' : `${daysUntil} hari lagi`;
  return `
  <div class="sr-card-item" onclick="${isDue?`startReview('${c.id}')`:''}">
    <div class="sr-arab">${c.arabic || '...'}</div>
    <div class="sr-meta">
      <div class="sr-surah">${c.surahName} : ${c.ayat}</div>
      <div class="sr-due ${dueCls}">${dueLabel}</div>
      <div class="sr-ease">EF: ${(c.ef||2.5).toFixed(1)} | ${c.rep||0}x review</div>
    </div>
    ${isDue ? `<button class="sr-review-btn" onclick="event.stopPropagation();startReview('${c.id}')">Review</button>` : ''}
  </div>`;
}

function startReview(cardId) {
  currentReviewCard = srCards.find(c => c.id === cardId);
  if (!currentReviewCard) return;

  document.getElementById('revSurah').textContent = `${currentReviewCard.surahName} : Ayat ${currentReviewCard.ayat}`;
  document.getElementById('revArab').textContent  = currentReviewCard.arabic || '...';
  document.getElementById('revTrans').textContent = currentReviewCard.translation || '';
  document.getElementById('revPhase1').style.display = 'block';
  document.getElementById('revPhase2').style.display = 'none';
  document.getElementById('reviewModal').style.display = 'flex';
}

function revealAyah() {
  document.getElementById('revPhase1').style.display = 'none';
  document.getElementById('revPhase2').style.display = 'block';
}

function gradeCard(grade) {
  if (!currentReviewCard) return;
  const updated = sm2(currentReviewCard, grade);
  const idx = srCards.findIndex(c => c.id === currentReviewCard.id);
  if (idx >= 0) srCards[idx] = updated;

  // Update today's progress
  const today = dateKey();
  if (!activityData[today]) activityData[today] = {};
  activityData[today].hafalan = (activityData[today].hafalan||0) + 1;
  todayProgress.hafalan = (todayProgress.hafalan||0) + 1;

  saveLocal();
  closeReviewModal();
  renderAll();

  // Check if more cards due
  const remaining = getDueCards();
  if (remaining.length > 0) {
    setTimeout(() => showNotif('🧠 Kartu Berikutnya', `Masih ada ${remaining.length} kartu yang perlu direview.`), 500);
  } else {
    showNotif('✅ Selesai!', 'Semua kartu hafalan hari ini sudah direview. Hebat!');
  }
}

function closeReviewModal() {
  document.getElementById('reviewModal').style.display = 'none';
  currentReviewCard = null;
}

// ═══════════════════════════════════════════════════════════════════════
// ADD HAFALAN
// ═══════════════════════════════════════════════════════════════════════
function openAddModal() {
  const select = document.getElementById('addSurah');
  if (!select.children.length || select.children.length === 1) {
    select.innerHTML = '<option value="">-- Pilih Surah --</option>' +
      SURAHS_META.map(s => `<option value="${s.id}" data-ayat="${s.ayat}">${s.id}. ${s.name} (${s.ayat} ayat)</option>`).join('');
  }
  document.getElementById('addAyatFrom').value = '';
  document.getElementById('addAyatTo').value   = '';
  document.getElementById('ayatPreview').innerHTML = '<span style="color:rgba(253,246,232,0.3);font-family:DM Sans,sans-serif;font-size:13px;direction:ltr;">Pilih surah dan nomor ayat</span>';
  document.getElementById('addModal').style.display = 'flex';
}

function closeAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

async function updateAyatPreview() {
  const surahId = document.getElementById('addSurah').value;
  const from    = parseInt(document.getElementById('addAyatFrom').value) || 0;
  const to      = parseInt(document.getElementById('addAyatTo').value) || from;
  if (!surahId || !from) return;

  const preview = document.getElementById('ayatPreview');
  preview.innerHTML = '<span class="spin" style="font-family:DM Sans,sans-serif;font-size:20px;direction:ltr;">⟳</span>';

  try {
    const resp = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}`);
    const data = await resp.json();
    if (data.code === 200) {
      const ayahs = data.data.ayahs.filter(a => a.numberInSurah >= from && a.numberInSurah <= (to||from));
      preview.innerHTML = ayahs.map(a => `<div style="margin-bottom:8px;">${a.text}</div>`).join('');
    }
  } catch(e) {
    preview.innerHTML = '<span style="font-size:13px;color:rgba(253,246,232,0.3);direction:ltr;">Gagal memuat — periksa koneksi internet</span>';
  }
}

async function confirmAddHafalan() {
  const surahId  = document.getElementById('addSurah').value;
  const from     = parseInt(document.getElementById('addAyatFrom').value) || 0;
  const to       = parseInt(document.getElementById('addAyatTo').value) || from;
  const surah    = SURAHS_META.find(s=>s.id===parseInt(surahId));

  if (!surahId || !from || !surah) { alert('Pilih surah dan nomor ayat terlebih dahulu.'); return; }

  const btn = document.querySelector('.btn-add-hafalan');
  btn.innerHTML = '<span class="spin">⟳</span> Memuat...';
  btn.disabled  = true;

  try {
    const [arabResp, transResp] = await Promise.all([
      fetch(`https://api.alquran.cloud/v1/surah/${surahId}`),
      fetch(`https://api.alquran.cloud/v1/surah/${surahId}/id.indonesian`)
    ]);
    const arabData  = await arabResp.json();
    const transData = await transResp.json();

    for (let ayatNum = from; ayatNum <= to; ayatNum++) {
      const existing = srCards.find(c => c.surahId===parseInt(surahId) && c.ayat===ayatNum);
      if (existing) continue; // sudah ada

      const arabAyah = arabData.data?.ayahs?.find(a=>a.numberInSurah===ayatNum);
      const transAyah= transData.data?.ayahs?.find(a=>a.numberInSurah===ayatNum);

      srCards.push({
        id:          `${surahId}_${ayatNum}_${Date.now()}`,
        surahId:     parseInt(surahId),
        surahName:   surah.name,
        ayat:        ayatNum,
        arabic:      arabAyah?.text || '',
        translation: transAyah?.text || '',
        ef:          2.5,
        interval:    1,
        rep:         0,
        nextDue:     dateKey(), // due today
        addedAt:     dateKey(),
      });
    }

    saveLocal();
    syncToFirestore();
    closeAddModal();
    renderAll();
    showNotif('✅ Ditambahkan!', `${to-from+1} ayat ${surah.name} berhasil ditambahkan ke jadwal hafalan.`);
  } catch(e) {
    alert('Gagal memuat data ayat. Periksa koneksi internet.');
  } finally {
    btn.innerHTML = '✚ Tambahkan ke Jadwal Hafalan';
    btn.disabled  = false;
  }
}

// ═══════════════════════════════════════════════════════════════════════
// SIMULATE ACTIVITY (untuk demo/testing)
// ═══════════════════════════════════════════════════════════════════════
function simulateActivity() {
  for (let i=60; i>=0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = dateKey(d);
    // Random activity pattern: more likely on weekdays, skip some days
    const dayOfWeek = d.getDay();
    if (Math.random() < 0.25 || (dayOfWeek===5 && Math.random()<0.5)) continue; // skip some days
    activityData[k] = {
      ayat:    Math.floor(Math.random()*15) + 1,
      hafalan: Math.floor(Math.random()*10),
      menit:   Math.floor(Math.random()*30) + 5,
      bab:     Math.random() > 0.7 ? 1 : 0,
    };
  }
  saveLocal();
  syncToFirestore();
  renderAll();
  showNotif('✨ Demo', 'Data aktivitas simulasi berhasil dibuat!');
}

// ═══════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════
function showNotif(title, msg) {
  document.getElementById('notifTitle').textContent = title;
  document.getElementById('notifMsg').textContent   = msg;
  const banner = document.getElementById('notifBanner');
  banner.style.display = 'block';
  clearTimeout(banner._t);
  banner._t = setTimeout(() => closeNotif(), 5000);
}

function closeNotif() {
  document.getElementById('notifBanner').style.display = 'none';
}

async function requestNotifPermission() {
  if (!('Notification' in window)) {
    document.getElementById('notifStatus').textContent = 'Browser tidak mendukung notifikasi.';
    return;
  }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    document.getElementById('notifStatus').textContent = '✅ Pengingat aktif!';
    document.getElementById('btnNotif').textContent    = '✅ Aktif';
    scheduleReminder();
    new Notification('TartilAI 🔥', {
      body: 'Pengingat belajar berhasil diaktifkan! Semangat belajar Al-Qur\'an!',
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">📖</text></svg>'
    });
  } else {
    document.getElementById('notifStatus').textContent = '❌ Izin ditolak.';
  }
}

function scheduleReminder() {
  // Check due cards periodically
  setInterval(() => {
    if (Notification.permission !== 'granted') return;
    const due = getDueCards();
    if (due.length > 0) {
      new Notification('TartilAI — Hafalan Menunggu 🧠', {
        body: `${due.length} kartu hafalan siap direview hari ini!`,
      });
    }
  }, 1000 * 60 * 60); // setiap jam
}

// ═══════════════════════════════════════════════════════════════════════
// TRACK SESSION TIME
// ═══════════════════════════════════════════════════════════════════════
let sessionStart = Date.now();
setInterval(() => {
  const elapsed = Math.floor((Date.now() - sessionStart) / 60000); // menit
  const today   = dateKey();
  if (!activityData[today]) activityData[today] = {};
  const base = activityData[today]._baseMin || 0;
  activityData[today].menit = base + elapsed;
  todayProgress.menit       = activityData[today].menit;
}, 60000); // update setiap menit

window.addEventListener('beforeunload', () => {
  // Save final session minutes before leaving
  const elapsed = Math.floor((Date.now() - sessionStart) / 60000);
  const today   = dateKey();
  if (!activityData[today]) activityData[today] = {};
  activityData[today]._baseMin = (activityData[today]._baseMin||0) + elapsed;
  activityData[today].menit    = activityData[today]._baseMin;
  saveLocal();
});

// ═══════════════════════════════════════════════════════════════════════
// RENDER ALL
// ═══════════════════════════════════════════════════════════════════════
function renderAll() {
  calcStreak();
  renderStreakHero();
  renderHeatmap();
  renderChart();
  renderGoals();
  renderSRQueue();
  renderBadges();
  renderLeaderboard();
}

// ═══════════════════════════════════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════════════════════════════════
async function doSignout() {
  if (window._fb) {
    try { await window._fb.signOut(window._fb.auth); } catch(e){}
  }
  window.location.href = 'index.html';
}

window._onUser = async (user) => {
  document.getElementById('navAv').src = user.photoURL || '';
  document.getElementById('navNm').textContent = (user.displayName||'').split(' ')[0];
  await loadFromFirestore(user.uid);
  renderAll();
};

window._onLogout = () => {
  window.location.href = 'index.html';
};

// ═══════════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
loadLocal();
renderAll();

// Jalankan deteksi shalat SEGERA, tidak perlu tunggu login
initShalat();

// Check due cards on load
setTimeout(() => {
  const due = getDueCards();
  if (due.length > 0) {
    showNotif(`🧠 ${due.length} Kartu Siap Direview`, 'Klik Review pada kartu di bawah untuk memulai sesi hafalan!');
  } else if (streak.current >= 3) {
    showNotif(`🔥 Streak ${streak.current} Hari!`, 'Pertahankan semangat belajar Anda! Luar biasa!');
  }
}, 1000);


// Mark today as active
const today = dateKey();
if (!activityData[today]) activityData[today] = {};
activityData[today].visited = true;
saveLocal();
});
// Mobile menu
function openMobileMenu() { document.getElementById('mobileMenu').classList.add('open'); }
function closeMobileMenu() { document.getElementById('mobileMenu').classList.remove('open'); }

// ═══════════════════════════════════════════════════════════════════════
// LEADERBOARD
// ═══════════════════════════════════════════════════════════════════════
// Data demo — diganti data Firestore saat Firebase aktif
// ─ Leaderboard berbasis KONSISTENSI & ISTIQOMAH, bukan skor mentah ─
// Semua nama anonim (inisial kota/huruf) sesuai semangat berlomba kebaikan
const LB_DEMO = {
  // Istiqomah: siapa paling konsisten buka app (streak)
  istiqomah: [
    {name:'Hamba A.',  av:'🌙', score:87, desc:'87 hari istiqomah', me:false},
    {name:'Hamba S.',  av:'🌙', score:72, desc:'72 hari istiqomah', me:false},
    {name:'Hamba M.',  av:'🌙', score:65, desc:'65 hari istiqomah', me:false},
    {name:'Hamba F.',  av:'🌙', score:58, desc:'58 hari istiqomah', me:false},
    {name:'Kamu',      av:'⭐', score:null, desc:null,              me:true },
    {name:'Hamba U.',  av:'🌙', score:31, desc:'31 hari istiqomah', me:false},
    {name:'Hamba Z.',  av:'🌙', score:28, desc:'28 hari istiqomah', me:false},
  ],
  // Minggu ini: siapa paling aktif 7 hari terakhir (reset mingguan)
  minggu: [
    {name:'Hamba M.',  av:'🌟', score:7, desc:'Aktif 7 hari minggu ini',  me:false},
    {name:'Hamba A.',  av:'🌟', score:6, desc:'Aktif 6 hari minggu ini',  me:false},
    {name:'Hamba F.',  av:'🌟', score:6, desc:'Aktif 6 hari minggu ini',  me:false},
    {name:'Hamba S.',  av:'🌟', score:5, desc:'Aktif 5 hari minggu ini',  me:false},
    {name:'Kamu',      av:'⭐', score:null, desc:null,                    me:true },
    {name:'Hamba U.',  av:'🌟', score:4, desc:'Aktif 4 hari minggu ini',  me:false},
    {name:'Hamba Z.',  av:'🌟', score:3, desc:'Aktif 3 hari minggu ini',  me:false},
  ],
  // Hafidz: jumlah kartu hafalan aktif (kualitas bukan kecepatan)
  hafidz: [
    {name:'Hamba F.',  av:'📖', score:52, desc:'52 ayat dihafal',  me:false},
    {name:'Hamba S.',  av:'📖', score:41, desc:'41 ayat dihafal',  me:false},
    {name:'Hamba A.',  av:'📖', score:38, desc:'38 ayat dihafal',  me:false},
    {name:'Hamba Z.',  av:'📖', score:33, desc:'33 ayat dihafal',  me:false},
    {name:'Kamu',      av:'⭐', score:null, desc:null,             me:true },
    {name:'Hamba M.',  av:'📖', score:21, desc:'21 ayat dihafal',  me:false},
    {name:'Hamba U.',  av:'📖', score:18, desc:'18 ayat dihafal',  me:false},
  ],
};
let _lbMode = 'istiqomah';

function switchLB(mode, btn) {
  _lbMode = mode;
  document.querySelectorAll('.lb-tab').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  // Skor real user untuk tiap mode
  const myStreak  = streak.current;
  // Hari aktif minggu ini
  const myMinggu  = (()=>{
    let count=0;
    for(let i=0;i<7;i++){
      const d=new Date(); d.setDate(d.getDate()-i);
      if(activityData[dateKey(d)]) count++;
    }
    return count;
  })();
  const myHafidz  = srCards.length;
  const myScoreMap = { istiqomah: myStreak, minggu: myMinggu, hafidz: myHafidz };

  let data = JSON.parse(JSON.stringify(LB_DEMO[_lbMode]));
  data.forEach(d => {
    if (d.me) {
      d.score = myScoreMap[_lbMode];
      d.desc  = _lbMode==='istiqomah' ? `${d.score} hari istiqomah`
               :_lbMode==='minggu'    ? `Aktif ${d.score} hari minggu ini`
               :                        `${d.score} ayat dihafal`;
    }
  });
  data.sort((a,b) => (b.score||0) - (a.score||0));

  const rankClass  = ['gold','silver','bronze'];
  const unitMap    = { istiqomah:'hari', minggu:'hari', hafidz:'ayat' };
  const modeLabel  = { istiqomah:'Streak Istiqomah', minggu:'Aktif Minggu Ini', hafidz:'Hafalan' };
  let html = '';
  const meIdx = data.findIndex(d=>d.me);

  data.forEach((d, i) => {
    const rank    = i+1;
    const rankCls = rank<=3 ? rankClass[rank-1] : 'other';
    const medal   = ['🥇','🥈','🥉'];
    const rankDisp = rank<=3 ? medal[rank-1] : rank;
    if (i>0 && meIdx>4 && i===meIdx && i>3) {
      html += `<div class="lb-sep">· · ·</div>`;
    }
    const scoreDisp = d.score!==null ? `${d.score} ${unitMap[_lbMode]}` : '—';
    const sub       = d.desc || scoreDisp;
    html += `
    <div class="lb-item ${d.me?'me':''}">
      <div class="lb-rank ${rankCls}">${rankDisp}</div>
      <div class="lb-av">${d.av}</div>
      <div class="lb-info">
        <div class="lb-name">${d.name}${d.me?' <span style="color:var(--gold);font-size:10px;">(Kamu)</span>':''}</div>
        <div class="lb-sub">${sub}</div>
      </div>
      <div class="lb-score">${scoreDisp}</div>
    </div>`;
  });
  document.getElementById('leaderboardList').innerHTML = html;
}

// ═══════════════════════════════════════════════════════════════════════
// WAKTU SHALAT GPS
// ═══════════════════════════════════════════════════════════════════════
const SHALAT_NAMES = ['Subuh','Dzuhur','Ashar','Maghrib','Isya'];
// ── Shalat state ─────────────────────────────────────────────────────
var _shalatCity  = '';
var _shalatLat   = 0;
var _shalatLon   = 0;
var _shalatTimer = null;
var _kiblatAngle = null;
var _compassWatch= null;
var _shalatData  = null;

var KOTA_LIST = {
  'Jember'     :[-8.1845, 113.6681],'Situbondo'  :[-7.7060, 114.0017],
  'Banyuwangi' :[-8.2192, 114.3691],'Malang'     :[-7.9797, 112.6304],
  'Surabaya'   :[-7.2575, 112.7521],'Sidoarjo'   :[-7.4478, 112.7183],
  'Pasuruan'   :[-7.6459, 112.9069],'Probolinggo':[-7.7543, 113.2159],
  'Jakarta'    :[-6.2088, 106.8456],'Bandung'    :[-6.9175, 107.6191],
  'Bogor'      :[-6.5971, 106.8060],'Bekasi'     :[-6.2383, 106.9756],
  'Yogyakarta' :[-7.7956, 110.3695],'Solo'       :[-7.5755, 110.8243],
  'Semarang'   :[-6.9932, 110.4203],'Medan'      :[ 3.5952,  98.6722],
  'Palembang'  :[-2.9761, 104.7754],'Pekanbaru'  :[ 0.5333, 101.4500],
  'Makassar'   :[-5.1477, 119.4327],'Denpasar'   :[-8.6705, 115.2126],
  'Mataram'    :[-8.5833, 116.1167],'Manado'     :[ 1.4748, 124.8421],
  'Balikpapan' :[-1.2675, 116.8289],'Banjarmasin':[-3.3186, 114.5944],
  'Pontianak'  :[ 0.0263, 109.3425],'Kupang'     :[-10.177, 123.6070],
  'Aceh'       :[ 5.5483,  95.3238],'Padang'     :[-0.9492, 100.3543]
};

function bukaModalLokasi() {
  var modal = document.getElementById('lokasiModal');
  if (!modal) return;
  var grid = document.getElementById('kotaGrid');
  if (grid && grid.children.length === 0) {
    Object.keys(KOTA_LIST).sort().forEach(function(nama) {
      var btn = document.createElement('button');
      btn.textContent = nama;
      btn.style.cssText = 'padding:10px 6px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:rgba(253,246,232,0.8);font-size:13px;cursor:pointer;font-family:inherit;text-align:center;width:100%;-webkit-tap-highlight-color:transparent;';
      btn.addEventListener('touchstart', function(){ this.style.background='rgba(201,162,39,0.25)'; },{passive:true});
      btn.addEventListener('touchend',   function(){ this.style.background='rgba(255,255,255,0.04)'; },{passive:true});
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        setShalatLokasi(KOTA_LIST[nama][0], KOTA_LIST[nama][1], nama);
      });
      grid.appendChild(btn);
    });
  }
  modal.style.display = 'flex';
}

function tutupModalLokasi() {
  var modal = document.getElementById('lokasiModal');
  if (modal) modal.style.display = 'none';
}

// Hitung arah kiblat — harus sebelum setShalatLokasi
// ═══════════════════════════════════════════════════════════════════════
function calcKiblatAngle(lat, lon) {
  // Koordinat Ka'bah
  const KAABAH_LAT = 21.4225 * Math.PI/180;
  const KAABAH_LON = 39.8262 * Math.PI/180;
  const φ1 = lat * Math.PI/180;
  const λ1 = lon * Math.PI/180;
  const Δλ = KAABAH_LON - λ1;
  const y   = Math.sin(Δλ) * Math.cos(KAABAH_LAT);
  const x   = Math.cos(φ1)*Math.sin(KAABAH_LAT) - Math.sin(φ1)*Math.cos(KAABAH_LAT)*Math.cos(Δλ);
  const θ   = Math.atan2(y,x) * 180/Math.PI;
  return (θ+360) % 360; // 0-360 dari utara
}

function setShalatLokasi(lat, lon, nama) {
  _shalatLat   = lat;
  _shalatLon   = lon;
  _shalatCity  = nama;
  _kiblatAngle = calcKiblatAngle(lat, lon);
  var el = document.getElementById('shalatCity');
  if (el) el.textContent = '📍 ' + nama;
  tutupModalLokasi();
  fetchShalatTimes(lat, lon);
  try { localStorage.setItem('tai_lokasi', JSON.stringify({lat:lat,lon:lon,nama:nama})); } catch(e){}
}

function mintaLokasi() {
  var el = document.getElementById('shalatCity');
  tutupModalLokasi();
  if (!navigator.geolocation) {
    if (el) el.textContent = '📍 GPS tidak tersedia';
    setTimeout(bukaModalLokasi, 200);
    return;
  }
  if (el) el.textContent = '📍 Mendeteksi GPS...';
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      var lat = pos.coords.latitude, lon = pos.coords.longitude;
      _shalatLat = lat; _shalatLon = lon;
      _kiblatAngle = calcKiblatAngle(lat, lon);
      if (el) el.textContent = '📍 ' + lat.toFixed(2) + '°, ' + lon.toFixed(2) + '°';
      fetchShalatTimes(lat, lon);
      fetch('https://api.bigdatacloud.net/data/reverse-geocode-client?latitude='+lat+'&longitude='+lon+'&localityLanguage=id')
        .then(function(r){return r.json();})
        .then(function(d){
          var kota = d.city||d.locality||d.principalSubdivision||'';
          if (kota) {
            _shalatCity = kota;
            if (el) el.textContent = '📍 '+kota;
            try { localStorage.setItem('tai_lokasi', JSON.stringify({lat:lat,lon:lon,nama:kota})); } catch(e){}
          }
        }).catch(function(){});
    },
    function() {
      if (el) el.textContent = '📍 GPS gagal';
      setTimeout(bukaModalLokasi, 200);
    },
    {enableHighAccuracy:false, timeout:12000, maximumAge:3600000}
  );
}

// Lokasi default: Jember (bisa diganti via modal pilih kota)
var DEFAULT_LOKASI = { nama: 'Jember', lat: -8.1845, lon: 113.6681 };

function initShalat() {
  // 1. Pakai lokasi yang sudah dipilih user sebelumnya
  try {
    var saved = JSON.parse(localStorage.getItem('tai_lokasi') || 'null');
    if (saved && saved.lat && saved.lon) {
      setShalatLokasi(saved.lat, saved.lon, saved.nama || 'Lokasi Tersimpan');
      return;
    }
  } catch(e) {}

  // 2. Default langsung Jember — tidak perlu klik atau izin GPS
  setShalatLokasi(DEFAULT_LOKASI.lat, DEFAULT_LOKASI.lon, DEFAULT_LOKASI.nama);
}




async function fetchShalatTimes(lat, lon) {
  var nameEl = document.getElementById('shalatNextName');
  var cdEl   = document.getElementById('shalatCountdown');
  if (nameEl) nameEl.textContent = 'Memuat...';
  if (cdEl)   cdEl.textContent   = '--:--';

  // Format tanggal wajib zero-padded — aladhan.com sangat sensitif
  var today = new Date();
  var dd  = String(today.getDate()).padStart(2,'0');
  var mm  = String(today.getMonth()+1).padStart(2,'0');
  var yy  = today.getFullYear();

  function toMin(str) {
    var p = (str||'00:00').split(':');
    return parseInt(p[0])*60 + parseInt(p[1]);
  }

  function applyTimings(t) {
    _shalatData = {
      Subuh:   toMin(t.Fajr),   Dzuhur:  toMin(t.Dhuhr),
      Ashar:   toMin(t.Asr),    Maghrib: toMin(t.Maghrib),
      Isya:    toMin(t.Isha),
      rawFajr: t.Fajr, rawDhuhr: t.Dhuhr, rawAsr: t.Asr,
      rawMaghrib: t.Maghrib, rawIsya: t.Isha
    };
    renderShalatTimes();
    startShalatCountdown();
    checkNearShalat();
  }

  function showRetry() {
    if (nameEl) nameEl.textContent = 'Gagal memuat';
    if (cdEl)   cdEl.textContent   = '—';
    var timesEl = document.getElementById('shalatTimes');
    if (timesEl) timesEl.innerHTML =
      '<button onclick="fetchShalatTimes('+lat+','+lon+')" style="'+
      'padding:5px 14px;border-radius:8px;border:1px solid rgba(201,162,39,0.4);'+
      'background:rgba(201,162,39,0.1);color:rgba(201,162,39,0.9);'+
      'font-size:11px;cursor:pointer;font-family:inherit;white-space:nowrap;">'+
      '🔄 Coba Lagi</button>';
  }

  // API 1: aladhan.com — method=20 (Muslim World League, paling stabil global)
  try {
    var url1 = 'https://api.aladhan.com/v1/timings/'+dd+'-'+mm+'-'+yy+
               '?latitude='+lat+'&longitude='+lon+'&method=20';
    var ctrl1 = new AbortController();
    var t1 = setTimeout(function(){ ctrl1.abort(); }, 9000);
    var r1 = await fetch(url1, {signal: ctrl1.signal});
    clearTimeout(t1);
    if (!r1.ok) throw new Error('HTTP '+r1.status);
    var d1 = await r1.json();
    if (d1.code === 200 && d1.data && d1.data.timings) {
      applyTimings(d1.data.timings);
      return;
    }
    throw new Error('bad response');
  } catch(e1) {
    console.warn('aladhan gagal:', e1.message);
  }

  // API 2: aladhan fallback tanpa tanggal (pakai hari ini otomatis)
  try {
    var url2 = 'https://api.aladhan.com/v1/timings?latitude='+lat+
               '&longitude='+lon+'&method=20';
    var ctrl2 = new AbortController();
    var t2 = setTimeout(function(){ ctrl2.abort(); }, 9000);
    var r2 = await fetch(url2, {signal: ctrl2.signal});
    clearTimeout(t2);
    if (!r2.ok) throw new Error('HTTP '+r2.status);
    var d2 = await r2.json();
    if (d2.code === 200 && d2.data && d2.data.timings) {
      applyTimings(d2.data.timings);
      return;
    }
    throw new Error('bad response');
  } catch(e2) {
    console.warn('aladhan fallback gagal:', e2.message);
  }

  // API 3: myquran.com
  try {
    var url3 = 'https://api.myquran.com/v2/sholat/waktu/by-coords/'+lat+'/'+lon+'/today';
    var ctrl3 = new AbortController();
    var t3 = setTimeout(function(){ ctrl3.abort(); }, 9000);
    var r3 = await fetch(url3, {signal: ctrl3.signal});
    clearTimeout(t3);
    if (!r3.ok) throw new Error('HTTP '+r3.status);
    var d3 = await r3.json();
    var j = d3.data && d3.data.jadwal;
    if (j && j.subuh) {
      applyTimings({Fajr:j.subuh, Dhuhr:j.dzuhur, Asr:j.ashar, Maghrib:j.maghrib, Isha:j.isya});
      return;
    }
    throw new Error('bad myquran');
  } catch(e3) {
    console.warn('myquran gagal:', e3.message);
  }

  // Semua gagal
  showRetry();
}

function renderShalatTimes() {
  if (!_shalatData) return;
  const now     = new Date();
  const nowMin  = now.getHours()*60 + now.getMinutes();
  const keys    = ['Subuh','Dzuhur','Ashar','Maghrib','Isya'];
  const rawMap  = {Subuh:'rawFajr',Dzuhur:'rawDhuhr',Ashar:'rawAsr',Maghrib:'rawMaghrib',Isya:'rawIsya'};
  // Cari shalat berikutnya
  let nextKey   = keys.find(k => _shalatData[k] > nowMin) || 'Subuh';

  document.getElementById('shalatTimes').innerHTML = keys.map(k => {
    const isNext   = k === nextKey;
    const isPassed = _shalatData[k] <= nowMin;
    return `
    <div class="shalat-time-item ${isNext?'active':''}">
      <div class="shalat-time-name">${k}</div>
      <div class="shalat-time-val" style="${isPassed&&!isNext?'opacity:.35':''}">${_shalatData['raw'+k.charAt(0).toUpperCase()+k.slice(1).replace('Subuh','Fajr').replace('Dzuhur','Dhuhr').replace('Ashar','Asr').replace('Maghrib','Maghrib').replace('Isya','Isha')]||'—'}</div>
    </div>`;
  }).join('');

  // Fix raw times display
  document.getElementById('shalatTimes').innerHTML = keys.map(k=>{
    const isNext = k===nextKey;
    const isPassed = _shalatData[k]<=nowMin;
    const rawKey = {Subuh:'rawFajr',Dzuhur:'rawDhuhr',Ashar:'rawAsr',Maghrib:'rawMaghrib',Isya:'rawIsya'}[k];
    return `<div class="shalat-time-item ${isNext?'active':''}">
      <div class="shalat-time-name">${k}</div>
      <div class="shalat-time-val" style="${isPassed&&!isNext?'opacity:.35':''}">${_shalatData[rawKey]}</div>
    </div>`;
  }).join('');
}

function startShalatCountdown() {
  if (_shalatTimer) clearInterval(_shalatTimer);
  function tick() {
    if (!_shalatData) return;
    const now    = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();
    const nowSec = now.getSeconds();
    const keys   = ['Subuh','Dzuhur','Ashar','Maghrib','Isya'];
    let nextKey  = keys.find(k => _shalatData[k] > nowMin);
    let diffMin;
    if (!nextKey) {
      // Setelah Isya, hitung ke Subuh besok
      nextKey = 'Subuh';
      diffMin = (1440 - nowMin) + _shalatData.Subuh;
    } else {
      diffMin = _shalatData[nextKey] - nowMin;
    }
    const diffSec  = diffMin*60 - nowSec;
    const hh = Math.floor(diffSec/3600);
    const mm = Math.floor((diffSec%3600)/60);
    const ss = diffSec%60;
    const cdEl = document.getElementById('shalatCountdown');
    const fmt  = (n)=>String(n).padStart(2,'0');
    if (!cdEl) return;
    const nameEl = document.getElementById('shalatNextName');
    if (!nameEl) return;
    cdEl.textContent = hh>0 ? `${hh}j ${fmt(mm)}m ${fmt(ss)}d` : `${fmt(mm)}m ${fmt(ss)}d`;
    // Warna urgency
    cdEl.className = 'shalat-countdown';
    if (diffMin<=5)  cdEl.classList.add('urgent');
    else if (diffMin<=15) cdEl.classList.add('soon');
    nameEl.textContent = `${nextKey} dalam`;
    // Notif saat masuk waktu shalat
    if (diffMin===0 && now.getSeconds()<5 && Notification.permission==='granted') {
      new Notification(`🕌 Waktu ${nextKey}`, {
        body: `Waktu ${nextKey} telah tiba. Semoga kita selalu istiqomah.`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🕌</text></svg>'
      });
    }
  }
  tick();
  _shalatTimer = setInterval(tick, 1000);
}

function checkNearShalat() {
  if (!_shalatData) return;
  const now    = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  const keys   = ['Subuh','Dzuhur','Ashar','Maghrib','Isya'];
  const isNear = keys.some(k => Math.abs(_shalatData[k]-nowMin)<=15);
  if (isNear) {
    const count = parseInt(localStorage.getItem('tai_near_shalat')||'0') + 1;
    localStorage.setItem('tai_near_shalat', count);
  }
}

// ═══════════════════════════════════════════════════════════════════════
// KIBLAT

function openKiblat() {
  document.getElementById('kiblatOverlay').classList.add('open');
  if (_kiblatAngle===null && _shalatLat!==0) {
    _kiblatAngle = calcKiblatAngle(_shalatLat, _shalatLon);
  }
  if (_kiblatAngle!==null) {
    const deg = Math.round(_kiblatAngle);
    document.getElementById('kiblatAngle').textContent = `${deg}° dari Utara`;
    document.getElementById('kiblatDesc').textContent  =
      `Dari ${_shalatCity||'lokasi Anda'}, Ka'bah berada ${deg}° dari arah Utara`;
    document.getElementById('kiblatNeedle').style.transform = `rotate(${deg}deg)`;
  }
  // Coba gunakan DeviceOrientationEvent untuk kompas real
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(state => {
      if (state==='granted') startCompass();
    }).catch(()=>{});
  } else if (window.DeviceOrientationEvent) {
    startCompass();
  } else {
    document.getElementById('kiblatCompassStatus').textContent =
      'Kompas tidak tersedia di perangkat ini. Arah dihitung dari koordinat GPS.';
  }
}

function closeKiblat() {
  document.getElementById('kiblatOverlay').classList.remove('open');
  stopCompass();
}

function startCompass() {
  document.getElementById('kiblatCompassStatus').textContent = '🧭 Kompas aktif — arahkan layar Anda';
  _compassWatch = function(e) {
    const heading = (typeof e.webkitCompassHeading!=='undefined' && e.webkitCompassHeading!==null)
      ? e.webkitCompassHeading : ((360 - (e.alpha||0)) % 360);
    if (_kiblatAngle!==null) {
      const needleAngle = _kiblatAngle - heading;
      document.getElementById('kiblatNeedle').style.transform = `rotate(${needleAngle}deg)`;
      document.getElementById('compassRing').style.transform  = `rotate(${-heading}deg)`;
    }
  };
  window.addEventListener('deviceorientation', _compassWatch, true);
}

function stopCompass() {
  if (_compassWatch) {
    window.removeEventListener('deviceorientation', _compassWatch, true);
    _compassWatch = null;
  }
}

// Shalat notif — perbarui scheduleReminder
const _origScheduleReminder = scheduleReminder;
scheduleReminder = function() {
  _origScheduleReminder();
  // Tambah notif waktu shalat (tiap 30 menit cek)
  setInterval(() => {
    if (!_shalatData || Notification.permission!=='granted') return;
    const now = new Date();
    const nowMin = now.getHours()*60+now.getMinutes();
    const keys = ['Subuh','Dzuhur','Ashar','Maghrib','Isya'];
    keys.forEach(k => {
      if (Math.abs(_shalatData[k]-nowMin)<=1) {
        new Notification(`🕌 ${k} - Allahu Akbar`, {
          body:`Waktu ${k} telah masuk. Mari shalat.`,
          icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🕌</text></svg>'
        });
      }
    });
  }, 30000);
};

// (initShalat sudah dipanggil di INIT)

// Wire lokasi modal via addEventListener (lebih reliable dari onclick di sticky bar)
// onclick langsung di HTML elements

// Render leaderboard
renderLeaderboard();

// Sync leaderboard ke Firestore jika aktif
async function syncLeaderboardFirestore() {
  const user = window._currentUser;
  if (!user || !window._fb) return;
  try {
    const { db, doc, setDoc, collection, getDocs, query, orderBy, limit } = window._fb;
    // Update skor user sendiri
    const myStreak = streak.current;
    const myAyat   = totalStats.ayat;
    const mySkor   = Object.keys(activityData).reduce((s,k)=>{
      const a=activityData[k]||{};
      return s+(a.ayat||0)*10+(a.hafalan||0)*5+Math.round((a.menit||0)/2);
    },0);
    await setDoc(doc(db,'leaderboard',user.uid), {
      name:  (user.displayName||'Anonim').split(' ')[0],
      av:    user.photoURL||'',
      streak: myStreak,
      minggu: (() => { let n=0; for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()-i);if(activityData[dateKey(d)])n++;} return n; })(),
      hafidz: srCards.length,
      updatedAt: new Date().toISOString(),
    }, {merge:true});
    // Ambil top 10
    const snap = await getDocs(query(collection(db,'leaderboard'), orderBy('streak','desc'), limit(10)));
    if (!snap.empty) {
      LB_DEMO.streak = snap.docs.map(d=>({
        name:d.data().name, av:d.data().av?'img':'👤',
        score:d.data().streak, me:d.id===user.uid
      }));
      renderLeaderboard();
    }
  } catch(e) {}
}

// Panggil sync leaderboard setelah load
setTimeout(syncLeaderboardFirestore, 3000);


/* ════════════════════════════════════════════
   TAJWID JS (kurikulum, quiz)
   ════════════════════════════════════════════ */

// ═══════════════════════════════════════════════════════════════
// DATA KURIKULUM TAJWID
// ═══════════════════════════════════════════════════════════════
const KURIKULUM = [
  // ─── BAB 1 ───────────────────────────────────────────────────
  {
    id: 1, icon: '🔤', title: 'Huruf Hijaiyah',
    subtitle: '28 huruf dasar Arab',
    desc: 'Pengenalan lengkap 28 huruf hijaiyah beserta nama, cara baca, dan bentuknya.',
    content: 'huruf'
  },
  // ─── BAB 2 ───────────────────────────────────────────────────
  {
    id: 2, icon: '🎵', title: 'Harakat & Tanda Baca',
    subtitle: 'Fathah, kasrah, dhammah',
    desc: 'Pelajari tanda baca (harakat) yang menentukan cara pengucapan setiap huruf.',
    content: 'harakat'
  },
  // ─── BAB 3 ───────────────────────────────────────────────────
  {
    id: 3, icon: '👄', title: 'Makhraj Huruf',
    subtitle: 'Tempat keluarnya huruf',
    desc: 'Makhraj adalah titik artikulasi tempat keluarnya suara setiap huruf hijaiyah.',
    content: 'makhraj'
  },
  // ─── BAB 4 ───────────────────────────────────────────────────
  {
    id: 4, icon: '📏', title: 'Hukum Nun Sukun & Tanwin',
    subtitle: 'Izhar, Idgham, Iqlab, Ikhfa',
    desc: 'Empat hukum bacaan ketika nun sukun atau tanwin bertemu huruf-huruf tertentu.',
    content: 'nun'
  },
  // ─── BAB 5 ───────────────────────────────────────────────────
  {
    id: 5, icon: '🔊', title: 'Hukum Mim Sukun',
    subtitle: 'Ikhfa Syafawi, Idgham, Izhar',
    desc: 'Tiga hukum bacaan mim sukun ketika bertemu huruf-huruf berikutnya.',
    content: 'mim'
  },
  // ─── BAB 6 ───────────────────────────────────────────────────
  {
    id: 6, icon: '⏱️', title: 'Mad & Qasr',
    subtitle: 'Panjang pendek bacaan',
    desc: 'Mad artinya memanjangkan bacaan. Pelajari jenis-jenis mad dan ukurannya dalam harakat.',
    content: 'mad'
  },
  // ─── BAB 7 ───────────────────────────────────────────────────
  {
    id: 7, icon: '🛑', title: 'Waqaf & Qalqalah',
    subtitle: 'Berhenti & memantul',
    desc: 'Waqaf adalah aturan berhenti membaca. Qalqalah adalah pantulan suara pada huruf tertentu.',
    content: 'waqaf'
  },
];

// ─── HURUF HIJAIYAH ──────────────────────────────────────────
const HURUF = [
  {arab:'ا',name:'Alif',latin:'a'},  {arab:'ب',name:'Ba',latin:'b'},
  {arab:'ت',name:'Ta',latin:'t'},    {arab:'ث',name:'Tsa',latin:'ts'},
  {arab:'ج',name:'Jim',latin:'j'},   {arab:'ح',name:'Ha',latin:'ḥ'},
  {arab:'خ',name:'Kha',latin:'kh'},  {arab:'د',name:'Dal',latin:'d'},
  {arab:'ذ',name:'Dzal',latin:'dz'}, {arab:'ر',name:"Ra'",latin:'r'},
  {arab:'ز',name:'Zai',latin:'z'},   {arab:'س',name:'Sin',latin:'s'},
  {arab:'ش',name:'Syin',latin:'sy'}, {arab:'ص',name:'Shad',latin:'sh'},
  {arab:'ض',name:'Dhad',latin:'ḍ'},  {arab:'ط',name:'Tha',latin:'ṭ'},
  {arab:'ظ',name:'Zha',latin:'ẓ'},   {arab:'ع',name:"'Ain",latin:"'"},
  {arab:'غ',name:'Ghain',latin:'gh'},{arab:'ف',name:'Fa',latin:'f'},
  {arab:'ق',name:'Qaf',latin:'q'},   {arab:'ك',name:'Kaf',latin:'k'},
  {arab:'ل',name:'Lam',latin:'l'},   {arab:'م',name:'Mim',latin:'m'},
  {arab:'ن',name:'Nun',latin:'n'},   {arab:'و',name:'Waw',latin:'w'},
  {arab:'ه',name:'Ha',latin:'h'},    {arab:'ي',name:'Ya',latin:'y'},
];

// ─── HARAKAT ─────────────────────────────────────────────────
const HARAKAT = [
  {symbol:'بَ',name:'Fathah',read:'a',desc:"Harakat di atas huruf, dibaca 'a' pendek"},
  {symbol:'بِ',name:'Kasrah',read:'i',desc:"Harakat di bawah huruf, dibaca 'i' pendek"},
  {symbol:'بُ',name:'Dhammah',read:'u',desc:"Harakat seperti waw kecil di atas, dibaca 'u'"},
  {symbol:'بً',name:'Fathahtain',read:'an',desc:"Dua fathah, dibaca 'an', disebut tanwin"},
  {symbol:'بٍ',name:'Kasrahtain',read:'in',desc:"Dua kasrah, dibaca 'in', disebut tanwin"},
  {symbol:'بٌ',name:'Dhammahtain',read:'un',desc:"Dua dhammah, dibaca 'un', disebut tanwin"},
  {symbol:'بْ',name:'Sukun',read:'mati',desc:"Bulatan kecil di atas, huruf tidak berbunyi vokal"},
  {symbol:'بّ',name:'Tasydid',read:'dobel',desc:"Tanda seperti kepala huruf sin, huruf dibaca dobel/berat"},
  {symbol:'بٰ',name:'Mad (alif kecil)',read:'aa',desc:"Alif kecil di atas fathah, memanjangkan bacaan"},
];

// ─── MAKHRAJ ─────────────────────────────────────────────────
const MAKHRAJ = [
  { group: '🫁 Al-Jauf (Rongga mulut & tenggorokan)', items: [
    {arab:'ا و ي',desc:'Huruf mad; alif, waw, ya saat berstatus mad keluar dari rongga mulut'}
  ]},
  { group: '🗣️ Al-Halq (Tenggorokan)', items: [
    {arab:'ء ه',info:'Tenggorokan bawah',desc:'Hamzah dan Ha'},
    {arab:'ع ح',info:'Tenggorokan tengah',desc:"'Ain dan Ha' (berbisik)"},
    {arab:'غ خ',info:'Tenggorokan atas',desc:'Ghain dan Kha'},
  ]},
  { group: '👅 Al-Lisan (Lidah)', items: [
    {arab:'ق',info:'Pangkal lidah belakang',desc:'Qaf — lidah bagian paling belakang menyentuh langit-langit'},
    {arab:'ك',info:'Pangkal lidah',desc:'Kaf — sedikit di depan makhraj Qaf'},
    {arab:'ج ش ي',info:'Tengah lidah',desc:'Jim, Syin, Ya'},
    {arab:'ض',info:'Sisi lidah',desc:'Dhad — sisi lidah kiri/kanan menyentuh gigi geraham atas'},
    {arab:'ل',info:'Ujung lidah depan',desc:'Lam — tepi ujung lidah menyentuh gusi atas'},
    {arab:'ن',info:'Ujung lidah',desc:'Nun — ujung lidah menyentuh gusi atas'},
    {arab:'ر',info:'Ujung lidah',desc:"Ra' — ujung lidah mendekati gusi atas"},
    {arab:'ط د ت',info:'Ujung lidah & gigi',desc:'Tha, Dal, Ta — ujung lidah menyentuh pangkal gigi atas'},
    {arab:'ص س ز',info:'Ujung lidah & gigi bawah',desc:'Shad, Sin, Zai — ujung lidah mendekati gigi bawah'},
    {arab:'ظ ذ ث',info:'Ujung lidah & gigi',desc:'Zha, Dzal, Tsa — ujung lidah menyentuh ujung gigi atas'},
  ]},
  { group: '💋 Al-Syafatain (Bibir)', items: [
    {arab:'ف',desc:'Fa — gigi atas menyentuh bibir bawah bagian dalam'},
    {arab:'و',desc:'Waw — kedua bibir membulat terbuka'},
    {arab:'م ب',desc:'Mim, Ba — kedua bibir menutup rapat'},
  ]},
  { group: '👃 Al-Khaisyum (Hidung)', items: [
    {arab:'غُنَّة',desc:'Bunyi ghunnah (dengung) pada Nun dan Mim bertasydid, Nun/Mim sukun dalam kondisi tertentu'},
  ]},
];

// ─── HUKUM NUN SUKUN ─────────────────────────────────────────
const HUKUM_NUN = [
  {
    name:'Izhar Halqi', color:'#85C1E9', bg:'rgba(133,193,233,0.1)', border:'rgba(133,193,233,0.3)',
    huruf:'ء ه ع ح غ خ',
    syarat:'Nun sukun / tanwin bertemu salah satu dari 6 huruf izhar',
    cara:'Dibaca jelas dan terang, tanpa dengung sama sekali',
    contoh:'مَنْ أَمَنَ', arti:'Siapa yang beriman'
  },
  {
    name:'Idgham Bighunnah', color:'#58D68D', bg:'rgba(88,214,141,0.1)', border:'rgba(88,214,141,0.3)',
    huruf:'ي ن م و',
    syarat:'Nun sukun / tanwin bertemu ya, nun, mim, atau waw di kata berbeda',
    cara:'Masukkan nun ke huruf berikutnya dengan dengung 2 harakat',
    contoh:'مِنْ يَوْمٍ', arti:'dari satu hari'
  },
  {
    name:'Idgham Bilaghunnah', color:'#A9DFBF', bg:'rgba(169,223,191,0.1)', border:'rgba(169,223,191,0.3)',
    huruf:'ل ر',
    syarat:'Nun sukun / tanwin bertemu Lam atau Ra',
    cara:'Masukkan nun ke huruf berikutnya TANPA dengung',
    contoh:'مِنْ رَّبِّهِمْ', arti:'dari Tuhan mereka'
  },
  {
    name:'Iqlab', color:'#F8C471', bg:'rgba(248,196,113,0.1)', border:'rgba(248,196,113,0.3)',
    huruf:'ب',
    syarat:'Nun sukun / tanwin bertemu huruf Ba',
    cara:'Ubah bunyi nun/tanwin menjadi Mim, tutup bibir, dengung 2 harakat',
    contoh:'سَمِيعٌ بَصِيرٌ', arti:'Maha Mendengar lagi Maha Melihat'
  },
  {
    name:'Ikhfa Haqiqi', color:'#5DADE2', bg:'rgba(93,173,226,0.1)', border:'rgba(93,173,226,0.3)',
    huruf:'ت ث ج د ذ ز س ش ص ض ط ظ ف ق ك',
    syarat:'Nun sukun / tanwin bertemu 15 huruf ikhfa',
    cara:'Samarkan bunyi nun antara izhar dan idgham, dengan dengung 2 harakat',
    contoh:'مِنْ تَحْتِهَا', arti:'dari bawahnya'
  },
];

// ─── HUKUM MIM SUKUN ─────────────────────────────────────────
const HUKUM_MIM = [
  {
    name:'Ikhfa Syafawi', color:'#F1948A', bg:'rgba(241,148,138,0.1)', border:'rgba(241,148,138,0.3)',
    huruf:'ب',
    syarat:'Mim sukun bertemu huruf Ba',
    cara:'Samarkan bunyi mim dengan dengung 2 harakat, bibir tertutup rapat',
    contoh:'تَرْمِيهِم بِحِجَارَةٍ', arti:'melempar mereka dengan batu'
  },
  {
    name:'Idgham Mimy / Mutamasilain', color:'#A3E4D7', bg:'rgba(163,228,215,0.1)', border:'rgba(163,228,215,0.3)',
    huruf:'م',
    syarat:'Mim sukun bertemu huruf Mim',
    cara:'Masukkan mim ke mim berikutnya dengan dengung 2 harakat, bibir menutup',
    contoh:'لَهُمْ مَّا يَشَاءُونَ', arti:'bagi mereka apa yang mereka kehendaki'
  },
  {
    name:'Izhar Syafawi', color:'#AED6F1', bg:'rgba(174,214,241,0.1)', border:'rgba(174,214,241,0.3)',
    huruf:'selain ب dan م',
    syarat:'Mim sukun bertemu huruf selain Ba dan Mim (24 huruf lainnya)',
    cara:'Baca mim dengan jelas dan terang tanpa dengung',
    contoh:'عَلَيْهِمْ غَيْرِ', arti:'atas mereka selain'
  },
];

// ─── JENIS MAD ───────────────────────────────────────────────
const JENIS_MAD = [
  {name:"Mad Tabi'i (Asli)",    desc:"Huruf mad (ا و ي) tidak diikuti hamzah atau sukun. Dasar semua jenis mad.", harakah:"2"},
  {name:"Mad Wajib Muttasil",   desc:"Huruf mad bertemu hamzah dalam SATU kata. Wajib dibaca panjang.", harakah:"5–6"},
  {name:"Mad Jaiz Munfasil",    desc:"Huruf mad di akhir kata, hamzah di awal kata berikutnya. Boleh 2–5.", harakah:"2–5"},
  {name:"Mad Lazim Kilmi",      desc:"Huruf mad diikuti sukun asli dalam satu kata. Dibaca 6 harakat.", harakah:"6"},
  {name:"Mad Lazim Harfi",      desc:"Terdapat pada huruf-huruf pembuka surah (fawatih). Mis: الم", harakah:"6"},
  {name:"Mad 'Arid Lis-Sukun",  desc:"Huruf mad sebelum huruf terakhir ayat yang diwaqafkan.", harakah:"2–6"},
  {name:"Mad Badal",            desc:"Hamzah diikuti huruf mad dalam satu kata. Mis: آمَنَ", harakah:"2"},
  {name:"Mad Iwadh",            desc:"Mengganti tanwin fathah saat waqaf. Mis: عَلِيماً → عَلِيمَا", harakah:"2"},
];

// ─── QUIZ DATA per BAB ───────────────────────────────────────
const QUIZ = {
  1: [
    {q:'Huruf hijaiyah yang berikut ini dibaca "Ba" adalah...', a:1, opts:['ت','ب','ث','ن'], ex:'ب adalah huruf kedua hijaiyah, dibaca "Ba".'},
    {q:'Berapa jumlah huruf hijaiyah?', a:2, opts:['26','27','28','30'], ex:'Huruf hijaiyah berjumlah 28 huruf.'},
    {q:'Huruf apa ini? → ص', a:0, opts:['Shad','Sin','Syin','Zai'], ex:'ص dibaca "Shad", salah satu huruf isti\'la.'},
    {q:'Huruf apa ini? → ع', a:3, opts:['Ain','Ghain','Ha','Kha'], ex:"ع adalah huruf 'Ain."},
    {q:'Huruf apa ini? → خ', a:1, opts:['Kaf','Kha','Ha','Ghain'], ex:'خ adalah huruf Kha.'},
  ],
  2: [
    {q:'Harakat yang dibaca "a" pendek adalah...', a:0, opts:['Fathah','Kasrah','Dhammah','Sukun'], ex:'Fathah (بَ) dibaca "a" pendek.'},
    {q:'Tanda baca tanwin yang menghasilkan bunyi "un" adalah...', a:2, opts:['Fathahtain','Kasrahtain','Dhammahtain','Sukun'], ex:'Dhammahtain (بٌ) dibaca "un".'},
    {q:'Huruf yang diberi sukun berarti...', a:3, opts:['Dibaca panjang','Dibaca dobel','Dibaca "a"','Tidak berbunyi vokal'], ex:'Sukun menandakan huruf mati (tidak ada vokal).'},
    {q:'Tasydid berarti huruf dibaca...', a:1, opts:['Panjang 2x','Dobel/berat','Dengan dengung','Berhenti'], ex:'Tasydid membuat huruf dibaca dobel atau berat.'},
    {q:'Harakat berupa garis miring di bawah huruf adalah...', a:0, opts:['Kasrah','Fathah','Dhammah','Sukun'], ex:'Kasrah (بِ) berupa garis miring di bawah, dibaca "i".'},
  ],
  3: [
    {q:'Huruf yang keluar dari tenggorokan bawah adalah...', a:1, opts:['ق dan ك','ء dan ه','ع dan ح','غ dan خ'], ex:'Hamzah (ء) dan Ha (ه) makhrajnya dari tenggorokan bawah.'},
    {q:'Makhraj "Al-Syafatain" artinya...', a:2, opts:['Tenggorokan','Lidah','Bibir','Hidung'], ex:'Al-Syafatain artinya dua bibir. Huruf م، ب، و, ف keluarnya dari bibir.'},
    {q:'Huruf Dhad (ض) keluarnya dari...', a:0, opts:['Sisi lidah','Tengah lidah','Ujung lidah','Tenggorokan'], ex:'Dhad makhrajnya dari sisi lidah (kiri/kanan) yang menyentuh gigi geraham atas.'},
    {q:'Bunyi ghunnah (dengung) keluar dari...', a:3, opts:['Mulut','Tenggorokan','Bibir','Hidung'], ex:'Ghunnah keluar dari pangkal hidung (al-khaisyum).'},
    {q:'Huruf Fa (ف) makhrajnya dari...', a:1, opts:['Bibir atas & bawah','Gigi atas & bibir bawah','Tengah lidah','Tenggorokan'], ex:'Fa makhrajnya dari gigi atas yang menyentuh bibir bawah bagian dalam.'},
  ],
  4: [
    {q:'Nun sukun bertemu huruf ء, maka hukumnya...', a:0, opts:['Izhar','Idgham','Iqlab','Ikhfa'], ex:'ء termasuk huruf Izhar Halqi, sehingga nun dibaca jelas.'},
    {q:'Tanwin bertemu huruf ب, maka hukumnya...', a:2, opts:['Izhar','Idgham Bighunnah','Iqlab','Ikhfa'], ex:'ب adalah satu-satunya huruf Iqlab. Nun berubah menjadi Mim.'},
    {q:'Nun sukun bertemu huruf ن di kata berbeda, hukumnya...', a:1, opts:['Izhar','Idgham Bighunnah','Iqlab','Ikhfa'], ex:'Nun (ن) termasuk huruf Idgham Bighunnah — dibaca dengung 2 harakat.'},
    {q:'Huruf Ikhfa Haqiqi berjumlah...', a:2, opts:['6','12','15','18'], ex:'Huruf Ikhfa Haqiqi berjumlah 15 huruf.'},
    {q:'Idgham Bilaghunnah artinya...', a:3, opts:['Dengung dua huruf','Jelas tanpa dengung','Samar dengan dengung','Masuk tanpa dengung'], ex:'Bilaghunnah = tanpa ghunnah. Nun masuk ke huruf berikutnya tanpa dengung.'},
  ],
  5: [
    {q:'Mim sukun bertemu huruf ب, hukumnya...', a:0, opts:['Ikhfa Syafawi','Idgham Mimy','Izhar Syafawi','Izhar Halqi'], ex:'Mim + Ba = Ikhfa Syafawi. Disebut syafawi karena keluar dari bibir (syafah).'},
    {q:'Mim sukun bertemu huruf م, hukumnya...', a:1, opts:['Ikhfa Syafawi','Idgham Mimy','Izhar Syafawi','Iqlab'], ex:'Mim + Mim = Idgham Mimy (atau Mutamasilain). Dibaca dobel dengan dengung.'},
    {q:'Mim sukun bertemu huruf ك, hukumnya...', a:2, opts:['Ikhfa Syafawi','Idgham Mimy','Izhar Syafawi','Ikhfa Haqiqi'], ex:'Kaf bukan ب atau م, maka hukumnya Izhar Syafawi — mim dibaca jelas.'},
    {q:'Pada Ikhfa Syafawi, bibir harus dalam posisi...', a:1, opts:['Terbuka','Tertutup rapat','Setengah terbuka','Bebas'], ex:'Pada Ikhfa Syafawi, kedua bibir menutup sambil mendengung 2 harakat.'},
  ],
  6: [
    {q:"Mad Tabi'i dibaca sepanjang...", a:0, opts:['2 harakat','4 harakat','5 harakat','6 harakat'], ex:"Mad Tabi'i (asli) dibaca 2 harakat atau 1 alif."},
    {q:'Mad Wajib Muttasil dibaca...', a:2, opts:['2 harakat','4 harakat','5-6 harakat','3 harakat'], ex:'Mad Wajib Muttasil wajib 5-6 harakat karena huruf mad bertemu hamzah dalam satu kata.'},
    {q:"Apa yang dimaksud Mad 'Arid Lis-Sukun?", a:1, opts:['Mad sebelum hamzah','Mad sebelum huruf akhir ayat yang diwaqaf','Mad dalam satu kata','Mad di awal surah'], ex:"Mad 'Arid dibaca 2, 4, atau 6 harakat saat berhenti (waqaf) di akhir ayat."},
    {q:'Huruf mad ada tiga, yaitu...', a:3, opts:['ا ب ت','ن م و','ق ب ج','ا و ي'], ex:'Huruf mad adalah alif (ا), waw (و), ya (ي).'},
  ],
  7: [
    {q:'Huruf Qalqalah ada 5, yaitu...', a:2, opts:['ب ت ث ج ح','ق ك غ ج ب','ق ب ج د ط','ب ج د ذ ز'], ex:'Huruf Qalqalah: ق ب ج د ط — disingkat "qutbu jaddin".'},
    {q:'Qalqalah Kubra terjadi ketika huruf qalqalah...', a:0, opts:['Di akhir kata/ayat saat waqaf','Di tengah kata','Bertasydid di tengah','Setelah mad'], ex:'Qalqalah Kubra (besar) terjadi saat waqaf di akhir kata/ayat — pantulan lebih kuat.'},
    {q:'Tanda waqaf لا dalam mushaf berarti...', a:1, opts:['Boleh berhenti','Tidak boleh berhenti','Lebih baik berhenti','Wajib berhenti'], ex:'Tanda لا artinya tidak boleh berhenti (waqaf mamnu\'). Harus terus membaca.'},
    {q:'Tanda waqaf ط berarti...', a:2, opts:['Boleh berhenti','Tidak boleh berhenti','Wajib berhenti','Lebih baik terus'], ex:"Tanda ط (waqaf mutlaq) artinya wajib berhenti — berhenti adalah yang lebih sempurna."},
  ],
};

// ═══════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════
let currentBab   = 1;
let babScores    = {}; // { babId: score 0-100 }
let quizState    = { active: false, qIdx: 0, answered: false, score: 0 };

// ═══════════════════════════════════════════════════════════════
// RENDER SIDEBAR
// ═══════════════════════════════════════════════════════════════
function renderSidebar() {
  const done = Object.values(babScores).filter(v => v >= 70).length;
  const pct  = Math.round((done / KURIKULUM.length) * 100);
  document.getElementById('overallPct').textContent = pct + '%';
  document.getElementById('overallBar').style.width  = pct + '%';

  const babItemsHtml = KURIKULUM.map(b => {
    const sc = babScores[b.id];
    let scoreHtml = '';
    if (sc !== undefined) {
      const cls = sc >= 70 ? 'score-done' : sc >= 40 ? 'score-mid' : 'score-low';
      scoreHtml = `<span class="bab-score ${cls}">${sc}</span>`;
    }
    const done = sc !== undefined && sc >= 70;
    return `
    <div class="bab-item ${currentBab===b.id?'active':''} ${done?'done':''}" onclick="selectBab(${b.id})">
      <div class="bab-ico">${done ? '✅' : b.icon}</div>
      <div class="bab-info">
        <div class="bab-name">${b.title}</div>
        <div class="bab-sub">${b.subtitle}</div>
      </div>
      ${scoreHtml}
    </div>`;
  }).join('');

  document.getElementById('babList').innerHTML = babItemsHtml;
  // Also sync to mobile drawer
  const drawerList = document.getElementById('drawerBabList');
  if (drawerList) drawerList.innerHTML = babItemsHtml;
  // Update mobile indicator
  const curBab = KURIKULUM.find(b => b.id === currentBab);
  const ind = document.getElementById('mobBabIndicator');
  if (ind && curBab) ind.textContent = `— ${curBab.icon} ${curBab.title}`;
}

// ═══════════════════════════════════════════════════════════════
// SELECT BAB
// ═══════════════════════════════════════════════════════════════
function selectBab(id) {
  currentBab = id;
  quizState  = { active: false, qIdx: 0, answered: false, score: 0 };
  renderSidebar();
  renderContent();
  document.getElementById('mainContent').scrollTop = 0;
  closeDrawer(); // close mobile drawer after selection
}

// ═══════════════════════════════════════════════════════════════
// RENDER CONTENT
// ═══════════════════════════════════════════════════════════════
function renderContent() {
  const bab = KURIKULUM.find(b => b.id === currentBab);
  let html   = renderBabHeader(bab) + renderBabBody(bab) + renderQuiz(bab.id) + renderLessonNav();
  document.getElementById('mainContent').innerHTML = html;
  // Re-attach quiz interactions
  if (QUIZ[bab.id]) initQuizInteractions(bab.id);
}

function renderBabHeader(bab) {
  const sc = babScores[bab.id];
  const scHtml = sc !== undefined ? `<span style="margin-left:12px; padding:3px 10px; border-radius:8px; font-size:12px; background:rgba(201,162,39,0.1); color:#C9A227; border:1px solid rgba(201,162,39,0.2);">Skor terakhir: ${sc}/100</span>` : '';
  return `
  <div class="bab-header">
    <div class="bab-badge">${bab.icon} Bab ${bab.id} dari ${KURIKULUM.length}${scHtml}</div>
    <div class="bab-title">${bab.title}</div>
    <p class="bab-desc">${bab.desc}</p>
  </div>`;
}

function renderBabBody(bab) {
  switch(bab.content) {
    case 'huruf':   return renderHuruf();
    case 'harakat': return renderHarakat();
    case 'makhraj': return renderMakhraj();
    case 'nun':     return renderHukumNun();
    case 'mim':     return renderHukumMim();
    case 'mad':     return renderMad();
    case 'waqaf':   return renderWaqaf();
    default: return '';
  }
}

// ── HURUF ─────────────────────────────────────────────────────
function renderHuruf() {
  const grid = HURUF.map(h => `
    <div class="huruf-cell" onclick="selectHuruf(this,'${h.arab}','${h.name}','${h.latin}')">
      <div class="h-arab">${h.arab}</div>
      <div class="h-name">${h.name}</div>
      <div class="h-latin">${h.latin}</div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">28 Huruf Hijaiyah</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:16px;line-height:1.7;">Ketuk setiap huruf untuk melihat detailnya. Huruf-huruf ini adalah fondasi membaca Al-Qur'an.</p>
      <div class="huruf-grid">${grid}</div>
    </div>
    <div id="huruf-detail" style="display:none;margin-top:12px;" class="lesson-card highlight">
      <div id="huruf-detail-content"></div>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Bentuk Huruf dalam Kata</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);line-height:1.7;margin-bottom:16px;">Beberapa huruf memiliki bentuk berbeda tergantung posisinya dalam kata: di awal, di tengah, di akhir, atau berdiri sendiri.</p>
      <div style="overflow-x:auto;">
        <table class="tajwid-table">
          <tr><th>Huruf</th><th>Berdiri Sendiri</th><th>Awal Kata</th><th>Tengah Kata</th><th>Akhir Kata</th></tr>
          ${[['Ba','ب','بـ','ـبـ','ـب'],['Nun','ن','نـ','ـنـ','ـن'],['Ain',"ع","عـ","ـعـ","ـع"],['Mim','م','مـ','ـمـ','ـم'],['Ha','ه','هـ','ـهـ','ـه']].map(r=>`<tr><td>${r[0]}</td>${r.slice(1).map(c=>`<td style="font-family:'Amiri',serif;font-size:24px;direction:rtl;color:var(--gold);text-align:center;">${c}</td>`).join('')}</tr>`).join('')}
        </table>
      </div>
    </div>
  </div>`;
}

function selectHuruf(el, arab, name, latin) {
  document.querySelectorAll('.huruf-cell').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  const detail = document.getElementById('huruf-detail');
  const content = document.getElementById('huruf-detail-content');
  detail.style.display = 'block';
  content.innerHTML = `
    <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
      <div style="font-family:'Amiri',serif;font-size:80px;color:var(--gold);direction:rtl;line-height:1;">${arab}</div>
      <div>
        <div style="font-size:22px;font-weight:700;color:var(--cream);margin-bottom:4px;">${name}</div>
        <div style="font-size:14px;color:rgba(253,246,232,0.45);">Transliterasi: <strong style="color:var(--gold);">${latin}</strong></div>
        <div style="font-size:13px;color:rgba(253,246,232,0.4);margin-top:8px;">Ketuk huruf lain untuk membandingkan</div>
      </div>
    </div>`;
  detail.scrollIntoView({behavior:'smooth', block:'nearest'});
}

// ── HARAKAT ───────────────────────────────────────────────────
function renderHarakat() {
  const grid = HARAKAT.map(h => `
    <div class="harakat-card" onclick="showHarakatDetail('${h.name}','${h.read}','${h.desc}')">
      <div class="hr-symbol">${h.symbol}</div>
      <div class="hr-name">${h.name}</div>
      <div class="hr-read">Dibaca: <strong style="color:var(--gold);">${h.read}</strong></div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Tanda Baca (Harakat)</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:16px;line-height:1.7;">Harakat adalah tanda baca yang menentukan bunyi vokal setiap huruf. Ketuk untuk detail.</p>
      <div class="harakat-grid">${grid}</div>
    </div>
    <div id="harakat-detail" style="display:none;margin-top:12px;" class="lesson-card highlight">
      <div id="harakat-content"></div>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Contoh Penerapan</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:16px;line-height:1.7;">Perhatikan bagaimana harakat mengubah bunyi huruf yang sama:</p>
      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        ${[['بَ','ba'],['بِ','bi'],['بُ','bu'],['بْ','b (mati)'],['بّ','bb']].map(([s,r])=>`
        <div style="background:rgba(13,46,46,0.8);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px 20px;text-align:center;">
          <div style="font-family:'Amiri',serif;font-size:40px;color:var(--gold);direction:rtl;">${s}</div>
          <div style="font-size:12px;color:rgba(253,246,232,0.5);margin-top:6px;">${r}</div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

function showHarakatDetail(name, read, desc) {
  const el = document.getElementById('harakat-detail');
  document.getElementById('harakat-content').innerHTML = `
    <strong style="font-size:16px;color:var(--gold);">${name}</strong>
    <p style="font-size:13px;color:rgba(253,246,232,0.65);margin-top:8px;line-height:1.7;">${desc}</p>
    <p style="font-size:13px;margin-top:6px;">Cara baca: <strong style="color:var(--gold);">"${read}"</strong></p>`;
  el.style.display = 'block';
  el.scrollIntoView({behavior:'smooth',block:'nearest'});
}

// ── MAKHRAJ ───────────────────────────────────────────────────
function renderMakhraj() {
  const groups = MAKHRAJ.map(g => `
    <div class="makhraj-group">
      <div class="mk-group-title">${g.group}</div>
      <div class="mk-items">
        ${g.items.map(item=>`
        <div class="mk-item">
          <div class="mk-arab">${item.arab}</div>
          <div class="mk-info">
            ${item.info?`<strong>${item.info}</strong>`:''}
            ${item.desc}
          </div>
        </div>`).join('')}
      </div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Peta Makhraj Huruf</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:20px;line-height:1.7;">Makhraj (مَخْرَج) adalah tempat keluarnya suara huruf. Bacaan yang benar bergantung pada ketepatan makhraj.</p>
      ${groups}
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Ringkasan 5 Makhraj Utama</div>
    <div class="lesson-card">
      <table class="tajwid-table">
        <tr><th>No</th><th>Nama Makhraj</th><th>Arti</th><th>Huruf</th></tr>
        <tr><td>1</td><td>Al-Jauf</td><td>Rongga mulut</td><td style="font-family:'Amiri',serif;font-size:18px;direction:rtl;">ا و ي</td></tr>
        <tr><td>2</td><td>Al-Halq</td><td>Tenggorokan</td><td style="font-family:'Amiri',serif;font-size:18px;direction:rtl;">ء ه ع ح غ خ</td></tr>
        <tr><td>3</td><td>Al-Lisan</td><td>Lidah</td><td style="font-family:'Amiri',serif;font-size:16px;direction:rtl;">ق ك ج ش ي ض ل ن ر ط د ت ص س ز ظ ذ ث</td></tr>
        <tr><td>4</td><td>Al-Syafatain</td><td>Dua bibir</td><td style="font-family:'Amiri',serif;font-size:18px;direction:rtl;">ف و م ب</td></tr>
        <tr><td>5</td><td>Al-Khaisyum</td><td>Hidung</td><td style="font-family:'Amiri',serif;font-size:18px;direction:rtl;">غُنَّة</td></tr>
      </table>
    </div>
  </div>`;
}

// ── HUKUM NUN ─────────────────────────────────────────────────
function renderHukumNun() {
  const cards = HUKUM_NUN.map(h => `
    <div class="hukum-card" style="background:${h.bg};border-color:${h.border};">
      <div class="hk-head">
        <div class="hk-num" style="background:${h.bg};color:${h.color};border:1px solid ${h.border};">✦</div>
        <div class="hk-name" style="color:${h.color};">${h.name}</div>
      </div>
      <div class="hk-huruf">${h.huruf}</div>
      <p class="hk-desc"><strong>Syarat:</strong> ${h.syarat}</p>
      <p class="hk-desc" style="margin-top:4px;"><strong>Cara baca:</strong> ${h.cara}</p>
      <div class="hk-example" style="border:1px solid ${h.border};">
        <div style="font-size:22px;color:${h.color};">${h.contoh}</div>
        <div style="font-size:11px;color:rgba(253,246,232,0.45);margin-top:4px;font-family:'DM Sans',sans-serif;">${h.arti}</div>
      </div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Hukum Nun Sukun & Tanwin (5 Hukum)</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:20px;line-height:1.7;">
        Nun sukun (نْ) dan tanwin (ً ٍ ٌ) memiliki 5 hukum bacaan tergantung huruf yang mengikutinya.
      </p>
      <div class="hukum-grid">${cards}</div>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Cara Mudah Mengingat</div>
    <div class="lesson-card">
      <table class="tajwid-table">
        <tr><th>Hukum</th><th>Huruf</th><th>Jumlah</th><th>Ciri Khas</th></tr>
        ${HUKUM_NUN.map(h=>`<tr>
          <td><span class="rule-badge" style="background:${h.bg};color:${h.color};border:1px solid ${h.border};">${h.name.split(' ')[0]} ${h.name.split(' ')[1]||''}</span></td>
          <td style="font-family:'Amiri',serif;font-size:16px;direction:rtl;">${h.huruf}</td>
          <td>${h.huruf.split(' ').length} huruf</td>
          <td style="font-size:12px;">${h.cara.slice(0,50)}…</td>
        </tr>`).join('')}
      </table>
    </div>
  </div>`;
}

// ── HUKUM MIM ─────────────────────────────────────────────────
function renderHukumMim() {
  const cards = HUKUM_MIM.map(h => `
    <div class="hukum-card" style="background:${h.bg};border-color:${h.border};">
      <div class="hk-head">
        <div class="hk-num" style="background:${h.bg};color:${h.color};border:1px solid ${h.border};">م</div>
        <div class="hk-name" style="color:${h.color};">${h.name}</div>
      </div>
      <div class="hk-huruf">${h.huruf}</div>
      <p class="hk-desc"><strong>Syarat:</strong> ${h.syarat}</p>
      <p class="hk-desc" style="margin-top:4px;"><strong>Cara baca:</strong> ${h.cara}</p>
      <div class="hk-example" style="border:1px solid ${h.border};">
        <div style="font-size:20px;color:${h.color};">${h.contoh}</div>
        <div style="font-size:11px;color:rgba(253,246,232,0.45);margin-top:4px;font-family:'DM Sans',sans-serif;">${h.arti}</div>
      </div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Hukum Mim Sukun (3 Hukum)</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:20px;line-height:1.7;">
        Mim sukun (مْ) memiliki 3 hukum bacaan. Ketiga hukum ini disebut "syafawi" karena berkaitan dengan bibir (syafah = bibir).
      </p>
      <div class="hukum-grid">${cards}</div>
    </div>
  </div>`;
}

// ── MAD ───────────────────────────────────────────────────────
function renderMad() {
  const rows = JENIS_MAD.map(m => `
    <div class="mad-row">
      <div>
        <div class="mad-name">${m.name}</div>
      </div>
      <div class="mad-desc">${m.desc}</div>
      <div class="mad-harakah">${m.harakah}<br><span style="font-size:10px;color:rgba(253,246,232,0.4);font-weight:400;">harakat</span></div>
    </div>`).join('');
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Pengertian Mad</div>
    <div class="lesson-card">
      <p style="font-size:14px;color:rgba(253,246,232,0.65);line-height:1.8;margin-bottom:16px;">
        <strong style="color:var(--cream);">Mad (مَدّ)</strong> artinya memanjangkan. Dalam ilmu tajwid, mad adalah memanjangkan suara pada huruf mad (ا و ي) sesuai dengan ketentuan yang berlaku.
      </p>
      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px;">
        ${['اَ→آ','وُ→وْو','يِ→يِي'].map(ex=>`
        <div style="background:rgba(201,162,39,0.08);border:1px solid rgba(201,162,39,0.2);border-radius:10px;padding:12px 16px;font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);">${ex}</div>`).join('')}
      </div>
      <p style="font-size:12px;color:rgba(253,246,232,0.4);line-height:1.7;">1 harakat ≈ 1 ketukan jari. Mad dasar = 2 harakat.</p>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Jenis-jenis Mad</div>
    <div class="lesson-card">
      ${rows}
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Diagram Hubungan Mad</div>
    <div class="lesson-card">
      <div style="display:grid;grid-template-columns:auto auto;gap:12px;max-width:500px;">
        <div style="background:rgba(201,162,39,0.08);border:1px solid rgba(201,162,39,0.2);border-radius:12px;padding:16px;text-align:center;">
          <div style="font-size:13px;font-weight:700;color:#C9A227;margin-bottom:8px;">Mad Asli (Tabi'i)</div>
          <div style="font-size:12px;color:rgba(253,246,232,0.5);">Dasar semua mad</div>
          <div style="font-size:20px;font-weight:800;color:#C9A227;margin-top:8px;">2 harakat</div>
        </div>
        <div style="background:rgba(93,173,226,0.08);border:1px solid rgba(93,173,226,0.2);border-radius:12px;padding:16px;text-align:center;">
          <div style="font-size:13px;font-weight:700;color:#5DADE2;margin-bottom:8px;">Mad Far'i (Cabang)</div>
          <div style="font-size:12px;color:rgba(253,246,232,0.5);">Turunan mad asli</div>
          <div style="font-size:20px;font-weight:800;color:#5DADE2;margin-top:8px;">2–6 harakat</div>
        </div>
      </div>
    </div>
  </div>`;
}

// ── WAQAF & QALQALAH ──────────────────────────────────────────
function renderWaqaf() {
  return `
  <div class="lesson-section">
    <div class="lesson-section-title">Qalqalah — Memantul</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:16px;line-height:1.7;">
        <strong style="color:var(--cream);">Qalqalah</strong> artinya guncangan atau pantulan suara. Terjadi pada 5 huruf qalqalah ketika sukun atau diwaqafkan.
      </p>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
        ${['ق','ب','ج','د','ط'].map(h=>`
        <div style="background:rgba(195,155,211,0.1);border:2px solid rgba(195,155,211,0.35);border-radius:12px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-family:'Amiri',serif;font-size:36px;color:#C39BD3;">${h}</div>`).join('')}
      </div>
      <p style="font-size:12px;color:rgba(253,246,232,0.5);margin-bottom:16px;">Disingkat: <strong style="color:#C39BD3;">قُطْبُ جَدٍّ</strong> (qutbu jaddin)</p>
      <table class="tajwid-table">
        <tr><th>Tingkatan</th><th>Kondisi</th><th>Kekuatan</th></tr>
        <tr><td><strong style="color:#C39BD3;">Qalqalah Sughra</strong></td><td>Huruf qalqalah sukun di tengah kata</td><td>Lemah</td></tr>
        <tr><td><strong style="color:#C39BD3;">Qalqalah Wusta</strong></td><td>Huruf qalqalah sukun di akhir kata (bukan berwaqaf pada akhir ayat)</td><td>Sedang</td></tr>
        <tr><td><strong style="color:#C39BD3;">Qalqalah Kubra</strong></td><td>Huruf qalqalah di akhir kata/ayat saat waqaf</td><td>Kuat</td></tr>
      </table>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Waqaf — Tanda Berhenti</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);margin-bottom:16px;line-height:1.7;">
        <strong style="color:var(--cream);">Waqaf (وَقْف)</strong> adalah berhenti sejenak pada akhir kata. Tanda waqaf di mushaf Al-Qur'an:
      </p>
      <table class="tajwid-table">
        <tr><th>Tanda</th><th>Nama</th><th>Arti & Hukum</th></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);text-align:center;">م</td><td>Waqaf Lazim</td><td>Wajib berhenti. Jika tidak berhenti, makna berubah.</td></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);text-align:center;">ط</td><td>Waqaf Mutlaq</td><td>Berhenti adalah yang lebih sempurna.</td></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);text-align:center;">ج</td><td>Waqaf Jaiz</td><td>Boleh berhenti, boleh terus. Keduanya diizinkan.</td></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);text-align:center;">ز</td><td>Waqaf Mujawwaz</td><td>Lebih baik terus, boleh berhenti.</td></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:#E74C3C;text-align:center;">لا</td><td>Waqaf Mamnu'</td><td style="color:#E74C3C;font-weight:600;">Dilarang berhenti di sini karena merusak makna.</td></tr>
        <tr><td style="font-family:'Amiri',serif;font-size:22px;direction:rtl;color:var(--gold);text-align:center;">∴</td><td>Mu'anaqah</td><td>Ada dua tempat waqaf berpasangan, boleh berhenti di salah satunya saja.</td></tr>
      </table>
    </div>
  </div>
  <div class="lesson-section">
    <div class="lesson-section-title">Ibtida — Memulai Kembali</div>
    <div class="lesson-card">
      <p style="font-size:13px;color:rgba(253,246,232,0.55);line-height:1.7;margin-bottom:12px;">
        <strong style="color:var(--cream);">Ibtida (ابتداء)</strong> adalah memulai kembali bacaan setelah berhenti. Ibtida yang baik:
      </p>
      <ul style="font-size:13px;color:rgba(253,246,232,0.55);line-height:1.8;padding-left:20px;">
        <li>Mulai dari awal ayat atau awal kalimat yang sempurna</li>
        <li>Jangan memulai dari tengah kata atau kalimat yang merusak makna</li>
        <li>Ambil nafas yang cukup sebelum memulai kembali</li>
      </ul>
    </div>
  </div>`;
}

// ═══════════════════════════════════════════════════════════════
// QUIZ
// ═══════════════════════════════════════════════════════════════
function renderQuiz(babId) {
  const qs = QUIZ[babId];
  if (!qs) return '';
  const sc = babScores[babId];
  const scInfo = sc !== undefined ? `<span style="font-size:13px;color:rgba(253,246,232,0.45);">Skor sebelumnya: <strong style="color:${sc>=70?'#58D68D':'#E67E22'};">${sc}/100</strong></span>` : '';

  return `
  <div class="quiz-section" id="quizSection">
    <div class="quiz-title">📝 Quiz Bab ${babId} ${scInfo}</div>
    <div class="quiz-sub">${qs.length} soal pilihan ganda — Nilai lulus ≥ 70</div>
    <div class="quiz-progress">
      <div class="qp-bar"><div class="qp-fill" id="qpFill" style="width:0%"></div></div>
      <div class="qp-text" id="qpText">0 / ${qs.length}</div>
    </div>
    <div id="quizBody"></div>
  </div>`;
}

function initQuizInteractions(babId) {
  quizState = { active: true, qIdx: 0, answered: false, score: 0, babId };
  showQuestion(babId);
}

function showQuestion(babId) {
  const qs  = QUIZ[babId];
  const idx = quizState.qIdx;
  if (idx >= qs.length) { showQuizResult(babId); return; }
  const q = qs[idx];
  document.getElementById('qpFill').style.width = `${(idx/qs.length)*100}%`;
  document.getElementById('qpText').textContent = `${idx} / ${qs.length}`;

  const optsHtml = q.opts.map((o,i) => `
    <button class="q-opt" id="opt-${i}" onclick="answerQuiz(${i},${q.a},'${babId}','${q.ex.replace(/'/g,"\\'")}')">
      ${String.fromCharCode(65+i)}. ${o}
    </button>`).join('');

  document.getElementById('quizBody').innerHTML = `
    <div class="q-question">
      ${q.arab?`<span class="q-arab">${q.arab}</span>`:''}
      ${q.q}
    </div>
    <div class="q-opts">${optsHtml}</div>
    <div class="q-feedback" id="qFeedback"></div>
    <button class="btn-next" id="btnNext" onclick="nextQuestion(${babId})" disabled>Soal Berikutnya →</button>`;
}

function answerQuiz(chosen, correct, babId, explanation) {
  if (quizState.answered) return;
  quizState.answered = true;

  document.querySelectorAll('.q-opt').forEach((btn,i) => {
    btn.classList.add('disabled');
    if (i === correct) btn.classList.add('correct');
    else if (i === chosen && chosen !== correct) btn.classList.add('wrong');
  });

  const isCorrect = chosen === correct;
  if (isCorrect) quizState.score++;

  const fb = document.getElementById('qFeedback');
  fb.className = `q-feedback ${isCorrect?'fb-correct':'fb-wrong'}`;
  fb.style.display = 'block';
  fb.innerHTML = `${isCorrect?'✅ Benar!':'❌ Kurang tepat.'} ${explanation}`;

  const btnNext = document.getElementById('btnNext');
  btnNext.disabled = false;
  const qs = QUIZ[babId];
  if (quizState.qIdx >= qs.length - 1) btnNext.textContent = 'Lihat Hasil →';
  quizState.qIdx++;
  quizState.answered = false;
}

function nextQuestion(babId) {
  showQuestion(babId);
}

function showQuizResult(babId) {
  const qs    = QUIZ[babId];
  const score = Math.round((quizState.score / qs.length) * 100);
  babScores[babId] = score;
  saveBabScore(babId, score);
  renderSidebar();

  document.getElementById('qpFill').style.width = '100%';
  document.getElementById('qpText').textContent = `${qs.length} / ${qs.length}`;

  const color = score >= 70 ? '#58D68D' : score >= 40 ? '#E67E22' : '#E74C3C';
  const msg   = score >= 70 ? '🎉 Selamat! Anda lulus bab ini.' : score >= 40 ? '💪 Hampir! Coba lagi untuk mendapat nilai lebih baik.' : '📖 Pelajari kembali materi bab ini ya.';

  document.getElementById('quizBody').innerHTML = `
    <div class="quiz-result">
      <div class="qr-score" style="color:${color};">${score}<span style="font-size:28px;">/100</span></div>
      <div class="qr-msg">${msg}</div>
      <div style="font-size:13px;color:rgba(253,246,232,0.4);margin-bottom:24px;">Benar: ${quizState.score} dari ${qs.length} soal</div>
      <button class="btn-retry" onclick="retryQuiz(${babId})">🔄 Ulangi Quiz</button>
      ${currentBab < KURIKULUM.length ? `<button class="btn-nxt" onclick="selectBab(${currentBab+1})">Bab Berikutnya →</button>` : ''}
    </div>`;
}

function retryQuiz(babId) {
  quizState = { active: true, qIdx: 0, answered: false, score: 0, babId };
  showQuestion(babId);
}

// ═══════════════════════════════════════════════════════════════
// LESSON NAV
// ═══════════════════════════════════════════════════════════════
function renderLessonNav() {
  const prev = currentBab > 1;
  const next = currentBab < KURIKULUM.length;
  return `
  <div class="lesson-nav">
    <button class="btn-prev" ${!prev?'style="opacity:.3;cursor:default"':''} onclick="${prev?`selectBab(${currentBab-1})`:''}">
      ← ${prev ? KURIKULUM[currentBab-2].title : 'Ini bab pertama'}
    </button>
    <div style="font-size:12px;color:rgba(253,246,232,0.3);">Bab ${currentBab} / ${KURIKULUM.length}</div>
    ${next ? `<button class="btn-nxt" onclick="selectBab(${currentBab+1})">
      ${KURIKULUM[currentBab].title} →
    </button>` : `<button class="btn-nxt" onclick="window.location.href='tartil-quran.html'" style="background:linear-gradient(135deg,#5DADE2,#2E86C1);">
      Mulai Tartil 🎙
    </button>`}
  </div>`;
}

// ═══════════════════════════════════════════════════════════════
// FIREBASE — SIMPAN & LOAD PROGRESS TAJWID
// ═══════════════════════════════════════════════════════════════
async function loadUserProgress(uid) {
  if (!window._fb) return;
  try {
    const { db, doc, getDoc } = window._fb;
    const snap = await getDoc(doc(db,'users',uid));
    if (snap.exists()) {
      const data = snap.data();
      babScores = data.tajwidProgress || {};
    }
    // Show user in nav
    const user = window._currentUser;
    if (user) {
      document.getElementById('navUser').style.display = 'flex';
      document.getElementById('navAv').src  = user.photoURL || '';
      document.getElementById('navNm').textContent = (user.displayName||'').split(' ')[0];
    }
    renderSidebar();
    renderContent();
  } catch(e) { console.error(e); }
}

async function saveBabScore(babId, score) {
  // Track activity for Dashboard
  try {
    const today = new Date();
    const dk = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    const act = JSON.parse(localStorage.getItem('tai_activity') || '{}');
    if (!act[dk]) act[dk] = {};
    act[dk].bab = (act[dk].bab || 0) + 1;
    localStorage.setItem('tai_activity', JSON.stringify(act));
    // Also save tajwid progress for badges
    localStorage.setItem('tai_tajwid', JSON.stringify(babScores));
  } catch(e) {}

  const user = window._currentUser;
  if (!user || !window._fb) return;
  try {
    const { db, doc, setDoc, serverTimestamp } = window._fb;
    await setDoc(doc(db,'users',user.uid), {
      tajwidProgress: babScores,
      lastTajwidBab:  babId,
      updatedAt: serverTimestamp()
    }, { merge: true });
  } catch(e) { console.error('Save score:', e); }
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
renderSidebar();
renderContent();


// Jika tidak ada Firebase, tetap tampilkan dengan data lokal
window.addEventListener('load', () => {
  if (!window._fb) {
    renderSidebar();
    renderContent();
  }
});

// Mobile drawer functions
function openDrawer() {
  document.getElementById('babDrawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeDrawer() {
  document.getElementById('babDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.body.style.overflow = '';
}



function checkBadges() { if (typeof renderBadges === 'function') renderBadges(); }
/* ════════════════════════════════════════════
   SPA CONTROLLER
   ════════════════════════════════════════════ */

/* ════════════════════════════════════════════
   SPA CONTROLLER
   ════════════════════════════════════════════ */
var _spaInited = {};
var _spaCurrentTab = 'tartil';

function spaSwitch(tab) {
  if (_spaCurrentTab === tab) return;
  _spaCurrentTab = tab;

  // Update tabs
  document.querySelectorAll('.spa-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
  
  var tabEl = document.getElementById('tab-' + tab);
  if (tabEl) tabEl.classList.add('active');
  
  var btnEl = document.getElementById('bnav-' + tab);
  if (btnEl) btnEl.classList.add('active');

  // Init on first open
  if (!_spaInited[tab]) {
    _spaInited[tab] = true;
    if (tab === 'panduan') {
      // Init tajwid curriculum
      try { renderSidebar(); renderContent(); } catch(e) { console.warn('panduan init:', e); }
    }
    if (tab === 'progress') {
      // Init dashboard
      try { initDashboard(); } catch(e) { console.warn('progress init:', e); }
    }
    if (tab === 'ibadah') {
      // Init ibadah tab
      try { renderIbadahTab(); } catch(e) { console.warn('ibadah init:', e); }
    }
  }
}

function showApp(user) {
  // Sembunyikan login, tampilkan SPA
  var ls = document.getElementById('loginScreen');
  if (ls) ls.style.display = 'none';
  var spa = document.getElementById('spa-root');
  if (spa) spa.style.display = 'flex';

  if (user) {
    var ui = document.getElementById('userInfo');
    if (ui) {
      ui.style.display = 'flex';
      var av = document.getElementById('userAvatar');
      var nm = document.getElementById('userName');
      if (av) av.src = user.photoURL || 'https://api.dicebear.com/7.x/initials/svg?seed=' + encodeURIComponent(user.displayName || 'U');
      if (nm) nm.textContent = (user.displayName || user.email || 'User').split(' ')[0];
    }
    // Juga update nav di tajwid/dash tabs
    ['navAv','navNm'].forEach(function(id) {
      var el = document.getElementById(id);
      if (!el) return;
      if (id === 'navAv') el.src = user.photoURL || '';
      if (id === 'navNm') el.textContent = (user.displayName || '').split(' ')[0];
    });
  }

  if (!window._appInited) {
    window._appInited = true;
    try { init(); } catch(e) { console.warn('tartil init:', e); }
    try { initShalat(); } catch(e) { console.warn('shalat init:', e); }
  }
}

// Ibadah tab content - render shalat + kiblat info
function renderIbadahTab() {
  var c = document.getElementById('ibadah-content');
  if (!c) return;
  c.innerHTML = `
    <div style="background:rgba(13,43,43,0.6);border:1px solid rgba(201,162,39,0.15);border-radius:16px;padding:20px;margin-bottom:16px;">
      <div style="font-size:13px;color:rgba(253,246,232,0.5);margin-bottom:6px;">Waktu Shalat Berikutnya</div>
      <div style="font-size:28px;font-weight:700;color:#C9A227;" id="ib-next-name">—</div>
      <div style="font-size:18px;color:rgba(253,246,232,0.8);margin-top:4px;" id="ib-countdown">—</div>
      <div style="font-size:12px;color:rgba(253,246,232,0.4);margin-top:8px;" id="ib-city">📍 Jember</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;" id="ib-times"></div>
    <button onclick="openKiblat()" style="width:100%;padding:14px;background:linear-gradient(135deg,#C9A227,#8B6F15);border:none;border-radius:12px;color:white;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;">
      🧭 Tampilkan Arah Kiblat
    </button>
    <button onclick="bukaModalLokasi()" style="width:100%;padding:12px;margin-top:8px;background:rgba(201,162,39,0.1);border:1px solid rgba(201,162,39,0.25);border-radius:12px;color:rgba(253,246,232,0.7);font-size:13px;cursor:pointer;font-family:inherit;">
      📍 Ganti Kota
    </button>
  `;
  // Sync data dari shalat yang sudah di-fetch
  syncIbadahTab();
}

function syncIbadahTab() {
  // Sync nama shalat dan countdown
  var nn = document.getElementById('shalatNextName');
  var cd = document.getElementById('shalatCountdown');
  var sc = document.getElementById('shalatCity');
  if (nn) { var ibn = document.getElementById('ib-next-name'); if (ibn) ibn.textContent = nn.textContent; }
  if (cd) { var ibc = document.getElementById('ib-countdown');  if (ibc) ibc.textContent = cd.textContent; }
  if (sc) { var ibs = document.getElementById('ib-city'); if (ibs) ibs.textContent = sc.textContent; }

  // Sync jadwal shalat
  var st = document.getElementById('shalatTimes');
  var it = document.getElementById('ib-times');
  if (st && it) {
    it.innerHTML = st.innerHTML;
  }
  // Repeat sync tiap 10 detik jika tab aktif
  if (_spaCurrentTab === 'ibadah') {
    setTimeout(syncIbadahTab, 10000);
  }
}

// Dashboard init function wrapper
function initDashboard() {
  // Fungsi dari dash_js
  if (typeof buildDashboard === 'function') buildDashboard();
  else if (typeof renderLeaderboard === 'function') renderLeaderboard();
  if (typeof calcStreak === 'function') calcStreak();
  if (typeof checkBadges === 'function') checkBadges();
}

</script>

</body>
</html>
